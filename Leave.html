<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>UDM ESG｜請假 / 加班 / 出差申請</title>

<style>
body{background:#3f3f3f;font-family:system-ui}
.card{
  width:380px;margin:30px auto;background:#f4f4f4;
  padding:16px;border-radius:10px
}
input,select,button,textarea,label{
  width:100%;padding:8px;margin:6px 0;box-sizing:border-box
}
button{cursor:pointer;border-radius:6px;border:0}
.primary{background:#3498db;color:#fff}
.danger{background:#c0392b;color:#fff}
.secondary{background:#555;color:#fff}
.small{font-size:12px;opacity:.8}
hr{margin:12px 0}

.list{
  margin-top:14px;background:#fff;border-radius:8px;
  max-height:260px;overflow:auto
}
.item{
  border-bottom:1px solid #ddd;padding:8px
}
.badge{
  display:inline-block;padding:2px 6px;border-radius:4px;
  font-size:12px;margin-right:4px
}
.pending{background:#fff3cd}
.approved{background:#d4edda}
.withdrawn{background:#e0e0e0}
</style>
</head>

<body>

<div class="card">
  <h3>請假 / 加班 / 出差 / 忘記打卡</h3>

  <button class="secondary" onclick="goHome()">← 回打卡首頁</button>

  <input id="name" placeholder="姓名">

  <select id="type" onchange="onTypeChange()">
    <option value="">請選擇類型</option>
    <option>婚假</option>
    <option>喪假</option>
    <option>育兒假</option>
    <option>生產假</option>
    <option>病假</option>
    <option>特休</option>
    <option>加班</option>
    <option>出差</option>
    <option>忘記打卡</option>
  </select>

  <label>開始日期</label>
  <input type="date" id="sd">

  <label>開始時間</label>
  <input type="time" id="st" value="09:00">

  <label>結束日期</label>
  <input type="date" id="ed">

  <label>結束時間</label>
  <input type="time" id="et" value="18:00">

  <textarea id="reason" placeholder="補充說明（選填）"></textarea>

  <button class="primary" onclick="submit()">送出申請</button>

  <hr>
  <h4>我的申請紀錄</h4>
  <div class="list" id="list"></div>
</div>

<script>
/* =====================
   API
===================== */
const API_LEAVE    = "https://punch-api.jackey1688.workers.dev/api/leave";
const API_WITHDRAW = "https://punch-api.jackey1688.workers.dev/api/leave/withdraw";

/* =====================
   Utils
===================== */
function qs(id){ return document.getElementById(id); }
function esc(s){ return (s||"").replace(/\n/g,"<br>"); }
function goHome(){ location.href="https://sethjesus.github.io/punch/"; }

/* ===== 狀態唯一判斷 ===== */
function getStatus(l){
  if(l.withdrawn === 1) return "withdrawn";
  if(l.approved  === 1) return "approved";
  return "pending";
}

/* =====================
   忘記打卡邏輯
===================== */
function onTypeChange(){
  const type = qs("type").value;

  if(type === "忘記打卡"){
    const today = new Date().toISOString().slice(0,10);
    qs("sd").value = today;
    qs("ed").value = today;
    qs("st").value = "09:00";
    qs("et").value = "18:00";
    qs("reason").value = "";
  }
}

/* =====================
   Load list
===================== */
async function loadList(){
  const name = qs("name").value.trim();
  if(!name) return;

  const all = await (await fetch(API_LEAVE)).json();
  const mine = all.filter(l => l.name === name);

  const box = qs("list");
  box.innerHTML = "";

  if(mine.length === 0){
    box.innerHTML = `<div class="item small">尚無申請紀錄</div>`;
    return;
  }

  mine.sort((a,b)=>b.id-a.id).forEach(l=>{
    const status = getStatus(l);
    const statusText = {
      pending:"審核中",
      approved:"已核准",
      withdrawn:"已撤回"
    }[status];

    box.innerHTML += `
      <div class="item">
        <div>
          <span class="badge ${status}">${statusText}</span>
          <b>${l.type}</b>
        </div>
        <div class="small">${l.start_date} ~ ${l.end_date}</div>
        <div class="small">${esc(l.reason)}</div>
        ${
          status==="pending"
          ? `<button class="danger" onclick="withdraw(${l.id})">撤回</button>`
          : ``
        }
      </div>
    `;
  });
}

/* =====================
   Submit
===================== */
async function submit(){
  const name = qs("name").value.trim();
  const type = qs("type").value;
  const sd   = qs("sd").value;
  const st   = qs("st").value;
  const ed   = qs("ed").value;
  const et   = qs("et").value;
  const reason = qs("reason").value.trim();

  if(!name||!type||!sd||!st||!ed||!et){
    alert("請填寫完整資料"); return;
  }

  const detail =
`【${type}】
開始：${sd} ${st}
結束：${ed} ${et}
${reason}`;

  await fetch(API_LEAVE,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      name,
      type,
      start_date: sd,
      end_date: ed,
      reason: detail
    })
  });

  alert("申請已送出");
  loadList();
}

/* =====================
   Withdraw
===================== */
async function withdraw(id){
  if(!confirm("確定要撤回此申請？")) return;

  await fetch(API_WITHDRAW,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ id })
  });

  loadList();
}

/* =====================
   Auto reload
===================== */
qs("name").addEventListener("change", loadList);
</script>

</body>
</html>
