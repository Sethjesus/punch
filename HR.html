<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>HR æ‰“å¡å¾Œå°</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
body{font-family:sans-serif;background:#f5f6f8}
.card{background:#fff;padding:20px;border-radius:12px;max-width:1100px;margin:auto}
table{width:100%;border-collapse:collapse}
th,td{border-bottom:1px solid #ddd;padding:8px;text-align:center}
th{background:#f0f0f0}
.bad{color:red;font-weight:bold}
</style>
</head>

<body>
<div class="card">
<h2>ğŸ“‹ HR æ‰“å¡å¾Œå°</h2>

<button onclick="exportExcel()">â¬‡ åŒ¯å‡º Excel</button>
<select id="weekdayFilter" onchange="render()">
  <option value="">å…¨éƒ¨æ˜ŸæœŸ</option>
  <option value="å…­">å…­</option>
  <option value="æ—¥">æ—¥</option>
</select>

<table>
<thead>
<tr>
  <th>å·¥è™Ÿ</th><th>å§“å</th><th>å‹•ä½œ</th>
  <th>è·é›¢(m)</th><th>æ—¥æœŸ</th><th>æ˜ŸæœŸ</th><th>æ™‚é–“</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<p style="font-size:12px;color:#888">è³‡æ–™ä¾†æºï¼šCloudflare Workers KV</p>
</div>

<script>
const API = "https://punch-api.jackey1688.workers.dev/api/admin/attendance";
let RAW = [];

fetch(API).then(r=>r.json()).then(d=>{RAW=d;render();});

function weekday(d){
  return ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][new Date(d).getDay()];
}

function render(){
  const f = weekdayFilter.value;
  tbody.innerHTML = "";

  RAW.filter(r=>{
    if(!f) return true;
    const w = weekday(r.time);
    return f==="å…­"?w==="å…­":w==="æ—¥";
  }).forEach(r=>{
    const d = new Date(r.time);
    const w = weekday(r.time);
    const bad = r.distance>100 ? "bad":"";

    tbody.innerHTML += `
      <tr>
        <td>${r.emp_id}</td>
        <td>${r.name}</td>
        <td>${r.action}</td>
        <td class="${bad}">${r.distance ?? ""}</td>
        <td>${d.toISOString().slice(0,10)}</td>
        <td>${w}</td>
        <td>${d.toLocaleTimeString()}</td>
      </tr>`;
  });
}

function exportExcel(){
  const rows = RAW.map(r=>{
    const d=new Date(r.time);
    const w=weekday(r.time);
    return {
      å·¥è™Ÿ:r.emp_id,
      å§“å:r.name,
      å‹•ä½œ:r.action,
      è·é›¢:r.distance,
      æ—¥æœŸ:d.toISOString().slice(0,10),
      æ˜ŸæœŸ:w,
      æ˜¯å¦é€±æœ«:(w==="å…­"||w==="æ—¥"),
      æ™‚é–“:d.toLocaleTimeString()
    };
  });

  const ws=XLSX.utils.json_to_sheet(rows);
  ws["H2"]={f:'=IF(E2>=100,TRUE,FALSE)'}; // ç¯„ä¾‹å…¬å¼
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"HR");
  XLSX.writeFile(wb,"attendance.xlsx");
}
</script>
</body>
</html>
