<!DOCTYPE html><html><head>
<meta charset="utf-8"><title>HR</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
<div id="auth">
  å¯†ç¢¼ <input id="pwd" type="password">
  <button onclick="login()">ç™»å…¥</button>
</div>
<div id="panel" style="display:none">
<button onclick="load()">é‡æ–°æ•´ç†</button>
<button onclick="excel()">åŒ¯å‡º Excel</button>
<table border="1" id="t"></table>
</div>

<div id="mapBox" style="display:none">
<button onclick="mapBox.style.display='none'">é—œé–‰</button>
<div id="map" style="height:400px"></div>
</div>

<script>
const API="https://punch-api.jackey1688.workers.dev";
let cache=[], map;
function login(){ if(pwd.value==="1234"){auth.style.display="none";panel.style.display="block";load();} }
async function load(){
  const r=await fetch(API+"/api/records"); cache=await r.json();
  t.innerHTML="<tr><th>äºº</th><th>å‹•ä½œ</th><th>æ™‚é–“</th><th>è·é›¢</th><th>âœ”</th><th>ç°½æ ¸</th><th>å‚™è¨»</th><th>åœ°åœ–</th></tr>";
  cache.forEach(x=>{
    t.innerHTML+=`<tr>
      <td>${x.name}</td><td>${x.type}</td><td>${x.time}</td><td>${x.distance}</td>
      <td>${x.ok?"âœ”":"âŒ"}</td>
      <td>
        <button onclick="review('${x.key}','approved')">âœ”</button>
        <button onclick="review('${x.key}','rejected')">âŒ</button>
      </td>
      <td><input id="n-${x.key}" value="${x.reviewNote||""}"></td>
      <td><button onclick="show(${x.lat},${x.lng})">ğŸ—ºï¸</button></td>
    </tr>`;
  });
}
async function review(k,s){
  const note=document.getElementById("n-"+k).value;
  await fetch(API+"/api/review",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({key:k,review:s,note})});
  load();
}
function show(lat,lng){
  mapBox.style.display="block";
  if(map) map.remove();
  map=L.map("map").setView([lat,lng],17);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  L.marker([lat,lng]).addTo(map);
}
function excel(){
  const ws=XLSX.utils.json_to_sheet(cache);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Records");
  XLSX.writeFile(wb,"HR.xlsx");
}
</script>
</body></html>
