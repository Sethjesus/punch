<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HR æ‰“å¡å¾Œå°</title>

<style>
body{
  font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
  background:#f3f4f6;
}
.container{
  max-width:1200px;
  margin:28px auto;
  background:#fff;
  padding:22px;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.12);
}
h2{margin-bottom:10px}
.toolbar{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  margin-bottom:12px;
}
button,select{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid #ccc;
  background:#2563eb;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
select{background:#fff;color:#111}
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
th,td{
  padding:10px;
  border-bottom:1px solid #e5e7eb;
}
th{
  background:#f9fafb;
  cursor:pointer;
}
.bad{color:#b91c1c;font-weight:700}
.ok{color:#166534}
.muted{color:#6b7280}
.footer{
  margin-top:8px;
  font-size:12px;
  color:#6b7280;
}
</style>
</head>

<body>
<div class="container">
  <h2>ğŸ“‹ HR æ‰“å¡å¾Œå°</h2>

  <div class="toolbar">
    <button onclick="exportCSV()">â¬‡ åŒ¯å‡º Excel</button>
    <button onclick="showWeeklyStats()">ğŸ“Š æ¯é€±çµ±è¨ˆ</button>

    <select id="weekdayFilter" onchange="applyFilters()">
      <option value="">å…¨éƒ¨æ˜ŸæœŸ</option>
      <option value="ä¸€">æ˜ŸæœŸä¸€</option>
      <option value="äºŒ">æ˜ŸæœŸäºŒ</option>
      <option value="ä¸‰">æ˜ŸæœŸä¸‰</option>
      <option value="å››">æ˜ŸæœŸå››</option>
      <option value="äº”">æ˜ŸæœŸäº”</option>
      <option value="å…­">æ˜ŸæœŸå…­</option>
      <option value="æ—¥">æ˜ŸæœŸæ—¥</option>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th onclick="sortByEmp()">å·¥è™Ÿ</th>
        <th>å§“å</th>
        <th>å‹•ä½œ</th>
        <th>è·é›¢(m)</th>
        <th>æ—¥æœŸ</th>
        <th>æ˜ŸæœŸ</th>
        <th>æ™‚é–“</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="footer">è³‡æ–™ä¾†æºï¼šCloudflare Workers KV</div>
</div>

<script>
/* ========= è¨­å®š ========= */
const ADMIN_API = "https://punch-api.jackey1688.workers.dev/api/admin/attendance";
const DIST_LIMIT = 100;
const WEEK_MAP = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];

let DATA = [];
let empAsc = true;

/* ========= æ—¥æœŸå·¥å…· ========= */
function splitDateInfo(iso){
  const d = new Date(iso);
  return {
    y: d.getFullYear(),
    m: d.getMonth()+1,
    d: d.getDate(),
    weekday: WEEK_MAP[d.getDay()],
    weekdayIndex: d.getDay(),
    time: d.toLocaleTimeString(),
    weekKey: getISOWeekKey(d)
  };
}

function getISOWeekKey(date){
  const d = new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate()));
  const day = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - day);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const week = Math.ceil((((d - yearStart)/86400000)+1)/7);
  return `${d.getUTCFullYear()}-W${String(week).padStart(2,"0")}`;
}

/* ========= è³‡æ–™è®€å– ========= */
fetch(ADMIN_API)
  .then(r=>r.json())
  .then(list=>{
    DATA = list || [];
    render(DATA);
  });

/* ========= è¡¨æ ¼ ========= */
function render(rows){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  rows.forEach(r=>{
    const info = splitDateInfo(r.time);
    const isLeave = r.distance === null;
    const isBad = !isLeave && r.distance > DIST_LIMIT;

    tbody.insertAdjacentHTML("beforeend",`
      <tr>
        <td>${r.emp_id}</td>
        <td>${r.name}</td>
        <td>${r.action}</td>
        <td class="${isLeave?"muted":(isBad?"bad":"ok")}">${isLeave?"â€”":r.distance}</td>
        <td>${info.y}/${String(info.m).padStart(2,"0")}/${String(info.d).padStart(2,"0")}</td>
        <td>${info.weekday}</td>
        <td>${info.time}</td>
      </tr>
    `);
  });
}

/* ========= å·¥è™Ÿæ’åº ========= */
function sortByEmp(){
  DATA.sort((a,b)=>empAsc
    ? a.emp_id.localeCompare(b.emp_id)
    : b.emp_id.localeCompare(a.emp_id)
  );
  empAsc=!empAsc;
  applyFilters();
}

/* ========= æ˜ŸæœŸç¯©é¸ ========= */
function applyFilters(){
  const w = document.getElementById("weekdayFilter").value;
  let rows = [...DATA];
  if(w){
    rows = rows.filter(r=>splitDateInfo(r.time).weekday===w);
  }
  render(rows);
}

/* ========= æ¯é€±çµ±è¨ˆ ========= */
function showWeeklyStats(){
  const map={};
  DATA.forEach(r=>{
    const info = splitDateInfo(r.time);
    const key = `${r.emp_id} ${info.weekKey}`;
    map[key]=(map[key]||0)+1;
  });
  let msg="æ¯äººæ¯é€±æ‰“å¡æ¬¡æ•¸\n\n";
  Object.entries(map).forEach(([k,v])=>msg+=`${k}ï¼š${v} æ¬¡\n`);
  alert(msg);
}

/* ========= Excel åŒ¯å‡º ========= */
function exportCSV(){
  let csv="å·¥è™Ÿ,å§“å,å‹•ä½œ,è·é›¢(m),æ—¥æœŸ,æ˜ŸæœŸ,æ™‚é–“,æ˜¯å¦é€±æœ«\n";

  DATA.forEach(r=>{
    const info = splitDateInfo(r.time);
    const isWeekend = (info.weekdayIndex===0||info.weekdayIndex===6);
    csv += [
      r.emp_id,
      r.name,
      r.action,
      r.distance ?? "",
      `${info.y}/${String(info.m).padStart(2,"0")}/${String(info.d).padStart(2,"0")}`,
      info.weekday,
      info.time,
      isWeekend?"TRUE":"FALSE"
    ].join(",")+"\n";
  });

  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="attendance.csv";
  a.click();
}
</script>
</body>
</html>
