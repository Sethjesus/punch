<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UDM ESGï½œäººè³‡ä¸Šç­è«‹å‡ç³»çµ±ï¼ˆHRï¼‰</title>

<!-- Leaflet (å… Google / å… API Key) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- SheetJS (åŒ¯å‡º .xlsx) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#2f2f3a;
  --card:#f4f6f8;
  --header:#1f2937;
}
body{margin:0;background:var(--bg);font-family:system-ui}
header{
  background:var(--header);
  color:#fff;
  padding:14px;
  text-align:center;
}
header h1{margin:0;font-size:20px}
header div{font-size:13px;opacity:.85}

.container{
  max-width:1600px;
  margin:20px auto;
  background:var(--card);
  border-radius:12px;
  padding:16px;
}
.toolbar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  margin-bottom:10px;
}
button{
  padding:6px 12px;
  border:0;
  border-radius:8px;
  cursor:pointer;
}
.primary{background:#3498db;color:#fff}
.excel{background:#27ae60;color:#fff}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
th,td{
  border-bottom:1px solid #d1d5db;
  padding:6px;
  text-align:center;
  vertical-align:top;
}
th{
  background:#e5e7eb;
  position:sticky;
  top:0;
  z-index:1;
}

/* è¡Œåˆ¥æ¨£å¼ */
.leaveOnly{background:#fff4cc}
.tripRow{background:#e8ffe8}
.otRow{background:#eaf4ff}

/* é€±æœ« / åœ‹å®šé€£å‡ */
.weekendRow{ background:#ffecec }
.weekendText{ color:#c0392b; font-weight:bold }
.holidayRow{ background:#fff8d6 }
.holidayText{ color:#d35400; font-weight:bold }

/* è·é›¢ > 20m */
.far{
  background:#c0392b;
  color:#fff;
  font-weight:bold;
}

/* Login */
.loginMask{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10;
}
.loginBox{
  background:#fff;
  padding:20px;
  border-radius:12px;
  width:260px;
  text-align:center;
}
.loginBox input{
  width:100%;
  padding:8px;
  margin:8px 0;
}

/* Leaflet mini map */
.miniMap{
  width:180px;
  height:120px;
  border-radius:8px;
  border:1px solid #ccc;
  overflow:hidden;
  margin-top:4px;
}
.small{font-size:11px;opacity:.9}
</style>
</head>

<body>

<!-- ğŸ” Login -->
<div class="loginMask" id="loginMask">
  <div class="loginBox">
    <h3>HR Login</h3>
    <input type="password" id="pwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
    <button class="primary" onclick="login()">ç™»å…¥</button>
  </div>
</div>

<header>
  <h1>UDM ESG</h1>
  <div>äººè³‡ä¸Šç­è«‹å‡ç³»çµ±ï¼ˆHRï¼‰</div>
</header>

<div class="container">
  <div class="toolbar">
    ğŸ“… æœˆä»½ï¼š
    <input type="month" id="monthPicker">
    <button class="primary" onclick="drawTable()">é‡æ–°æ•´ç†</button>
    <button class="excel" onclick="exportExcel()">åŒ¯å‡º Excelï¼ˆ.xlsxï¼‰</button>
  </div>

  <table id="tbl"></table>
</div>

<script>
/* =====================
   Login
===================== */
function login(){
  if(document.getElementById("pwd").value==="1234"){
    document.getElementById("loginMask").style.display="none";
  }else alert("å¯†ç¢¼éŒ¯èª¤");
}

/* =====================
   API
===================== */
const API_ATT   = "https://punch-api.jackey1688.workers.dev/api/records";
const API_LEAVE = "https://punch-api.jackey1688.workers.dev/api/leave";
const API_APP   = "https://punch-api.jackey1688.workers.dev/api/leave/approve";

/* =====================
   å…¬å¸åº§æ¨™
===================== */
const COMPANY_LAT = 25.00657;
const COMPANY_LNG = 121.48416;

/* =====================
   2026 åœ‹å®šé€£å‡ï¼ˆå€é–“ï¼‰
===================== */
const HOLIDAY_RANGES = [
  { start:"2026-02-14", end:"2026-02-22", name:"è¾²æ›†æ˜¥ç¯€é€£å‡" },
  { start:"2026-02-27", end:"2026-03-01", name:"228é€£å‡" },
  { start:"2026-04-03", end:"2026-04-06", name:"æ¸…æ˜ç¯€é€£å‡" },
  { start:"2026-05-01", end:"2026-05-03", name:"å‹å‹•ç¯€é€£å‡" },
  { start:"2026-06-19", end:"2026-06-21", name:"ç«¯åˆç¯€é€£å‡" },
  { start:"2026-09-25", end:"2026-09-28", name:"ä¸­ç§‹ / æ•™å¸«ç¯€é€£å‡" },
  { start:"2026-10-09", end:"2026-10-11", name:"åœ‹æ…¶æ—¥é€£å‡" },
  { start:"2026-10-24", end:"2026-10-26", name:"å…‰å¾©ç¯€é€£å‡" },
  { start:"2026-12-25", end:"2026-12-27", name:"è¡Œæ†²ç´€å¿µæ—¥é€£å‡" }
];

let records = [];
let leaves  = [];

const tbl = document.getElementById("tbl");
const mp  = document.getElementById("monthPicker");
mp.value = new Date().toISOString().slice(0,7);

/* =====================
   Utils
===================== */
function distanceMeter(lat1,lng1,lat2,lng2){
  const R=6371000;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLng=(lng2-lng1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
    Math.sin(dLng/2)**2;
  return Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

function parseDetail(r){
  if(!r) return "";
  return r.replace(/\n/g,"<br>")
    .replace(/ã€åŠ ç­ã€‘/g,'<b style="color:#2980b9">ã€åŠ ç­ã€‘</b>')
    .replace(/ã€å‡ºå·®ã€‘/g,'<b style="color:#27ae60">ã€å‡ºå·®ã€‘</b>');
}

function weekdayInfo(dateStr){
  const d = new Date(dateStr);
  const day = d.getDay(); // 0 æ—¥, 6 å…­
  const isWeekend = day === 0 || day === 6;

  let holidayName = "";
  for(const h of HOLIDAY_RANGES){
    if(dateStr >= h.start && dateStr <= h.end){
      holidayName = h.name;
      break;
    }
  }

  let label;
  if(holidayName){
    label = "åœ‹å®šå‡æ—¥";
  }else{
    const map = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
    label = "é€±" + map[day];
  }

  return {
    label,
    isWeekend,
    isHoliday: !!holidayName,
    holidayName
  };
}

function nextDateStr(yyyy_mm_dd){
  const t = new Date(yyyy_mm_dd).getTime() + 86400000;
  return new Date(t).toISOString().slice(0,10);
}

/* =====================
   Load
===================== */
async function load(){
  records = await (await fetch(API_ATT)).json();
  leaves  = await (await fetch(API_LEAVE)).json();
  drawTable();
}
load();

/* =====================
   Leaflet mini-maps
===================== */
let mapQueue = []; // {id, lat, lng, dist}
function buildMiniMap(id, lat, lng){
  const map = L.map(id, { zoomControl:false, attributionControl:false, dragging:false, scrollWheelZoom:false, doubleClickZoom:false, boxZoom:false, keyboard:false, tap:false })
              .setView([COMPANY_LAT, COMPANY_LNG], 18);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

  // å…¬å¸é»
  L.circleMarker([COMPANY_LAT, COMPANY_LNG], { radius:6, color:"#1f77b4", fillColor:"#1f77b4", fillOpacity:1 })
    .addTo(map)
    .bindTooltip("å…¬å¸", {permanent:false});

  // 20m åŠå¾‘åœˆ
  L.circle([COMPANY_LAT, COMPANY_LNG], { radius:20, color:"#1f77b4", fillColor:"#1f77b4", fillOpacity:0.2 })
    .addTo(map);

  // æ‰“å¡é»
  L.circleMarker([lat, lng], { radius:6, color:"#c0392b", fillColor:"#e74c3c", fillOpacity:1 })
    .addTo(map);
}

/* =====================
   Draw
===================== */
function drawTable(){
  const month = mp.value || "";
  mapQueue = [];
  let mapIdx = 0;

  // âœ… â‘ ï¼šåŠ å…¥è«‹å‡å»é‡ Setï¼ˆåŒä¸€ç­† leave.id åªé¡¯ç¤ºä¸€æ¬¡ï¼‰
  const shownLeaveIds = new Set();

  let html = `
  <tr>
    <th>æ—¥æœŸ</th>
    <th>æ˜ŸæœŸ</th>
    <th>å§“å</th>
    <th>é¡å‹</th>
    <th>ä¸Šç­</th>
    <th>ä¸‹ç­</th>
    <th>GPS / åœ°åœ–</th>
    <th>è·å…¬å¸(m)</th>
    <th>ç”³è«‹é¡å‹</th>
    <th>æœŸé–“</th>
    <th>è©³ç´°</th>
    <th>æ ¸å‡†</th>
  </tr>`;

  const shown = new Set();

  /* ===== æ‰“å¡ ===== */
  records.forEach(r=>{
    const date = r.created_at_tw?.slice(0,10);
    if(!date) return;
    if(month && !date.startsWith(month)) return;

    const w = weekdayInfo(date);
    const rowCls = w.isHoliday ? "holidayRow" : w.isWeekend ? "weekendRow" : "";
    const textCls = w.isHoliday ? "holidayText" : w.isWeekend ? "weekendText" : "";

    const time = r.created_at_tw.slice(11,19);
    const key  = r.name + "_" + date + "_" + r.action; // åŒæ—¥ä¸Šä¸‹ç­å„ä¸€ç­†
    shown.add(key);

    const leave = leaves.find(l => l.name===r.name && date>=l.start_date && date<=l.end_date);

    let dist = "";
    let gpsCell = "";

    if(r.lat && r.lng){
      const d = distanceMeter(COMPANY_LAT, COMPANY_LNG, r.lat, r.lng);
      dist = d;

      const mapId = "map_" + (++mapIdx);
      gpsCell = `
        <div class="small">${r.lat.toFixed(5)}, ${r.lng.toFixed(5)}</div>
        <div id="${mapId}" class="miniMap"></div>
      `;
      mapQueue.push({ id: mapId, lat: r.lat, lng: r.lng });
    }else{
      gpsCell = "";
    }

    html += `
    <tr class="${rowCls}">
      <td>${date}</td>
      <td class="${textCls}" title="${w.holidayName||''}">${w.label}${w.holidayName?("ï½œ"+w.holidayName):""}</td>
      <td>${r.name}</td>
      <td>${r.action}</td>
      <td>${r.action==="ä¸Šç­" ? time : ""}</td>
      <td>${r.action==="ä¸‹ç­" ? time : ""}</td>
      <td>${gpsCell}</td>
      <td class="${dist!=="" && dist>20 ? "far" : ""}">${dist!=="" ? dist : ""}</td>
      <td>${leave ? leave.type : ""}</td>
      <td>${leave ? (leave.start_date + " ~ " + leave.end_date) : ""}</td>
      <td>${leave ? parseDetail(leave.reason) : ""}</td>
      <td>${leave ? `
        <input type="checkbox" ${leave.approved ? "checked" : ""}
          onchange="approveLeave(${leave.id}, this.checked)">
      ` : ""}</td>
    </tr>`;
  });

  /* ===== åªæœ‰ç”³è«‹ï¼ˆæ²’æ‰“å¡ï¼‰===== */
  leaves.forEach(l=>{

    // âœ… â‘¡ï¼šåŒä¸€ç­†è«‹å‡åªé¡¯ç¤ºä¸€æ¬¡ï¼ˆé¿å…é‡è¤‡å±•é–‹ï¼‰
    if (shownLeaveIds.has(l.id)) return;
    shownLeaveIds.add(l.id);

    let cur = l.start_date;
    while(cur <= l.end_date){
      if(month && !cur.startsWith(month)){
        cur = nextDateStr(cur);
        continue;
      }

      // ç›®å‰ï¼šåªè¦ç•¶å¤©æ²’æœ‰ä»»ä½•æ‰“å¡(ä¸Š/ä¸‹ç­)å°±é¡¯ç¤ºç”³è«‹
      const keyIn  = l.name + "_" + cur + "_ä¸Šç­";
      const keyOut = l.name + "_" + cur + "_ä¸‹ç­";

      if(!shown.has(keyIn) && !shown.has(keyOut)){
        const w = weekdayInfo(cur);
        const baseCls = l.type==="å‡ºå·®" ? "tripRow" : l.type==="åŠ ç­" ? "otRow" : "leaveOnly";
        const rowCls  = w.isHoliday ? "holidayRow" : w.isWeekend ? "weekendRow" : baseCls;
        const textCls = w.isHoliday ? "holidayText" : w.isWeekend ? "weekendText" : "";

        html += `
        <tr class="${rowCls}">
          <td>${cur}</td>
          <td class="${textCls}" title="${w.holidayName||''}">${w.label}${w.holidayName?("ï½œ"+w.holidayName):""}</td>
          <td>${l.name}</td>
          <td>ç”³è«‹</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td>${l.type}</td>
          <td>${l.start_date} ~ ${l.end_date}</td>
          <td>${parseDetail(l.reason)}</td>
          <td>
            <input type="checkbox" ${l.approved ? "checked" : ""}
              onchange="approveLeave(${l.id}, this.checked)">
          </td>
        </tr>`;

        // âœ… åªé¡¯ç¤ºä¸€ç­†ï¼šä¸€æ—¦é¡¯ç¤ºæˆåŠŸå°± breakï¼ˆé¿å…åŒä¸€ç­†è«‹å‡é¡¯ç¤ºå¤šåˆ—ï¼‰
        break;
      }

      cur = nextDateStr(cur);
    }
  });

  tbl.innerHTML = html;

  // ç­‰ DOM æ’å…¥å¾Œå†å»ºåœ°åœ–
  setTimeout(()=>{
    mapQueue.forEach(m => {
      const el = document.getElementById(m.id);
      if(el) buildMiniMap(m.id, m.lat, m.lng);
    });
  }, 0);
}

/* =====================
   Approve
===================== */
async function approveLeave(id, checked){
  await fetch(API_APP,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ id, approved: checked ? 1 : 0 })
  });
}

/* =====================
   Excel helpers
===================== */
function isHoliday(dateStr){
  for(const h of HOLIDAY_RANGES){
    if(dateStr>=h.start && dateStr<=h.end) return true;
  }
  return false;
}
function isWeekend(dateStr){
  const d = new Date(dateStr);
  const day = d.getDay();
  return day===0 || day===6;
}
function applyFill(cell, rgb){
  cell.s = cell.s || {};
  cell.s.fill = { fgColor:{ rgb } };
}
function applyFarStyle(cell){
  cell.s = cell.s || {};
  cell.s.fill = { fgColor:{ rgb:"C0392B" } };
  cell.s.font = { color:{ rgb:"FFFFFF" }, bold:true };
}

/* =====================
   Excel export (.xlsx)
   - æ¯äººä¸€å¼µ Sheet
   - åœ‹å®šå‡æ—¥/é€±æœ«åº•è‰²
   - è·é›¢ >20m ç´…åº•
   - Daily Summary: æœ€æ—©ä¸Šç­/æœ€æ™šä¸‹ç­/æœ€é è·é›¢
===================== */
function exportExcel(){
  const wb = XLSX.utils.book_new();

  // å…ˆå¾ç›®å‰è¡¨æ ¼æŠ“è³‡æ–™ï¼ˆå’Œç•«é¢ä¸€è‡´ï¼‰
  const rowsAll = [];
  document.querySelectorAll("#tbl tr").forEach((tr,i)=>{
    if(i===0) return;
    const tds = [...tr.children];
    // 12 æ¬„
    const row = tds.map(td => td.innerText.replace(/\n/g," ").trim());
    rowsAll.push(row);
  });

  // ä¾å§“ååˆ†çµ„
  const people = {};
  rowsAll.forEach(r=>{
    const name = r[2] || "";
    if(!people[name]) people[name] = [];
    people[name].push(r);
  });

  // æ¯äºº sheet
  Object.keys(people).forEach(name=>{
    const header = ["æ—¥æœŸ","æ˜ŸæœŸ","å§“å","é¡å‹","ä¸Šç­","ä¸‹ç­","GPS / åœ°åœ–","è·å…¬å¸(m)","ç”³è«‹é¡å‹","æœŸé–“","è©³ç´°","æ ¸å‡†"];
    const aoa = [header, ...people[name]];

    const ws = XLSX.utils.aoa_to_sheet(aoa);
    ws["!cols"] = [
      {wch:12},{wch:16},{wch:10},{wch:6},
      {wch:8},{wch:8},{wch:20},{wch:12},
      {wch:10},{wch:22},{wch:30},{wch:6}
    ];

    // é€åˆ—å¥—è‰²ï¼šå‡æ—¥/é€±æœ« + >20m
    for(let i=2;i<=aoa.length;i++){
      const dateCell = ws["A"+i];
      if(!dateCell) continue;
      const dateStr = String(dateCell.v);

      const holiday = isHoliday(dateStr);
      const weekend = isWeekend(dateStr);

      if(holiday || weekend){
        const rgb = holiday ? "FFF4CC" : "FFECEC";
        ["A","B","C","D","E","F","G","H","I","J","K","L"].forEach(c=>{
          const cell = ws[c+i];
          if(cell) applyFill(cell, rgb);
        });
      }

      const distCell = ws["H"+i];
      if(distCell && Number(distCell.v)>20){
        applyFarStyle(distCell);
      }
    }

    XLSX.utils.book_append_sheet(wb, ws, String(name).substring(0,31) || "æœªå‘½å");
  });

  // Daily Summary
  // æ—¥æœŸ | å§“å | æœ€æ—©ä¸Šç­ | æœ€æ™šä¸‹ç­ | æœ€é è·é›¢(m)
  const summary = {};
  rowsAll.forEach(r=>{
    const date = r[0];
    const name = r[2];
    const type = r[3];
    const inTime = r[4];
    const outTime = r[5];
    const dist = Number(r[7]) || 0;

    const key = date + "_" + name;
    if(!summary[key]) summary[key] = { date, name, earliest:"", latest:"", maxDist:0 };

    if(type==="ä¸Šç­" && inTime){
      if(!summary[key].earliest || inTime < summary[key].earliest) summary[key].earliest = inTime;
    }
    if(type==="ä¸‹ç­" && outTime){
      if(!summary[key].latest || outTime > summary[key].latest) summary[key].latest = outTime;
    }
    summary[key].maxDist = Math.max(summary[key].maxDist, dist);
  });

  const sumAoa = [["æ—¥æœŸ","å§“å","æœ€æ—©ä¸Šç­","æœ€æ™šä¸‹ç­","æœ€é è·é›¢(m)"]];
  Object.values(summary).forEach(v=>{
    sumAoa.push([v.date, v.name, v.earliest, v.latest, v.maxDist]);
  });

  const wsSum = XLSX.utils.aoa_to_sheet(sumAoa);
  wsSum["!cols"] = [{wch:12},{wch:10},{wch:10},{wch:10},{wch:14}];

  for(let i=2;i<=sumAoa.length;i++){
    const dateStr = String(wsSum["A"+i]?.v || "");
    const holiday = isHoliday(dateStr);
    const weekend = isWeekend(dateStr);
    if(holiday || weekend){
      const rgb = holiday ? "FFF4CC" : "FFECEC";
      ["A","B","C","D","E"].forEach(c=>{
        const cell = wsSum[c+i];
        if(cell) applyFill(cell, rgb);
      });
    }

    const cellE = wsSum["E"+i];
    if(cellE && Number(cellE.v)>20){
      applyFarStyle(cellE);
    }
  }

  XLSX.utils.book_append_sheet(wb, wsSum, "Daily Summary");

  const ym = document.getElementById("monthPicker").value || "ALL";
  XLSX.writeFile(wb, `UDM_ESG_HR_${ym}.xlsx`);
}
</script>

</body>
</html>
