<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HR æ‰“å¡ / è«‹å‡ç¸½è¦½</title>

<style>
body{
  margin:0;
  background:#3f3f3f;
  font-family:system-ui;
}
.container{
  max-width:1400px;
  margin:20px auto;
  background:#f4f4f4;
  border-radius:10px;
  padding:16px;
}
h2{margin:0 0 10px}
.toolbar{
  display:flex;
  gap:10px;
  align-items:center;
  margin-bottom:10px;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
th,td{
  border-bottom:1px solid #ccc;
  padding:6px;
  text-align:center;
}
th{
  background:#e0e0e0;
  position:sticky;
  top:0;
}
.leaveOnly{
  background:#fff4cc;
}
.red{
  color:#c0392b;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="container">
  <h2>HR æ‰“å¡ / è«‹å‡ç¸½è¦½</h2>

  <div class="toolbar">
    ğŸ“… æœˆä»½ï¼š
    <input type="month" id="monthPicker">
    <button onclick="drawTable()">é‡æ–°æ•´ç†</button>
  </div>

  <table id="tbl"></table>
</div>

<script>
/* ===== API ===== */
const API_ATT   = "https://punch-api.jackey1688.workers.dev/api/records";
const API_LEAVE = "https://punch-api.jackey1688.workers.dev/api/leave";
const API_APP   = "https://punch-api.jackey1688.workers.dev/api/leave/approve";

/* ===== å…¬å¸åº§æ¨™ ===== */
const COMPANY_LAT = 25.00657;
const COMPANY_LNG = 121.48416;

/* ===== å…¨åŸŸè³‡æ–™ ===== */
let records = [];
let leaves  = [];

const tbl = document.getElementById("tbl");
const monthPicker = document.getElementById("monthPicker");

/* ===== åˆå§‹åŒ–æœˆä»½ï¼ˆé¿å…ç©ºå€¼ / å¿«å–é›·ï¼‰===== */
if (!monthPicker.value) {
  monthPicker.value = new Date().toISOString().slice(0,7);
}

/* ===== è¼‰å…¥è³‡æ–™ ===== */
async function load(){
  records = await (await fetch(API_ATT)).json();
  leaves  = await (await fetch(API_LEAVE)).json();
  drawTable();
}

/* ===== è·é›¢è¨ˆç®— ===== */
function distanceMeter(lat1,lng1,lat2,lng2){
  const R = 6371000;
  const dLat = (lat2-lat1)*Math.PI/180;
  const dLng = (lng2-lng1)*Math.PI/180;
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) *
    Math.cos(lat2*Math.PI/180) *
    Math.sin(dLng/2)**2;
  return Math.round(R * 2 * Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

/* ===== ä¸»ç®¡æ ¸å‡† ===== */
async function approve(id, ok){
  await fetch(API_APP,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ id, approved: ok?1:0 })
  });
}

/* ===== ç•«è¡¨ï¼ˆæœ€çµ‚ç‰ˆï¼‰===== */
function drawTable(){

  /* ğŸ”‘ é—œéµï¼šå¼·åˆ¶ä¿è­‰ month æ˜¯ä¹¾æ·¨å€¼ */
  let month = monthPicker.value;
  if (!month || month.length !== 7) {
    month = "";
  }

  let html = `
    <tr>
      <th>æ—¥æœŸ</th>
      <th>å§“å</th>
      <th>é¡å‹</th>
      <th>ä¸Šç­</th>
      <th>ä¸‹ç­</th>
      <th>GPS</th>
      <th>è·å…¬å¸(m)</th>
      <th>è«‹å‡é¡å‹</th>
      <th>è«‹å‡æœŸé–“</th>
      <th>ä¸»ç®¡åŒæ„</th>
    </tr>
  `;

  /* ç”¨ name + date è¨˜éŒ„ã€Œç•¶å¤©å·²æœ‰è³‡æ–™ã€ */
  const shown = new Set();

  /* ===== â‘  æ‰“å¡è³‡æ–™ ===== */
  records.forEach(r=>{
    const date = r.created_at_tw?.slice(0,10);
    if(!date) return;
    if(month && !date.startsWith(month)) return;

    const time = r.created_at_tw.slice(11,19);
    const key = `${r.name}_${date}`;
    shown.add(key);

    const leave = leaves.find(l =>
      l.name === r.name &&
      date >= l.start_date &&
      date <= l.end_date
    );

    const hasGPS = r.lat && r.lng;
    const dist = hasGPS
      ? distanceMeter(COMPANY_LAT,COMPANY_LNG,r.lat,r.lng)
      : "";

    const gps = hasGPS
      ? `<a target="_blank"
           href="https://maps.google.com/?q=${r.lat},${r.lng}">
           ${r.lat.toFixed(5)},${r.lng.toFixed(5)}
         </a>` : "";

    html += `
      <tr>
        <td>${date}</td>
        <td>${r.name}</td>
        <td>${r.action}</td>
        <td>${r.action==="ä¸Šç­"?time:""}</td>
        <td>${r.action==="ä¸‹ç­"?time:""}</td>
        <td>${gps}</td>
        <td class="${dist>200?'red':''}">
          ${dist?dist+" m":""}
        </td>
        <td>${leave?leave.type:""}</td>
        <td>${leave?leave.start_date+" ~ "+leave.end_date:""}</td>
        <td>
          ${
            leave
            ? `<input type="checkbox"
                ${leave.approved==1?"checked":""}
                onchange="approve(${leave.id},this.checked)">`
            : ""
          }
        </td>
      </tr>
    `;
  });

  /* ===== â‘¡ åªæœ‰è«‹å‡ã€æ²’æ‰“å¡ï¼ˆé€æ—¥é¡¯ç¤ºï¼‰===== */
  leaves.forEach(l=>{
    let cur = l.start_date;

    while(cur <= l.end_date){

      if(month && !cur.startsWith(month)){
        cur = new Date(new Date(cur).getTime()+86400000)
                .toISOString().slice(0,10);
        continue;
      }

      const key = `${l.name}_${cur}`;

      if(!shown.has(key)){
        html += `
          <tr class="leaveOnly">
            <td>${cur}</td>
            <td>${l.name}</td>
            <td>è«‹å‡</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td>${l.type}</td>
            <td>${l.start_date} ~ ${l.end_date}</td>
            <td>
              <input type="checkbox"
                ${l.approved==1?"checked":""}
                onchange="approve(${l.id},this.checked)">
            </td>
          </tr>
        `;
      }

      cur = new Date(new Date(cur).getTime()+86400000)
              .toISOString().slice(0,10);
    }
  });

  tbl.innerHTML = html;
}

/* ===== å•Ÿå‹• ===== */
load();
</script>

</body>
</html>
