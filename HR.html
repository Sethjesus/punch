<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UDM ESGï½œäººè³‡ä¸Šç­è«‹å‡ç³»çµ±ï¼ˆHRï¼‰</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#2f2f3a;
  --card:#f4f6f8;
  --header:#1f2937;
  --z-header:200;
  --z-login:10000;
}

*{ box-sizing:border-box }
body{ margin:0; background:var(--bg); font-family:system-ui; }

header{
  background:var(--header);
  color:#fff;
  padding:14px;
  text-align:center;
  position:sticky;
  top:0;
  z-index:var(--z-header);
}
header h1{margin:0;font-size:20px}
header div{font-size:13px;opacity:.85}

.container{
  max-width:1600px;
  margin:20px auto;
  background:var(--card);
  border-radius:12px;
  padding:16px;
}

.toolbar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  margin-bottom:10px;
}

button{
  padding:6px 12px;
  border:0;
  border-radius:8px;
  cursor:pointer;
}
.primary{background:#3498db;color:#fff}
.excel{background:#27ae60;color:#fff}
.ghost{background:#e5e7eb;color:#111}

table{ width:100%; border-collapse:collapse; font-size:14px; }
th,td{
  border-bottom:1px solid #d1d5db;
  padding:6px;
  text-align:center;
  vertical-align:top;
}
th{
  background:#e5e7eb;
  position:sticky;
  top:0;
  z-index:1;
}

.leaveOnly{background:#fff4cc}
.tripRow{background:#e8ffe8}
.otRow{background:#eaf4ff}

.weekendRow{ background:#ffecec }
.weekendText{ color:#c0392b; font-weight:bold }
.holidayRow{ background:#fff8d6 }
.holidayText{ color:#d35400; font-weight:bold }

.far{
  background:#c0392b;
  color:#fff;
  font-weight:bold;
}

.loginMask{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:var(--z-login);
}
.loginBox{
  background:#fff;
  padding:20px;
  border-radius:12px;
  width:260px;
  text-align:center;
}
.loginBox input{ width:100%; padding:8px; margin:8px 0; }

.miniMap{
  width:180px;
  height:120px;
  border-radius:8px;
  border:1px solid #ccc;
  overflow:hidden;
  margin-top:4px;
}

.small{ font-size:11px; opacity:.9; }
.withdrawnText{ color:#888; font-size:12px; font-style:italic; }

.commentCell{
  display:flex;
  flex-direction:column;
  gap:6px;
  align-items:center;
}
.commentBtn{
  padding:4px 10px;
  border-radius:8px;
  border:0;
  cursor:pointer;
  background:#111827;
  color:#fff;
  font-size:12px;
}
.commentBox{
  max-width:220px;
  text-align:left;
  white-space:pre-wrap;
  word-break:break-word;
}
</style>
</head>

<body>

<!-- Login -->
<div class="loginMask" id="loginMask">
  <div class="loginBox">
    <h3>HR Login</h3>
    <input type="password" id="pwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
    <button class="primary" onclick="login()">ç™»å…¥</button>
  </div>
</div>

<header>
  <h1>UDM ESG</h1>
  <div>äººè³‡ä¸Šç­è«‹å‡ç³»çµ±ï¼ˆHRï¼‰</div>
</header>

<div class="container">
  <div class="toolbar">
    ğŸ“… æœˆä»½ï¼š
    <input type="month" id="monthPicker">
    <button class="primary" onclick="drawTable()">é‡æ–°æ•´ç†</button>
    <button class="excel" onclick="exportExcel()">åŒ¯å‡º Excelï¼ˆæ¯äººåˆ†é  + çµ±è¨ˆï¼‰</button>
  </div>

  <table id="tbl"></table>
</div>

<script>
/* =====================
   LOGIN
===================== */
function login(){
  if(document.getElementById("pwd").value==="1234"){
    document.getElementById("loginMask").style.display="none";
  }else alert("å¯†ç¢¼éŒ¯èª¤");
}

/* =====================
   API
===================== */
const API_ATT     = "https://punch-api.jackey1688.workers.dev/api/records";
const API_LEAVE   = "https://punch-api.jackey1688.workers.dev/api/leave";
const API_APP     = "https://punch-api.jackey1688.workers.dev/api/leave/approve";
const API_COMMENT = "https://punch-api.jackey1688.workers.dev/api/leave/comment";

/* =====================
   COMPANY
===================== */
const COMPANY_LAT = 25.00657;
const COMPANY_LNG = 121.48416;

/* =====================
   HOLIDAYS 2026 (Ranges)
===================== */
const HOLIDAY_RANGES = [
  { start:"2026-02-14", end:"2026-02-22", name:"è¾²æ›†æ˜¥ç¯€é€£å‡" },
  { start:"2026-02-27", end:"2026-03-01", name:"228é€£å‡" },
  { start:"2026-04-03", end:"2026-04-06", name:"æ¸…æ˜ç¯€é€£å‡" },
  { start:"2026-05-01", end:"2026-05-03", name:"å‹å‹•ç¯€é€£å‡" },
  { start:"2026-06-19", end:"2026-06-21", name:"ç«¯åˆç¯€é€£å‡" },
  { start:"2026-09-25", end:"2026-09-28", name:"ä¸­ç§‹ / æ•™å¸«ç¯€é€£å‡" },
  { start:"2026-10-09", end:"2026-10-11", name:"åœ‹æ…¶æ—¥é€£å‡" },
  { start:"2026-10-24", end:"2026-10-26", name:"å…‰å¾©ç¯€é€£å‡" },
  { start:"2026-12-25", end:"2026-12-27", name:"è¡Œæ†²ç´€å¿µæ—¥é€£å‡" }
];

let records = [];
let leaves  = [];

const tbl = document.getElementById("tbl");
const mp  = document.getElementById("monthPicker");
mp.value = new Date().toISOString().slice(0,7);

/* =====================
   UTILS
===================== */
function distanceMeter(lat1,lng1,lat2,lng2){
  const R=6371000;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLng=(lng2-lng1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
    Math.sin(dLng/2)**2;
  return Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

function parseDetail(r){
  if(!r) return "";
  return String(r)
    .replace(/\n/g,"<br>")
    .replace(/ã€åŠ ç­ã€‘/g,'<b style="color:#2980b9">ã€åŠ ç­ã€‘</b>')
    .replace(/ã€å‡ºå·®ã€‘/g,'<b style="color:#27ae60">ã€å‡ºå·®ã€‘</b>');
}

function weekdayInfo(dateStr){
  const d = new Date(dateStr);
  const day = d.getDay();
  const isWeekend = day===0 || day===6;

  let holidayName = "";
  for(const h of HOLIDAY_RANGES){
    if(dateStr>=h.start && dateStr<=h.end){ holidayName=h.name; break; }
  }

  const map=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
  const label = holidayName ? "åœ‹å®šå‡æ—¥" : ("é€±"+map[day]);

  return { label, isWeekend, isHoliday:!!holidayName, holidayName };
}

function nextDateStr(yyyy_mm_dd){
  const t = new Date(yyyy_mm_dd).getTime() + 86400000;
  return new Date(t).toISOString().slice(0,10);
}

/* =====================
   LOAD
===================== */
async function load(){
  records = await (await fetch(API_ATT)).json();
  leaves  = await (await fetch(API_LEAVE)).json();
  drawTable();
}
load();

/* =====================
   MINI MAPS
===================== */
let mapQueue = [];
function buildMiniMap(id, lat, lng){
  const map = L.map(id, {
    zoomControl:false,
    attributionControl:false,
    dragging:false,
    scrollWheelZoom:false,
    doubleClickZoom:false,
    boxZoom:false,
    keyboard:false,
    tap:false
  }).setView([COMPANY_LAT, COMPANY_LNG], 18);

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

  L.circleMarker([COMPANY_LAT, COMPANY_LNG], { radius:6 })
    .addTo(map)
    .bindTooltip("å…¬å¸");

  L.circle([COMPANY_LAT, COMPANY_LNG], { radius:35, fillOpacity:0.1 }).addTo(map);

  L.circleMarker([lat, lng], { radius:6, color:"#c0392b" }).addTo(map);
}

/* =====================
   APPROVE
===================== */
async function approveLeave(id){
  const leave = leaves.find(l => l.id === id);
  if(!leave) return;

  if(leave.withdrawn === 1){
    alert("æ­¤ç”³è«‹å·²æ’¤å›ï¼Œç„¡æ³•æ ¸å‡†");
    drawTable();
    return;
  }

  await fetch(API_APP,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ id, approved: 1 })
  });

  load();
}

/* =====================
   COMMENT (WRITE BACK)
===================== */
async function editComment(id){
  const leave = leaves.find(l => l.id === id);
  if(!leave) return;

  if(leave.withdrawn === 1){
    alert("æ­¤ç”³è«‹å·²æ’¤å›ï¼Œåƒ…ä¾›æŸ¥çœ‹");
    return;
  }

  const text = prompt("è«‹è¼¸å…¥ä¸»ç®¡è¨»è§£", leave.comment || "");
  if(text === null) return;

  await fetch(API_COMMENT, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ id, comment: text })
  });

  load();
}

/* =====================
   DRAW TABLE
===================== */
function drawTable(){
  const month = mp.value || "";
  mapQueue = [];
  let mapIdx = 0;

  const shown = new Set();        // æ‰“å¡å»é‡
  const shownLeaveIds = new Set(); // è«‹å‡å»é‡

  let html = `
  <tr>
    <th>æ—¥æœŸ</th>
    <th>æ˜ŸæœŸ</th>
    <th>å§“å</th>
    <th>é¡å‹</th>
    <th>ä¸Šç­</th>
    <th>ä¸‹ç­</th>
    <th>GPS / åœ°åœ–</th>
    <th>è·å…¬å¸(m)</th>
    <th>ç”³è«‹é¡å‹</th>
    <th>æœŸé–“</th>
    <th>è©³ç´°</th>
    <th>ç‹€æ…‹</th>
    <th>ä¸»ç®¡è¨»è§£</th>
  </tr>`;

  // æ’åº records æŒ‰æ—¥æœŸå€’åºï¼ˆæœ€æ–°åœ¨ä¸Šï¼‰
  const sortedRecords = [...records].sort((a, b) => {
    return (b.created_at_tw || "").localeCompare(a.created_at_tw || "");
  });

  /* ===== æ‰“å¡ rows ===== */
  sortedRecords.forEach(r=>{
    const date = r.created_at_tw?.slice(0,10);
    if(!date) return;
    if(month && !date.startsWith(month)) return;

    // ä½¿ç”¨çœŸå¯¦çš„æ˜ŸæœŸè¨ˆç®—
    const d = new Date(date);
    const dayNames = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
    const realDay = dayNames[d.getDay()];
    const isWeekend = d.getDay() === 0 || d.getDay() === 6;
    
    let holidayName = "";
    for(const h of HOLIDAY_RANGES){
      if(date>=h.start && date<=h.end){ holidayName=h.name; break; }
    }
    
    const isHoliday = !!holidayName;
    const rowCls  = isHoliday ? "holidayRow" : isWeekend ? "weekendRow" : "";
    const textCls = isHoliday ? "holidayText" : isWeekend ? "weekendText" : "";
    const label = isHoliday ? "åœ‹å®šå‡æ—¥" : ("é€±"+realDay);

    const time = r.created_at_tw.slice(11,19);
    const key  = r.name + "_" + date + "_" + r.action;
    shown.add(key);

    const leave = leaves.find(l => l.name===r.name && date>=l.start_date && date<=l.end_date);

    let dist = "";
    let gpsCell = "";

    if(r.lat && r.lng){
      const d = distanceMeter(COMPANY_LAT, COMPANY_LNG, r.lat, r.lng);
      dist = d;

      const mapId = "map_" + (++mapIdx);
      gpsCell = `
        <div class="small">${r.lat.toFixed(5)}, ${r.lng.toFixed(5)}</div>
        <div id="${mapId}" class="miniMap"></div>
      `;
      mapQueue.push({ id: mapId, lat: r.lat, lng: r.lng });
    }

    // ç‹€æ…‹ï¼ˆåªæœ‰ç”³è«‹æ‰æœ‰ï¼Œä½†æ‰“å¡åˆ—ä¹ŸæŠŠè«‹å‡ç‹€æ…‹å¸¶å‡ºï¼‰
    let statusText = "";
    if(leave){
      if(leave.withdrawn === 1) statusText = "å·²æ’¤å›";
      else if(leave.approved === 1) statusText = "å·²æ ¸å‡†";
      else statusText = "å¯©æ ¸ä¸­";
    }

    // è¨»è§£æ¬„
    let commentHtml = "";
    if(leave){
      if(leave.withdrawn === 1){
        commentHtml = `<span class="withdrawnText">â€”</span>`;
      }else{
        commentHtml = `
          <div class="commentCell">
            <div class="commentBox small">${leave.comment ? leave.comment : ""}</div>
            <button class="commentBtn" onclick="editComment(${leave.id})">
              ${leave.comment ? "ä¿®æ”¹" : "å¡«å¯«"}
            </button>
          </div>`;
      }
    }

    html += `
    <tr class="${rowCls}">
      <td>${date}</td>
      <td class="${textCls}" title="${holidayName||''}">${label}${holidayName?("ï½œ"+holidayName):""}</td>
      <td>${r.name}</td>
      <td>${r.action}</td>
      <td>${r.action==="ä¸Šç­" ? time : ""}</td>
      <td>${r.action==="ä¸‹ç­" ? time : ""}</td>
      <td>${gpsCell}</td>
      <td class="${dist!=="" && dist>35 ? "far" : ""}">${dist!=="" ? dist : ""}</td>
      <td>${leave ? leave.type : ""}</td>
      <td>${leave ? (leave.start_date + " ~ " + leave.end_date) : ""}</td>
      <td>${leave ? parseDetail(leave.reason) : ""}</td>
      <td>
        ${leave ? (
          leave.withdrawn === 1
            ? `<span class="withdrawnText">å·²æ’¤å›</span>`
            : leave.approved === 1
              ? `âœ” å·²æ ¸å‡†`
              : `<button class="ghost" onclick="approveLeave(${leave.id})">æ ¸å‡†</button>`
        ) : ""}
      </td>
      <td>${commentHtml}</td>
    </tr>`;
  });

  /* ===== åªæœ‰ç”³è«‹ï¼ˆæ²’æ‰“å¡ï¼‰===== */
  leaves.forEach(l=>{
    if (shownLeaveIds.has(l.id)) return;
    shownLeaveIds.add(l.id);

    let cur = l.start_date;
    while(cur <= l.end_date){
      if(month && !cur.startsWith(month)){
        cur = nextDateStr(cur);
        continue;
      }

      const keyIn  = l.name + "_" + cur + "_ä¸Šç­";
      const keyOut = l.name + "_" + cur + "_ä¸‹ç­";

      if(!shown.has(keyIn) && !shown.has(keyOut)){
        // ä½¿ç”¨çœŸå¯¦çš„æ˜ŸæœŸè¨ˆç®—
        const d = new Date(cur);
        const dayNames = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
        const realDay = dayNames[d.getDay()];
        const isWeekend = d.getDay() === 0 || d.getDay() === 6;
        
        let holidayName = "";
        for(const h of HOLIDAY_RANGES){
          if(cur>=h.start && cur<=h.end){ holidayName=h.name; break; }
        }
        
        const isHoliday = !!holidayName;
        const baseCls = l.type==="å‡ºå·®" ? "tripRow" : l.type==="åŠ ç­" ? "otRow" : "leaveOnly";
        const rowCls  = isHoliday ? "holidayRow" : isWeekend ? "weekendRow" : baseCls;
        const textCls = isHoliday ? "holidayText" : isWeekend ? "weekendText" : "";
        const label = isHoliday ? "åœ‹å®šå‡æ—¥" : ("é€±"+realDay);

        const statusText = (l.withdrawn===1) ? "å·²æ’¤å›" : (l.approved===1 ? "å·²æ ¸å‡†" : "å¯©æ ¸ä¸­");

        const commentHtml = (l.withdrawn===1)
          ? `<span class="withdrawnText">â€”</span>`
          : `
            <div class="commentCell">
              <div class="commentBox small">${l.comment ? l.comment : ""}</div>
              <button class="commentBtn" onclick="editComment(${l.id})">
                ${l.comment ? "ä¿®æ”¹" : "å¡«å¯«"}
              </button>
            </div>`;

        html += `
        <tr class="${rowCls}">
          <td>${cur}</td>
          <td class="${textCls}" title="${holidayName||''}">${label}${holidayName?("ï½œ"+holidayName):""}</td>
          <td>${l.name}</td>
          <td>ç”³è«‹</td>
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td>${l.type}</td>
          <td>${l.start_date} ~ ${l.end_date}</td>
          <td>${parseDetail(l.reason)}</td>
          <td>
            ${l.withdrawn === 1
              ? `<span class="withdrawnText">å·²æ’¤å›</span>`
              : l.approved === 1
                ? `âœ” å·²æ ¸å‡†`
                : `<button class="ghost" onclick="approveLeave(${l.id})">æ ¸å‡†</button>`
            }
          </td>
          <td>${commentHtml}</td>
        </tr>`;
        break;
      }

      cur = nextDateStr(cur);
    }
  });

  tbl.innerHTML = html;

  setTimeout(()=>{
    mapQueue.forEach(m=>{
      const el = document.getElementById(m.id);
      if(el) buildMiniMap(m.id, m.lat, m.lng);
    });
  },0);
}

/* =====================
   EXCEL EXPORT (FULL) - ä¿®æ­£ç‰ˆï¼ˆåŠ å…¥æ—¥æœŸåˆ†çµ„ç©ºè¡Œï¼‰
===================== */
function exportExcel(){
  const wb = XLSX.utils.book_new();
  const month = document.getElementById("monthPicker").value || "";

  // é‡å»ºè³‡æ–™ - ä¿®æ­£æ¬„ä½é †åº
  const rowsAll = [];

  // 1) æ‰“å¡åˆ—ï¼ˆå«è«‹å‡ç‹€æ…‹/è¨»è§£ï¼‰
  records.forEach(r=>{
    const date = r.created_at_tw?.slice(0,10);
    if(!date) return;
    if(month && !date.startsWith(month)) return;

    const leave = leaves.find(l => l.name===r.name && date>=l.start_date && date<=l.end_date);

    // æ’¤å›ï¼šæ•´ç­†ä¸é€² Excel
    if(leave && leave.withdrawn === 1) return;

    const w = weekdayInfo(date);
    const time = r.created_at_tw.slice(11,19);

    let distVal = "";
    let gpsText = "";
    if(r.lat && r.lng){
      const d = distanceMeter(COMPANY_LAT, COMPANY_LNG, r.lat, r.lng);
      distVal = d;
      gpsText = `${r.lat.toFixed(5)}, ${r.lng.toFixed(5)}`;
    }

    let statusText = "";
    let commentText = "";
    if(leave){
      statusText = leave.approved === 1 ? "å·²æ ¸å‡†" : "å¯©æ ¸ä¸­";
      commentText = leave.comment || "";
    }

    rowsAll.push({
      date: date,
      sortTime: r.created_at_tw,
      data: [
        date,  // A: æ—¥æœŸ
        (w.isHoliday ? "åœ‹å®šå‡æ—¥" : w.label) + (w.holidayName ? "ï½œ"+w.holidayName : ""),  // B: æ˜ŸæœŸ
        r.name,  // C: å§“å
        r.action,  // D: é¡å‹
        r.action==="ä¸Šç­" ? time : "",  // E: ä¸Šç­æ™‚é–“
        r.action==="ä¸‹ç­" ? time : "",  // F: ä¸‹ç­æ™‚é–“
        gpsText,  // G: GPS
        distVal,  // H: è·å…¬å¸(m)
        leave ? leave.type : "",  // I: ç”³è«‹é¡å‹
        leave ? (leave.start_date+" ~ "+leave.end_date) : "",  // J: æœŸé–“
        leave ? String(leave.reason||"").replace(/\n/g," ") : "",  // K: è©³ç´°
        statusText,  // L: ç‹€æ…‹
        commentText  // M: ä¸»ç®¡è¨»è§£
      ]
    });
  });

  // 2) åªæœ‰ç”³è«‹ï¼ˆæ²’æ‰“å¡ï¼‰
  const shownLeaveIds = new Set();
  const shownPunch = new Set();
  records.forEach(r=>{
    const date = r.created_at_tw?.slice(0,10);
    if(!date) return;
    shownPunch.add(r.name+"_"+date+"_ä¸Šç­");
    shownPunch.add(r.name+"_"+date+"_ä¸‹ç­");
  });

  leaves.forEach(l=>{
    if(shownLeaveIds.has(l.id)) return;
    shownLeaveIds.add(l.id);

    // æ’¤å›ä¸åŒ¯å‡º
    if(l.withdrawn === 1) return;

    let cur = l.start_date;
    while(cur <= l.end_date){
      if(month && !cur.startsWith(month)){
        cur = nextDateStr(cur);
        continue;
      }

      const keyIn  = l.name + "_" + cur + "_ä¸Šç­";
      const keyOut = l.name + "_" + cur + "_ä¸‹ç­";

      if(!shownPunch.has(keyIn) && !shownPunch.has(keyOut)){
        const w = weekdayInfo(cur);

        rowsAll.push({
          date: cur,
          sortTime: cur + "T23:59:59", // ç”³è«‹æ”¾åœ¨ç•¶å¤©æœ€å¾Œ
          data: [
            cur,  // A: æ—¥æœŸ
            (w.isHoliday ? "åœ‹å®šå‡æ—¥" : w.label) + (w.holidayName ? "ï½œ"+w.holidayName : ""),  // B: æ˜ŸæœŸ
            l.name,  // C: å§“å
            "ç”³è«‹",  // D: é¡å‹
            "",  // E: ä¸Šç­æ™‚é–“
            "",  // F: ä¸‹ç­æ™‚é–“
            "",  // G: GPS
            "",  // H: è·å…¬å¸(m)
            l.type,  // I: ç”³è«‹é¡å‹
            l.start_date+" ~ "+l.end_date,  // J: æœŸé–“
            String(l.reason||"").replace(/\n/g," "),  // K: è©³ç´°
            (l.approved===1 ? "å·²æ ¸å‡†" : "å¯©æ ¸ä¸­"),  // L: ç‹€æ…‹
            (l.comment || "")  // M: ä¸»ç®¡è¨»è§£
          ]
        });
        break;
      }

      cur = nextDateStr(cur);
    }
  });

  // æ’åºï¼šæœ€æ–°åœ¨ä¸Š
  rowsAll.sort((a, b) => b.sortTime.localeCompare(a.sortTime));

  // ä¾å§“ååˆ†çµ„
  const people = {};
  rowsAll.forEach(row=>{
    const name = row.data[2] || "æœªå‘½å";
    if(!people[name]) people[name] = [];
    people[name].push(row);
  });

  // æ¯äºº Sheet - ä¿®æ­£æ¬„ä½é †åºï¼ŒåŠ å…¥æ—¥æœŸåˆ†çµ„ç©ºè¡Œ
  const header = [
    "æ—¥æœŸ", "æ˜ŸæœŸ", "å§“å", "é¡å‹", 
    "ä¸Šç­", "ä¸‹ç­", "GPS", "è·å…¬å¸(m)", 
    "ç”³è«‹é¡å‹", "æœŸé–“", "è©³ç´°", "ç‹€æ…‹", "ä¸»ç®¡è¨»è§£"
  ];

  Object.keys(people).forEach(name=>{
    const rowsForPerson = people[name];
    
    // æŒ‰æ—¥æœŸåˆ†çµ„
    const rowsByDate = {};
    let lastDate = "";
    
    rowsForPerson.forEach(row => {
      const date = row.date;
      if (!rowsByDate[date]) {
        rowsByDate[date] = [];
      }
      rowsByDate[date].push(row);
    });
    
    // å»ºç«‹å¸¶æœ‰ç©ºè¡Œçš„è³‡æ–™é™£åˆ—
    const aoa = [header];
    const dates = Object.keys(rowsByDate).sort().reverse(); // æ—¥æœŸå¾æ–°åˆ°èˆŠ
    
    dates.forEach((date, dateIndex) => {
      const dateRows = rowsByDate[date];
      
      // æŒ‰æ™‚é–“æ’åºï¼šä¸Šç­åœ¨å‰ï¼Œä¸‹ç­åœ¨å¾Œï¼Œç”³è«‹åœ¨æœ€å¾Œ
      dateRows.sort((a, b) => {
        // ä¸Šç­å„ªå…ˆæ–¼ä¸‹ç­å„ªå…ˆæ–¼ç”³è«‹
        const typeOrder = { "ä¸Šç­": 1, "ä¸‹ç­": 2, "ç”³è«‹": 3 };
        const aType = a.data[3];
        const bType = b.data[3];
        
        if (typeOrder[aType] !== typeOrder[bType]) {
          return typeOrder[aType] - typeOrder[bType];
        }
        
        // åŒé¡å‹æŒ‰æ™‚é–“æ’åº
        return a.sortTime.localeCompare(b.sortTime);
      });
      
      // åŠ å…¥è©²æ—¥æœŸçš„æ‰€æœ‰è³‡æ–™
      dateRows.forEach(row => {
        aoa.push(row.data);
      });
      
      // å¦‚æœä¸æ˜¯æœ€å¾Œä¸€å€‹æ—¥æœŸï¼ŒåŠ å…¥ç©ºè¡Œ
      if (dateIndex < dates.length - 1) {
        aoa.push(Array(13).fill("")); // 13å€‹æ¬„ä½çš„ç©ºè¡Œ
      }
    });
    
    const ws = XLSX.utils.aoa_to_sheet(aoa);
    
    // ä¿®æ­£æ¬„å¯¬è¨­å®š
    ws["!cols"] = [
      {wch:12},  // A: æ—¥æœŸ
      {wch:18},  // B: æ˜ŸæœŸ
      {wch:10},  // C: å§“å
      {wch:8},   // D: é¡å‹ï¼ˆä¸Šç­/ä¸‹ç­/ç”³è«‹ï¼‰
      {wch:10},  // E: ä¸Šç­æ™‚é–“
      {wch:10},  // F: ä¸‹ç­æ™‚é–“
      {wch:24},  // G: GPSï¼ˆåŠ å¯¬é¡¯ç¤ºåº§æ¨™ï¼‰
      {wch:12},  // H: è·å…¬å¸(m)
      {wch:10},  // I: ç”³è«‹é¡å‹
      {wch:22},  // J: æœŸé–“
      {wch:34},  // K: è©³ç´°
      {wch:10},  // L: ç‹€æ…‹
      {wch:24}   // M: ä¸»ç®¡è¨»è§£
    ];
    
    // è¨­å®šæ ¼å¼ï¼ˆåŒ…å«æ—¥æœŸåˆ†çµ„èƒŒæ™¯è‰²ï¼‰
    let currentRow = 2; // å¾ç¬¬2è¡Œé–‹å§‹ï¼ˆç¬¬1è¡Œæ˜¯æ¨™é¡Œï¼‰
    
    dates.forEach((date, dateIndex) => {
      const dateRows = rowsByDate[date];
      const dateRowCount = dateRows.length;
      
      // ç‚ºè©²æ—¥æœŸåˆ†çµ„è¨­å®šèƒŒæ™¯è‰²
      for (let i = 0; i < dateRowCount; i++) {
        const rowNum = currentRow + i;
        const isEvenRow = rowNum % 2 === 0;
        
        // è¨­å®šæ•´è¡ŒèƒŒæ™¯è‰²ï¼ˆæ·ºç°è‰²ï¼‰
        const columns = ["A","B","C","D","E","F","G","H","I","J","K","L","M"];
        columns.forEach(col => {
          const cellRef = col + rowNum;
          const cell = ws[cellRef];
          if(!cell) return;
          
          if(!cell.s) cell.s = {};
          if(!cell.s.fill) cell.s.fill = {};
          if(!cell.s.fill.fgColor) cell.s.fill.fgColor = {};
          
          // å¥‡æ•¸è¡Œæ·ºç°è‰²ï¼Œå¶æ•¸è¡Œç™½è‰²
          cell.s.fill.fgColor.rgb = isEvenRow ? "F8F9FA" : "FFFFFF";
        });
        
        // æ—¥æœŸæ¬„ä½ç‰¹æ®Šæ ¼å¼ï¼ˆç¬¬ä¸€è¡Œé¡¯ç¤ºå®Œæ•´æ—¥æœŸï¼Œå…¶ä»–è¡Œç•™ç©ºï¼‰
        const dateCell = ws["A" + rowNum];
        if (dateCell && i > 0) {
          // åŒä¸€æ—¥æœŸçš„å¾ŒçºŒè¡Œï¼Œæ—¥æœŸæ¬„ä½ç•™ç©º
          dateCell.v = "";
        }
      }
      
      currentRow += dateRowCount;
      
      // å¦‚æœä¸æ˜¯æœ€å¾Œä¸€å€‹æ—¥æœŸï¼Œè·³éç©ºè¡Œ
      if (dateIndex < dates.length - 1) {
        currentRow += 1; // ç©ºè¡Œ
      }
    });
    
    // è¨­å®šç‰¹æ®Šæ ¼å¼
    for(let i = 2; i <= aoa.length; i++){
      const dateStr = aoa[i-1][0];
      if(!dateStr) continue;
      
      const d = new Date(dateStr);
      const isWeekend = d.getDay() === 0 || d.getDay() === 6;
      const holiday = HOLIDAY_RANGES.some(h => dateStr >= h.start && dateStr <= h.end);
      
      // ç‰¹æ®Šæ—¥æœŸçš„é¡è‰²ï¼ˆè¦†è“‹åˆ†çµ„é¡è‰²ï¼‰
      if(holiday || isWeekend){
        const columns = ["A","B","C","D","E","F","G","H","I","J","K","L","M"];
        columns.forEach(col => {
          const cellRef = col + i;
          const cell = ws[cellRef];
          if(!cell || !cell.v) return;
          
          if(!cell.s) cell.s = {};
          if(!cell.s.fill) cell.s.fill = {};
          if(!cell.s.fill.fgColor) cell.s.fill.fgColor = {};
          
          if(holiday){
            cell.s.fill.fgColor.rgb = "FFF4CC"; // åœ‹å®šå‡æ—¥é»ƒè‰²
          }else if(isWeekend){
            cell.s.fill.fgColor.rgb = "FFECEC"; // é€±æœ«æ·ºç´…è‰²
          }
        });
      }
      
      // è·é›¢æ¬„ä½ç‰¹æ®Šè™•ç† - åªè™•ç†Hæ¬„
      const distCell = ws["H"+i];
      if(distCell && !isNaN(Number(distCell.v)) && Number(distCell.v) > 35){
        if(!distCell.s) distCell.s = {};
        if(!distCell.s.fill) distCell.s.fill = {};
        if(!distCell.s.fill.fgColor) distCell.s.fill.fgColor = {};
        distCell.s.fill.fgColor.rgb = "C0392B"; // ç´…è‰²
        
        if(!distCell.s.font) distCell.s.font = {};
        distCell.s.font.color = { rgb: "FFFFFF" }; // ç™½è‰²å­—
        distCell.s.font.bold = true;
      }
      
      // ç”³è«‹é¡å‹çš„ç‰¹æ®Šè™•ç†ï¼ˆè£œä¿®ã€ç‰¹ä¼‘ç­‰ï¼‰
      const leaveTypeCell = ws["I"+i];
      if(leaveTypeCell && leaveTypeCell.v){
        const type = String(leaveTypeCell.v);
        if(type === "å‡ºå·®"){
          leaveTypeCell.s = leaveTypeCell.s || {};
          leaveTypeCell.s.font = leaveTypeCell.s.font || {};
          leaveTypeCell.s.font.color = { rgb: "27AE60" }; // ç¶ è‰²
        }else if(type === "åŠ ç­"){
          leaveTypeCell.s = leaveTypeCell.s || {};
          leaveTypeCell.s.font = leaveTypeCell.s.font || {};
          leaveTypeCell.s.font.color = { rgb: "2980B9" }; // è—è‰²
        }
      }
    }

    XLSX.utils.book_append_sheet(wb, ws, name.substring(0,31));
  });

  // Daily Summaryï¼ˆä¹ŸåŠ å…¥æ—¥æœŸåˆ†çµ„ï¼‰
  const summary = {};
  rowsAll.forEach(row=>{
    const r = row.data;
    const date = r[0];
    const name = r[2];
    const type = r[3];
    const inTime = r[4];
    const outTime = r[5];
    const dist = Number(r[7]) || 0;

    const key = date + "_" + name;
    if(!summary[key]) summary[key] = {date,name,earliest:"",latest:"",maxDist:0};

    if(type==="ä¸Šç­" && inTime){
      if(!summary[key].earliest || inTime < summary[key].earliest) summary[key].earliest = inTime;
    }
    if(type==="ä¸‹ç­" && outTime){
      if(!summary[key].latest || outTime > summary[key].latest) summary[key].latest = outTime;
    }
    summary[key].maxDist = Math.max(summary[key].maxDist, dist);
  });

  // å°‡ summary è½‰ç‚ºé™£åˆ—ä¸¦æŒ‰æ—¥æœŸåˆ†çµ„
  const summaryArray = Object.values(summary);
  summaryArray.sort((a, b) => b.date.localeCompare(a.date));
  
  // æŒ‰æ—¥æœŸåˆ†çµ„
  const summaryByDate = {};
  summaryArray.forEach(item => {
    const date = item.date;
    if (!summaryByDate[date]) {
      summaryByDate[date] = [];
    }
    summaryByDate[date].push(item);
  });
  
  const dates = Object.keys(summaryByDate).sort().reverse();
  const sumAoa = [["æ—¥æœŸ","å§“å","æœ€æ—©ä¸Šç­","æœ€æ™šä¸‹ç­","æœ€é è·é›¢(m)"]];
  
  dates.forEach((date, dateIndex) => {
    const dateSummaries = summaryByDate[date];
    
    // æŒ‰å§“åæ’åº
    dateSummaries.sort((a, b) => a.name.localeCompare(b.name));
    
    dateSummaries.forEach(item => {
      sumAoa.push([item.date, item.name, item.earliest, item.latest, item.maxDist]);
    });
    
    // å¦‚æœä¸æ˜¯æœ€å¾Œä¸€å€‹æ—¥æœŸï¼ŒåŠ å…¥ç©ºè¡Œ
    if (dateIndex < dates.length - 1) {
      sumAoa.push(Array(5).fill("")); // 5å€‹æ¬„ä½çš„ç©ºè¡Œ
    }
  });

  const wsSum = XLSX.utils.aoa_to_sheet(sumAoa);
  wsSum["!cols"] = [{wch:12},{wch:10},{wch:10},{wch:10},{wch:14}];
  
  // è¨­å®šæ—¥æœŸåˆ†çµ„é¡è‰²
  let currentRow = 2;
  dates.forEach((date, dateIndex) => {
    const dateSummaries = summaryByDate[date];
    const dateRowCount = dateSummaries.length;
    
    for (let i = 0; i < dateRowCount; i++) {
      const rowNum = currentRow + i;
      const isEvenRow = rowNum % 2 === 0;
      
      // è¨­å®šæ•´è¡ŒèƒŒæ™¯è‰²
      const columns = ["A","B","C","D","E"];
      columns.forEach(col => {
        const cellRef = col + rowNum;
        const cell = wsSum[cellRef];
        if(!cell) return;
        
        if(!cell.s) cell.s = {};
        if(!cell.s.fill) cell.s.fill = {};
        if(!cell.s.fill.fgColor) cell.s.fill.fgColor = {};
        
        cell.s.fill.fgColor.rgb = isEvenRow ? "F8F9FA" : "FFFFFF";
      });
      
      // åŒä¸€æ—¥æœŸçš„å¾ŒçºŒè¡Œï¼Œæ—¥æœŸæ¬„ä½ç•™ç©º
      if (i > 0) {
        const dateCell = wsSum["A" + rowNum];
        if (dateCell) {
          dateCell.v = "";
        }
      }
    }
    
    currentRow += dateRowCount;
    
    // å¦‚æœä¸æ˜¯æœ€å¾Œä¸€å€‹æ—¥æœŸï¼Œè·³éç©ºè¡Œ
    if (dateIndex < dates.length - 1) {
      currentRow += 1;
    }
  });
  
  // Summaryçš„è·é›¢è¶…é35mæ¨™è¨˜
  for(let i = 2; i <= sumAoa.length; i++){
    const distCell = wsSum["E"+i];
    if(distCell && !isNaN(Number(distCell.v)) && Number(distCell.v) > 35){
      if(!distCell.s) distCell.s = {};
      if(!distCell.s.fill) distCell.s.fill = {};
      if(!distCell.s.fill.fgColor) distCell.s.fill.fgColor = {};
      distCell.s.fill.fgColor.rgb = "C0392B";
      
      if(!distCell.s.font) distCell.s.font = {};
      distCell.s.font.color = { rgb: "FFFFFF" };
      distCell.s.font.bold = true;
    }
  }

  XLSX.utils.book_append_sheet(wb, wsSum, "Daily Summary");

  const ym = month || "ALL";
  XLSX.writeFile(wb, `UDM_ESG_HR_${ym}.xlsx`);
}
</script>

</body>
</html>