<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>HR æ‰“å¡å¾Œå°</title>
<style>
body{font-family:system-ui;background:#f4f6f8}
.card{max-width:960px;margin:30px auto;background:#fff;padding:24px;border-radius:16px}
input,button{padding:10px;font-size:16px}
button{cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{border-bottom:1px solid #ddd;padding:8px;text-align:center}
.msg-ok{color:green;font-weight:bold}
.msg-err{color:red;font-weight:bold}
</style>
</head>
<body>

<div class="card">
<h2>ğŸ§‘â€ğŸ’¼ HR æ‰“å¡å¾Œå°</h2>

<!-- HR ç™»å…¥ -->
<div>
  HR PINï¼š
  <input id="hrPin" type="password">
  <button onclick="login()">ç™»å…¥</button>
  <span id="loginMsg"></span>
</div>

<hr>

<!-- Reset PIN -->
<div>
  ğŸ” Reset å“¡å·¥é€²å…¥ PINï¼š
  <input id="newPin" type="password" placeholder="æ–° PIN">
  <button onclick="setPin()">è¨­å®š</button>
  <span id="pinMsg"></span>
</div>

<hr>

<button onclick="loadData()">é‡æ–°è¼‰å…¥</button>
<button onclick="exportExcel()">åŒ¯å‡º Excel</button>

<table>
<thead>
<tr>
  <th>å§“å</th>
  <th>å‹•ä½œ</th>
  <th>è·é›¢(m)</th>
  <th>æ—¥æœŸ</th>
  <th>æ˜ŸæœŸ</th>
  <th>æ™‚é–“</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<script>
const API = "https://punch-api.jackey1688.workers.dev";
let loggedIn = false;

function login(){
  if(document.getElementById("hrPin").value === "1234"){
    loggedIn = true;
    loginMsg.innerHTML = "âœ… ç™»å…¥æˆåŠŸ";
    loginMsg.className = "msg-ok";
    loadData();
  }else{
    loginMsg.innerHTML = "âŒ PIN éŒ¯èª¤";
    loginMsg.className = "msg-err";
  }
}

async function setPin(){
  if(!loggedIn) return alert("è«‹å…ˆç™»å…¥");

  const res = await fetch(API + "/api/hr/set-pin",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      hr_pin: document.getElementById("hrPin").value,
      new_pin: document.getElementById("newPin").value
    })
  });

  const r = await res.json();
  pinMsg.innerHTML = r.ok ? "âœ… è¨­å®šæˆåŠŸ" : "âŒ ç³»çµ±éŒ¯èª¤";
  pinMsg.className = r.ok ? "msg-ok" : "msg-err";
}

async function loadData(){
  const res = await fetch(API + "/api/admin/attendance");
  const data = await res.json();
  const tb = document.getElementById("tbody");
  tb.innerHTML = "";

  data.forEach(d=>{
    const dt = new Date(d.time);
    const week = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][dt.getDay()];
    tb.innerHTML += `
      <tr>
        <td>${d.name}</td>
        <td>${d.action}</td>
        <td>${d.distance ?? ""}</td>
        <td>${dt.toLocaleDateString()}</td>
        <td>é€±${week}</td>
        <td>${dt.toLocaleTimeString()}</td>
      </tr>`;
  });
}

function exportExcel(){
  let csv = "å§“å,å‹•ä½œ,è·é›¢,æ—¥æœŸ,æ˜ŸæœŸ,æ™‚é–“\n";
  document.querySelectorAll("#tbody tr").forEach(r=>{
    csv += [...r.children].map(td=>td.innerText).join(",") + "\n";
  });
  const blob = new Blob(["\uFEFF"+csv],{type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "attendance.xlsx";
  a.click();
}
</script>
</body>
</html>
