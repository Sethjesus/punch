<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UDM ESGï½œäººè³‡ä¸Šç­è«‹å‡ç³»çµ±</title>

<style>
:root{
  --bg:#2f2f3a;
  --card:#f4f6f8;
  --header:#1f2937;
}
body{margin:0;background:var(--bg);font-family:system-ui}
header{
  background:var(--header);
  color:#fff;
  padding:14px;
  text-align:center;
}
header h1{margin:0;font-size:20px}
header div{font-size:13px;opacity:.85}

.container{
  max-width:1600px;
  margin:20px auto;
  background:var(--card);
  border-radius:12px;
  padding:16px;
}
.toolbar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  margin-bottom:10px;
}
button{
  padding:6px 12px;
  border:0;
  border-radius:8px;
  cursor:pointer;
}
.primary{background:#3498db;color:#fff}
.excel{background:#27ae60;color:#fff}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
th,td{
  border-bottom:1px solid #d1d5db;
  padding:6px;
  text-align:center;
}
th{
  background:#e5e7eb;
  position:sticky;
  top:0;
  z-index:1;
}

/* è¡Œåˆ¥æ¨£å¼ */
.leaveOnly{background:#fff4cc}
.tripRow{background:#e8ffe8}
.otRow{background:#eaf4ff}

/* é€±æœ« / åœ‹å®šé€£å‡ */
.weekendRow{ background:#ffecec }
.weekendText{ color:#c0392b; font-weight:bold }
.holidayRow{ background:#fff8d6 }
.holidayText{ color:#d35400; font-weight:bold }

.red{color:#c0392b;font-weight:bold}

/* Login */
.loginMask{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10;
}
.loginBox{
  background:#fff;
  padding:20px;
  border-radius:12px;
  width:260px;
  text-align:center;
}
.loginBox input{
  width:100%;
  padding:8px;
  margin:8px 0;
}
</style>
</head>

<body>

<!-- ğŸ” Login -->
<div class="loginMask" id="loginMask">
  <div class="loginBox">
    <h3>HR Login</h3>
    <input type="password" id="pwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
    <button class="primary" onclick="login()">ç™»å…¥</button>
  </div>
</div>

<header>
  <h1>UDM ESG</h1>
  <div>äººè³‡ä¸Šç­è«‹å‡ç³»çµ±</div>
</header>

<div class="container">
  <div class="toolbar">
    ğŸ“… æœˆä»½ï¼š
    <input type="month" id="monthPicker">
    <button class="primary" onclick="drawTable()">é‡æ–°æ•´ç†</button>
    <button class="excel" onclick="exportExcel()">åŒ¯å‡º Excel</button>
  </div>

  <table id="tbl"></table>
</div>

<script>
/* ===== Login ===== */
function login(){
  if(document.getElementById("pwd").value==="1234"){
    document.getElementById("loginMask").style.display="none";
  }else alert("å¯†ç¢¼éŒ¯èª¤");
}

/* ===== API ===== */
const API_ATT="https://punch-api.jackey1688.workers.dev/api/records";
const API_LEAVE="https://punch-api.jackey1688.workers.dev/api/leave";
const API_APP="https://punch-api.jackey1688.workers.dev/api/leave/approve";

/* ===== å…¬å¸åº§æ¨™ ===== */
const COMPANY_LAT=25.00657;
const COMPANY_LNG=121.48416;

/* ===== 2026 åœ‹å®šé€£å‡ï¼ˆå€é–“ï¼‰===== */
const HOLIDAY_RANGES = [
  { start:"2026-02-14", end:"2026-02-22", name:"è¾²æ›†æ˜¥ç¯€é€£å‡" },
  { start:"2026-02-27", end:"2026-03-01", name:"228é€£å‡" },
  { start:"2026-04-03", end:"2026-04-06", name:"æ¸…æ˜ç¯€é€£å‡" },
  { start:"2026-05-01", end:"2026-05-03", name:"å‹å‹•ç¯€é€£å‡" },
  { start:"2026-06-19", end:"2026-06-21", name:"ç«¯åˆç¯€é€£å‡" },
  { start:"2026-09-25", end:"2026-09-28", name:"ä¸­ç§‹ / æ•™å¸«ç¯€é€£å‡" },
  { start:"2026-10-09", end:"2026-10-11", name:"åœ‹æ…¶æ—¥é€£å‡" },
  { start:"2026-10-24", end:"2026-10-26", name:"å…‰å¾©ç¯€é€£å‡" },
  { start:"2026-12-25", end:"2026-12-27", name:"è¡Œæ†²ç´€å¿µæ—¥é€£å‡" }
];

let records=[],leaves=[];
const tbl=document.getElementById("tbl");
const mp=document.getElementById("monthPicker");
mp.value=new Date().toISOString().slice(0,7);

/* ===== Utils ===== */
function distanceMeter(lat1,lng1,lat2,lng2){
  const R=6371000;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLng=(lng2-lng1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
    Math.sin(dLng/2)**2;
  return Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

function parseDetail(r){
  if(!r) return "";
  return r.replace(/\n/g,"<br>")
    .replace(/ã€åŠ ç­ã€‘/g,"<b style=color:#2980b9>ã€åŠ ç­ã€‘</b>")
    .replace(/ã€å‡ºå·®ã€‘/g,"<b style=color:#27ae60>ã€å‡ºå·®ã€‘</b>");
}

function weekdayInfo(dateStr){
  const d = new Date(dateStr);
  const day = d.getDay(); // 0 æ—¥, 6 å…­
  const isWeekend = day === 0 || day === 6;

  let holidayName = "";
  for(const h of HOLIDAY_RANGES){
    if(dateStr >= h.start && dateStr <= h.end){
      holidayName = h.name;
      break;
    }
  }

  let label;
  if(holidayName){
    label = "åœ‹å®šå‡æ—¥";
  }else{
    const map = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
    label = "é€±" + map[day];
  }

  return {
    label,
    isWeekend,
    isHoliday: !!holidayName,
    holidayName
  };
}

/* ===== Load ===== */
async function load(){
  records=await (await fetch(API_ATT)).json();
  leaves=await (await fetch(API_LEAVE)).json();
  drawTable();
}
load();

/* ===== Draw ===== */
function drawTable(){
  let month=mp.value||"";
  let html=`
  <tr>
    <th>æ—¥æœŸ</th>
    <th>æ˜ŸæœŸ</th>
    <th>å§“å</th>
    <th>é¡å‹</th>
    <th>ä¸Šç­</th>
    <th>ä¸‹ç­</th>
    <th>GPS</th>
    <th>è·å…¬å¸(m)</th>
    <th>ç”³è«‹é¡å‹</th>
    <th>æœŸé–“</th>
    <th>è©³ç´°</th>
    <th>æ ¸å‡†</th>
  </tr>`;
  const shown=new Set();

  /* ===== æ‰“å¡ ===== */
  records.forEach(r=>{
    const date=r.created_at_tw?.slice(0,10);
    if(!date) return;
    if(month && !date.startsWith(month)) return;

    const w=weekdayInfo(date);
    const rowCls = w.isHoliday ? "holidayRow" : w.isWeekend ? "weekendRow" : "";
    const textCls = w.isHoliday ? "holidayText" : w.isWeekend ? "weekendText" : "";

    const time=r.created_at_tw.slice(11,19);
    const key=r.name+"_"+date;
    shown.add(key);

    const leave=leaves.find(l=>l.name===r.name &&
      date>=l.start_date && date<=l.end_date);

    let dist="",gps="";
    if(r.lat&&r.lng){
      dist=distanceMeter(COMPANY_LAT,COMPANY_LNG,r.lat,r.lng);
      gps=`<a target="_blank" href="https://maps.google.com/?q=${r.lat},${r.lng}">
        ${r.lat.toFixed(5)},${r.lng.toFixed(5)}</a>`;
    }

    html+=`
    <tr class="${rowCls}">
      <td>${date}</td>
      <td class="${textCls}">${w.label}</td>
      <td>${r.name}</td>
      <td>${r.action}</td>
      <td>${r.action==="ä¸Šç­"?time:""}</td>
      <td>${r.action==="ä¸‹ç­"?time:""}</td>
      <td>${gps}</td>
      <td class="${dist>200?'red':''}">${dist||""}</td>
      <td>${leave?leave.type:""}</td>
      <td>${leave?leave.start_date+" ~ "+leave.end_date:""}</td>
      <td>${leave?parseDetail(leave.reason):""}</td>
      <td>${leave?`<input type="checkbox" ${leave.approved?"checked":""}
        onchange="fetch(API_APP,{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({id:${leave.id},approved:this.checked?1:0})})">`:""}</td>
    </tr>`;
  });

  /* ===== åªæœ‰ç”³è«‹ï¼ˆæ²’æ‰“å¡ï¼‰===== */
  leaves.forEach(l=>{
    let cur=l.start_date;
    while(cur<=l.end_date){
      if(month && !cur.startsWith(month)){
        cur=new Date(new Date(cur).getTime()+86400000).toISOString().slice(0,10);
        continue;
      }
      const key=l.name+"_"+cur;
      if(!shown.has(key)){
        const w=weekdayInfo(cur);
        const baseCls=l.type==="å‡ºå·®"?"tripRow":l.type==="åŠ ç­"?"otRow":"leaveOnly";
        const rowCls = w.isHoliday ? "holidayRow" : w.isWeekend ? "weekendRow" : baseCls;
        const textCls = w.isHoliday ? "holidayText" : w.isWeekend ? "weekendText" : "";

        html+=`
        <tr class="${rowCls}">
          <td>${cur}</td>
          <td class="${textCls}">${w.label}</td>
          <td>${l.name}</td>
          <td>ç”³è«‹</td>
          <td></td><td></td><td></td><td></td>
          <td>${l.type}</td>
          <td>${l.start_date} ~ ${l.end_date}</td>
          <td>${parseDetail(l.reason)}</td>
          <td><input type="checkbox" ${l.approved?"checked":""}
            onchange="fetch(API_APP,{method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({id:${l.id},approved:this.checked?1:0})})"></td>
        </tr>`;
      }
      cur=new Date(new Date(cur).getTime()+86400000).toISOString().slice(0,10);
    }
  });

  tbl.innerHTML=html;
}

/* ===== Excel ===== */
function exportExcel(){
  let csv="UDM ESG\näººè³‡ä¸Šç­è«‹å‡ç³»çµ±\n\næ—¥æœŸ,æ˜ŸæœŸ,å§“å,é¡å‹,ä¸Šç­,ä¸‹ç­,ç”³è«‹é¡å‹,æœŸé–“,è©³ç´°\n";
  document.querySelectorAll("#tbl tr").forEach((r,i)=>{
    if(i===0) return;
    const c=[...r.children].map(td=>td.innerText.replace(/\n/g," "));
    csv+=c.slice(0,9).join(",")+"\n";
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="UDM_ESG_HR_2026.csv";
  a.click();
}
</script>

</body>
</html>
