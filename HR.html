<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HR æ‰“å¡å¾Œå°</title>

<style>
body{
  font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
  background:#f3f4f6;
}
.container{
  max-width:1100px;
  margin:32px auto;
  background:#fff;
  padding:24px;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.12);
}
h2{margin:0 0 12px}
.toolbar{
  display:flex;
  gap:12px;
  flex-wrap:wrap;
  align-items:center;
  margin-bottom:12px;
}
.toolbar button{
  padding:10px 14px;
  border:none;
  border-radius:10px;
  background:#2563eb;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
.toolbar .hint{
  font-size:13px;color:#555
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
th,td{
  padding:10px;
  border-bottom:1px solid #e5e7eb;
  text-align:left;
}
th{
  background:#f9fafb;
  position:sticky;
  top:0;
  z-index:1;
}
.bad{
  color:#b91c1c;
  font-weight:700;
}
.ok{
  color:#166534;
}
.muted{
  color:#6b7280;
}
.footer{
  margin-top:10px;
  font-size:12px;
  color:#6b7280;
}
</style>
</head>

<body>
<div class="container">
  <h2>ğŸ“‹ HR æ‰“å¡å¾Œå°</h2>

  <div class="toolbar">
    <button onclick="exportCSV()">â¬‡ åŒ¯å‡º CSV</button>
    <span class="hint">è·é›¢è¶…é <b id="thTxt">100</b> å…¬å°ºæœƒæ¨™ç´…</span>
  </div>

  <table>
    <thead>
      <tr>
        <th>å·¥è™Ÿ</th>
        <th>å§“å</th>
        <th>å‹•ä½œ</th>
        <th>è·é›¢ (m)</th>
        <th>æ™‚é–“</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="footer">è³‡æ–™ä¾†æºï¼šCloudflare Workers KV</div>
</div>

<script>
/* ===== HR APIï¼ˆè«‹ç¢ºèªè·¯å¾‘ï¼‰===== */
const ADMIN_API = "https://punch-api.jackey1688.workers.dev/api/admin/attendance";

/* ===== è·é›¢é–€æª»ï¼ˆå¯è‡ªè¡Œèª¿æ•´ï¼‰===== */
const DIST_LIMIT = 100; // å…¬å°º

let DATA = [];

fetch(ADMIN_API)
  .then(r => r.json())
  .then(list => {
    DATA = list || [];
    render(DATA);
  })
  .catch(() => {
    document.getElementById("tbody").innerHTML =
      `<tr><td colspan="5" class="muted">ç„¡æ³•è®€å–è³‡æ–™</td></tr>`;
  });

function render(rows){
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  rows.forEach(r => {
    const isLeave = r.distance === null;
    const isBad = !isLeave && r.distance > DIST_LIMIT;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.emp_id}</td>
      <td>${r.name}</td>
      <td>${r.action}</td>
      <td class="${isLeave ? 'muted' : (isBad ? 'bad' : 'ok')}">
        ${isLeave ? "â€”" : r.distance}
      </td>
      <td>${new Date(r.time).toLocaleString()}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("thTxt").innerText = DIST_LIMIT;
}

function exportCSV(){
  let csv = "å·¥è™Ÿ,å§“å,å‹•ä½œ,è·é›¢(m),æ™‚é–“\n";
  DATA.forEach(r => {
    csv += `${r.emp_id},${r.name},${r.action},${r.distance ?? ""},${r.time}\n`;
  });

  const blob = new Blob([csv], { type:"text/csv;charset=utf-8;" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "attendance.csv";
  a.click();
}
</script>
</body>
</html>
