<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>HR æ‰“å¡å¾Œå°</title>
<style>
body{font-family:sans-serif;background:#f5f5f5}
.card{max-width:1100px;margin:30px auto;background:#fff;padding:20px;border-radius:12px}
input,button{padding:8px;margin-right:6px}
table{width:100%;border-collapse:collapse;margin-top:16px}
th,td{border-bottom:1px solid #ddd;padding:8px;text-align:center}
th{background:#f0f0f0}
</style>
</head>
<body>

<div class="card">
  <h2>ğŸ“‹ HR æ‰“å¡å¾Œå°</h2>

  å·¥è™Ÿ <input id="empId">
  å§“å <input id="name">
  <button onclick="loadData()">æŸ¥è©¢</button>
  <button onclick="exportExcel()">åŒ¯å‡º Excel</button>

  <table>
    <thead>
      <tr>
        <th>å·¥è™Ÿ</th>
        <th>å§“å</th>
        <th>å‹•ä½œ</th>
        <th>è·é›¢(m)</th>
        <th>æ—¥æœŸ</th>
        <th>æ˜ŸæœŸ</th>
        <th>æ™‚é–“</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
const WORKER_URL = "https://ä½ çš„-worker.workers.dev";

let cache = [];

function loadData(){
  const empId = document.getElementById("empId").value;
  const name = document.getElementById("name").value;

  const qs = new URLSearchParams({ emp_id: empId, name }).toString();

  fetch(`${WORKER_URL}/api/admin/attendance?${qs}`)
    .then(r => r.json())
    .then(data => {
      cache = data;
      render(data);
    });
}

function render(data){
  const tb = document.getElementById("tbody");
  tb.innerHTML = "";

  data.forEach(r => {
    const d = new Date(r.time);
    tb.innerHTML += `
      <tr>
        <td>${r.emp_id}</td>
        <td>${r.name}</td>
        <td>${r.action}</td>
        <td>${r.distance ?? ""}</td>
        <td>${d.toLocaleDateString()}</td>
        <td>${["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][d.getDay()]}</td>
        <td>${d.toLocaleTimeString()}</td>
      </tr>`;
  });
}

function exportExcel(){
  let csv = "å·¥è™Ÿ,å§“å,å‹•ä½œ,è·é›¢,æ—¥æœŸ,æ˜ŸæœŸ,æ™‚é–“\n";

  cache.forEach(r=>{
    const d = new Date(r.time);
    csv += [
      r.emp_id,
      r.name,
      r.action,
      r.distance ?? "",
      d.toLocaleDateString(),
      ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][d.getDay()],
      d.toLocaleTimeString()
    ].join(",") + "\n";
  });

  const blob = new Blob([csv],{type:"application/vnd.ms-excel"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "attendance.xls";
  a.click();
}
</script>

</body>
</html>
