<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å“¡å·¥æ‰“å¡</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{font-family:system-ui;background:#f4f6f8}
.card{max-width:420px;margin:40px auto;background:#fff;padding:20px;border-radius:8px}
input,select,button{width:100%;padding:10px;margin:6px 0}
button{background:#1e88e5;color:#fff;border:none;border-radius:4px;font-size:16px}
#result{margin-top:12px;font-weight:bold}
.ok{color:green}
.bad{color:red}
.gray{color:#666}
</style>
</head>
<body>

<div class="card">
  <h2>å“¡å·¥æ‰“å¡</h2>

  <input id="name" placeholder="è«‹è¼¸å…¥å§“å">
  <select id="action">
    <option value="in">ä¸Šç­</option>
    <option value="out">ä¸‹ç­</option>
  </select>

  <div id="gps" class="gray">GPS å–å¾—ä¸­â€¦</div>

  <button onclick="punch()">æ‰“å¡</button>

  <div id="result"></div>
</div>

<script>
const API = "https://punch-api.jackey1688.workers.dev";
let lat=null, lng=null;

/* å–å¾— GPS */
if (navigator.geolocation) {
  navigator.geolocation.getCurrentPosition(
    p=>{
      lat=p.coords.latitude;
      lng=p.coords.longitude;
      gps.innerText=`GPS OKï¼š${lat.toFixed(5)}, ${lng.toFixed(5)}`;
    },
    ()=>{
      gps.innerText="GPS å¤±æ•—ï¼ˆä»å¯æ‰“å¡ï¼‰";
    }
  );
}else{
  gps.innerText="è£ç½®ä¸æ”¯æ´ GPS";
}

/* æ‰“å¡ */
async function punch(){
  result.innerText="é€å‡ºä¸­â€¦";
  result.className="gray";

  const payload={
    name: name.value.trim(),
    action: action.value,
    lat, lng
  };

  try{
    const r = await fetch(API+"/api/punch",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });

    const j = await r.json();

    if(!j.ok){
      result.innerText="âŒ å¤±æ•—ï¼š"+j.error;
      result.className="bad";
      return;
    }

    /* === Aï¼šä¸€å®šé¡¯ç¤ºæˆåŠŸ === */
    let msg = `âœ… æ‰“å¡æˆåŠŸ\nğŸ•’ ${new Date(j.time).toLocaleString()}`;

    /* === Cï¼šè·é›¢åˆ¤æ–· === */
    if(j.distance == null){
      msg += `\nâš  GPS ç„¡è³‡æ–™`;
      result.className="bad";
    }else{
      msg += `\nğŸ“ è·é›¢å…¬å¸ ${j.distance} å…¬å°º`;
      if(j.max && j.distance > j.max){
        msg += `\nğŸš¨ è¶…å‡ºå…è¨±è·é›¢`;
        result.className="bad";
      }else{
        result.className="ok";
      }
    }

    result.innerText = msg;

  }catch(e){
    result.innerText="âŒ é€£ç·šå¤±æ•—";
    result.className="bad";
  }
}
</script>

</body>
</html>
