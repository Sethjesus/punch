<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UDM ESGï½œä¸Šç­æ‰“å¡ç³»çµ±</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#1e293b">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root{
  --bg:#0f172a;
  --card:#f8fafc;
  --primary:#2563eb;
  --success:#16a34a;
  --muted:#64748b;
}
body{
  margin:0;
  background:linear-gradient(180deg,#0f172a,#020617);
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
}
header{
  background:linear-gradient(90deg,#020617,#1e293b);
  color:#fff;
  padding:16px;
  text-align:center;
}
header h1{margin:0;font-size:20px}
header div{font-size:12px;opacity:.85}

.container{
  max-width:420px;
  margin:20px auto;
  background:var(--card);
  border-radius:18px;
  padding:18px;
  box-shadow:0 20px 40px rgba(0,0,0,.35);
}

/* ä»Šæ—¥ */
.today{text-align:center;margin-bottom:10px}
.today .date{font-size:16px;font-weight:700}
.today .week{font-size:13px;color:var(--muted)}

/* å§“å */
.nameBox{
  margin-top:6px;
  font-size:14px;
  color:#334155;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
}
.editName{
  border:0;
  background:#e5e7eb;
  border-radius:6px;
  padding:2px 6px;
  cursor:pointer;
  font-size:12px;
}

/* ç‹€æ…‹ */
.status{
  background:#eef2ff;
  padding:12px;
  border-radius:14px;
  margin-bottom:14px;
  font-size:14px;
}

/* æ‰“å¡ */
.actions{display:flex;gap:10px;margin-bottom:14px}
button{
  flex:1;
  padding:14px;
  border-radius:14px;
  border:0;
  font-size:15px;
  font-weight:700;
  cursor:pointer;
}
button:disabled{opacity:.4;cursor:not-allowed}
.btn-in{background:var(--success);color:#fff}
.btn-out{background:var(--primary);color:#fff}

/* æ¬¡åŠŸèƒ½ */
.sub{display:flex;gap:10px;flex-wrap:wrap}
.sub button{
  padding:10px;
  font-size:13px;
  background:#334155;
  color:#fff;
}

/* å®‰è£æŒ‰éµ */
#btnInstall{
  background:#f59e0b;
  color:#111827;
  font-weight:800;
}

/* Log */
.log{
  margin-top:12px;
  background:#020617;
  color:#22c55e;
  font-size:12px;
  padding:10px;
  border-radius:12px;
  height:140px;
  overflow:auto;
}

/* æé†’æ¨£å¼ */
.reminder-today {
  background:#fef3c7;
  color:#92400e;
  padding:8px 12px;
  border-radius:8px;
  margin:8px 0;
  border-left:4px solid #f59e0b;
}
.reminder-yesterday {
  background:#dbeafe;
  color:#1e40af;
  padding:8px 12px;
  border-radius:8px;
  margin:8px 0;
  border-left:4px solid #3b82f6;
}
.reminder-tomorrow {
  background:#fef9c3;
  color:#854d0e;
  padding:8px 12px;
  border-radius:8px;
  margin:8px 0;
  border-left:4px solid #f59e0b;
}
</style>
</head>

<body>

<header>
  <h1>UDM ESG</h1>
  <div>ä¸Šç­æ‰“å¡ç³»çµ±</div>
</header>

<div class="container">

  <!-- ä»Šæ—¥ -->
  <div class="today">
    <div class="date" id="todayDate"></div>
    <div class="week" id="todayWeek"></div>

    <!-- å§“å -->
    <div class="nameBox">
      ğŸ‘¤ <span id="userName"></span>
      <button class="editName" onclick="editName()">âœï¸</button>
    </div>
  </div>

  <!-- ç‹€æ…‹ -->
  <div class="status" id="statusBox">è®€å–ä»Šæ—¥ç‹€æ…‹ä¸­â€¦</div>

  <!-- æ‰“å¡ -->
  <div class="actions">
    <button id="btnIn" class="btn-in" onclick="punch('ä¸Šç­')">ä¸Šç­æ‰“å¡</button>
    <button id="btnOut" class="btn-out" onclick="punch('ä¸‹ç­')">ä¸‹ç­æ‰“å¡</button>
  </div>

  <!-- æ¬¡åŠŸèƒ½ -->
  <div class="sub">
    <button onclick="location.href='Leave.html'">ğŸ“ è«‹å‡ / å‡ºå·® / æœƒè­°</button>
    <button onclick="location.href='HR.html'">ğŸ“Š HR ç¸½è¦½</button>
    <button onclick="toggleMonthly()">ğŸ“… ç•¶æœˆæ‰“å¡ç´€éŒ„</button>
    <button id="btnInstall" style="display:none">â¬‡ ä¸‹è¼‰ App</button>
  </div>

  <!-- Log -->
  <div class="log" id="log"></div>
  <div class="log" id="monthlyBox" style="display:none"></div>
</div>

<script>
/* ===== API ===== */
const API_PUNCH = "https://punch-api.jackey1688.workers.dev/api/punch";
const API_REC = "https://punch-api.jackey1688.workers.dev/api/records";
const API_LEAVE = "https://punch-api.jackey1688.workers.dev/api/leave";

/* ===== å…¬å¸åº§æ¨™ ===== */
const COMPANY_LAT = 25.00657;
const COMPANY_LNG = 121.48416;

/* ===== äºŒæ¬¡æ©Ÿæœƒè¨­å®š ===== */
const MAX_PUNCH_PER_DAY = 2;

/* ===== æ‰“å¡å†·å»ï¼ˆ3 åˆ†é˜ï¼‰===== */
const COOLDOWN_MS = 3 * 60 * 1000; // 3 åˆ†é˜
const COOLDOWN_KEY = "lastPunchTime";

/* ===== åœ‹å®šå‡æ—¥ ===== */
const HOLIDAYS = [
  {start:"2026-02-14",end:"2026-02-22",name:"è¾²æ›†æ˜¥ç¯€"},
  {start:"2026-02-27",end:"2026-03-01",name:"228é€£å‡"},
  {start:"2026-04-03",end:"2026-04-06",name:"æ¸…æ˜é€£å‡"},
  {start:"2026-05-01",end:"2026-05-03",name:"å‹å‹•ç¯€é€£å‡"},
  {start:"2026-06-19",end:"2026-06-21",name:"ç«¯åˆé€£å‡"},
  {start:"2026-09-25",end:"2026-09-28",name:"ä¸­ç§‹/æ•™å¸«ç¯€"},
  {start:"2026-10-09",end:"2026-10-11",name:"åœ‹æ…¶é€£å‡"},
  {start:"2026-10-24",end:"2026-10-26",name:"å…‰å¾©ç¯€"},
  {start:"2026-12-25",end:"2026-12-27",name:"è¡Œæ†²ç´€å¿µæ—¥"}
];

/* ===== DOM ===== */
const logBox = document.getElementById("log");
const statusBox = document.getElementById("statusBox");
const btnIn = document.getElementById("btnIn");
const btnOut = document.getElementById("btnOut");

/* ===== å°ç£æ™‚é–“å·¥å…·å‡½æ•¸ ===== */
function getTaiwanDate() {
  // å–å¾—ç•¶å‰ UTC æ™‚é–“
  const now = new Date();
  // å°ç£æ™‚å€æ˜¯ UTC+8
  const taiwanTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
  return taiwanTime;
}

function formatTaiwanDate(date) {
  // æ ¼å¼ï¼šYYYY-MM-DD
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function formatTaiwanDateTime(date) {
  // æ ¼å¼ï¼šYYYY-MM-DD HH:MM:SS
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

/* ===== ä»Šæ—¥ ===== */
const now = getTaiwanDate();
const today = formatTaiwanDate(now);
const map = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
document.getElementById("todayDate").innerText = today;
document.getElementById("todayWeek").innerText = "é€±" + map[now.getDay()];

/* ===== å§“å ===== */
let name = localStorage.getItem("name");
if (!name) {
  name = prompt("è«‹è¼¸å…¥å§“å");
  localStorage.setItem("name", name);
}
document.getElementById("userName").innerText = name;

function editName() {
  const newName = prompt("è«‹è¼¸å…¥æ–°çš„å§“å", name);
  if (!newName) return;
  name = newName.trim();
  localStorage.setItem("name", name);
  document.getElementById("userName").innerText = name;
  log(`ğŸ‘¤ å·²åˆ‡æ›ä½¿ç”¨è€…ï¼š${name}`);
  loadStatus(); // åˆ‡æ›äººå“¡å¾Œåˆ·æ–°ç‹€æ…‹
}

/* ===== å·¥å…· ===== */
function log(t) {
  logBox.innerHTML += t + "<br>";
  logBox.scrollTop = logBox.scrollHeight;
}

function distanceMeter(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLng / 2) ** 2;
  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
}

/* ===== å†·å»å·¥å…· ===== */
function isInCooldown() {
  const t = localStorage.getItem(COOLDOWN_KEY);
  if (!t) return false;
  return Date.now() - Number(t) < COOLDOWN_MS;
}

function cooldownRemainSec() {
  const t = localStorage.getItem(COOLDOWN_KEY);
  if (!t) return 0;
  const remain = COOLDOWN_MS - (Date.now() - Number(t));
  return Math.max(0, Math.ceil(remain / 1000));
}

/* ===== å–å¾—å‡ºå·®/æœƒè­°è³‡è¨Š ===== */
async function getBusinessInfo() {
  try {
    const response = await fetch(API_LEAVE);
    if (!response.ok) {
      throw new Error(`API éŒ¯èª¤: ${response.status}`);
    }
    const list = await response.json();
    
    // ä½¿ç”¨å°ç£æ™‚é–“è¨ˆç®—æ˜¨å¤©å’Œæ˜å¤©
    const taiwanToday = getTaiwanDate();
    const taiwanDateStr = formatTaiwanDate(taiwanToday);
    
    // è¨ˆç®—æ˜¨å¤©
    const taiwanYesterday = new Date(taiwanToday);
    taiwanYesterday.setDate(taiwanYesterday.getDate() - 1);
    const yesterdayStr = formatTaiwanDate(taiwanYesterday);
    
    // è¨ˆç®—æ˜å¤©
    const taiwanTomorrow = new Date(taiwanToday);
    taiwanTomorrow.setDate(taiwanTomorrow.getDate() + 1);
    const tomorrowStr = formatTaiwanDate(taiwanTomorrow);
    
    let todayBiz = null;
    let yesterdayBiz = null;
    let tomorrowBiz = null;
    
    // éæ¿¾å‡ºç•¶å‰ä½¿ç”¨è€…çš„å·²æ ¸å‡†å‡ºå·®/æœƒè­°
    const userBiz = list.filter(item => 
      item.name === name && 
      item.approved === 1 && 
      (item.type === "å‡ºå·®" || item.type === "æœƒè­°")
    );
    
    userBiz.forEach(item => {
      const startDate = item.start_date;
      const endDate = item.end_date;
      
      // æª¢æŸ¥ä»Šå¤©æ˜¯å¦åœ¨å€é–“å…§
      if (taiwanDateStr >= startDate && taiwanDateStr <= endDate) {
        todayBiz = item;
      }
      
      // æª¢æŸ¥æ˜¨å¤©æ˜¯å¦åœ¨å€é–“å…§
      if (yesterdayStr >= startDate && yesterdayStr <= endDate) {
        yesterdayBiz = item;
      }
      
      // æª¢æŸ¥æ˜å¤©æ˜¯å¦åœ¨å€é–“å…§
      if (tomorrowStr >= startDate && tomorrowStr <= endDate) {
        tomorrowBiz = item;
      }
    });
    
    return { todayBiz, yesterdayBiz, tomorrowBiz };
  } catch (error) {
    console.error("å–å¾—å‡ºå·®/æœƒè­°è³‡è¨Šå¤±æ•—:", error);
    log(`âŒ å–å¾—å‡ºå·®/æœƒè­°è³‡è¨Šå¤±æ•—: ${error.message}`);
    return { todayBiz: null, yesterdayBiz: null, tomorrowBiz: null };
  }
}

/* ===== ç‹€æ…‹ï¼ˆå«æ¬¡æ•¸ï¼‰===== */
let todayInCount = 0;
let todayOutCount = 0;

async function loadStatus() {
  try {
    // å–å¾—æ‰“å¡ç´€éŒ„
    const data = await (await fetch(API_REC)).json();
    todayInCount = 0;
    todayOutCount = 0;
    let inTime = "", outTime = "";

    // ä½¿ç”¨å°ç£æ™‚é–“åˆ¤æ–·ä»Šæ—¥ç´€éŒ„
    data.forEach(r => {
      // ç¢ºä¿ç´€éŒ„æœ‰æ™‚é–“è³‡æ–™
      if (!r.created_at_tw) return;
      
      // è§£æç´€éŒ„æ™‚é–“
      const recordDateStr = r.created_at_tw.split(' ')[0];
      
      if (r.name === name && recordDateStr === today) {
        const recordTime = r.created_at_tw.split(' ')[1];
        
        if (r.action === "ä¸Šç­") { 
          todayInCount++; 
          inTime = recordTime; 
        }
        if (r.action === "ä¸‹ç­") { 
          todayOutCount++; 
          outTime = recordTime; 
        }
      }
    });

    // å–å¾—å‡ºå·®/æœƒè­°è³‡è¨Š
    const { todayBiz, yesterdayBiz, tomorrowBiz } = await getBusinessInfo();
    
    // å»ºç«‹ç‹€æ…‹é¡¯ç¤ºHTML
    let statusHTML = "";
    
    // æª¢æŸ¥ä»Šå¤©æ˜¯å¦ç‚ºå‡æ—¥
    let holiday = "";
    for (const h of HOLIDAYS) {
      if (today >= h.start && today <= h.end) { 
        holiday = h.name; 
        break; 
      }
    }
    
    // è¨ˆç®—æ˜å¤©æ—¥æœŸ
    const taiwanTomorrow = new Date(now);
    taiwanTomorrow.setDate(taiwanTomorrow.getDate() + 1);
    const tomorrowStr = formatTaiwanDate(taiwanTomorrow);
    
    // æª¢æŸ¥æ˜å¤©æ˜¯å¦æ˜¯å‡æ—¥
    let tomorrowHoliday = "";
    for (const h of HOLIDAYS) {
      if (tomorrowStr >= h.start && tomorrowStr <= h.end) { 
        tomorrowHoliday = h.name; 
        break; 
      }
    }
    
    // å‡æ—¥é¡¯ç¤ºé‚è¼¯
    if (holiday) {
      statusHTML += `<div class="reminder-today">
        ğŸŒ ä»Šæ—¥ç‚º <strong>${holiday}</strong>ï¼Œå…æ‰“å¡
      </div>`;
      btnIn.disabled = true;
      btnOut.disabled = true;
      
      // å³ä½¿åœ¨å‡æ—¥ï¼Œä¹Ÿé¡¯ç¤ºä»Šå¤©çš„å‡ºå·®/æœƒè­°è³‡è¨Š
      if (todayBiz) {
        statusHTML += `<div class="reminder-today">
          ğŸ“Œ ä»Šæ—¥å¦æœ‰ <strong>${todayBiz.type}</strong> è¡Œç¨‹<br>
          ğŸ“… æœŸé–“ï¼š${todayBiz.start_date} ï½ ${todayBiz.end_date}
        </div>`;
      }
    } else if (now.getDay() === 0 || now.getDay() === 6) {
      statusHTML += `<div class="reminder-today">ğŸ”´ ä»Šæ—¥ç‚ºé€±æœ«ï¼Œå…æ‰“å¡</div>`;
      btnIn.disabled = true;
      btnOut.disabled = true;
      
      // é€±æœ«ä¹Ÿé¡¯ç¤ºä»Šå¤©çš„å‡ºå·®/æœƒè­°è³‡è¨Š
      if (todayBiz) {
        statusHTML += `<div class="reminder-today">
          ğŸ“Œ ä»Šæ—¥å¦æœ‰ <strong>${todayBiz.type}</strong> è¡Œç¨‹<br>
          ğŸ“… æœŸé–“ï¼š${todayBiz.start_date} ï½ ${todayBiz.end_date}
        </div>`;
      }
    } else {
      // æ­£å¸¸å·¥ä½œæ—¥
      if (todayBiz) {
        statusHTML += `<div class="reminder-today">
          ğŸ“Œ ä»Šæ—¥ç‚º <strong>${todayBiz.type}</strong><br>
          ğŸ“… æœŸé–“ï¼š${todayBiz.start_date} ï½ ${todayBiz.end_date}<br>
          ğŸ’¡ <strong>ä»Šæ—¥å…æ‰“å¡</strong>
        </div>`;
        btnIn.disabled = true;
        btnOut.disabled = true;
      } else {
        // æ²’æœ‰å‡ºå·®/æœƒè­°æ™‚æ‰é¡¯ç¤ºæ‰“å¡ç‹€æ…‹å’ŒæŒ‰éˆ•
        btnIn.disabled = todayInCount >= MAX_PUNCH_PER_DAY;
        btnOut.disabled = todayInCount === 0 || todayOutCount >= MAX_PUNCH_PER_DAY;
      }
    }
    
    // é¡¯ç¤ºæ˜å¤©å‡ºå·®/æœƒè­°æé†’ï¼ˆç„¡è«–ä»Šå¤©æ˜¯å¦ç‚ºå‡æ—¥ï¼‰
    if (tomorrowBiz) {
      statusHTML += `<div class="reminder-tomorrow">
        ğŸ”” æ˜æ—¥ç‚º <strong>${tomorrowBiz.type}</strong><br>
        ğŸ“… æœŸé–“ï¼š${tomorrowBiz.start_date} ï½ ${tomorrowBiz.end_date}<br>
        ğŸ’¡ æ˜æ—¥å…æ‰“å¡ï¼Œè«‹æå‰æº–å‚™
      </div>`;
    }
    
    // é¡¯ç¤ºæ˜å¤©å‡æ—¥æé†’
    if (tomorrowHoliday) {
      statusHTML += `<div class="reminder-tomorrow">
        ğŸŒ æ˜æ—¥ç‚º <strong>${tomorrowHoliday}</strong><br>
        ğŸ’¡ æ˜æ—¥å…æ‰“å¡
      </div>`;
    }
    
    // é¡¯ç¤ºæ˜¨å¤©å‡ºå·®/æœƒè­°è³‡è¨Š
    if (yesterdayBiz) {
      statusHTML += `<div class="reminder-yesterday">
        ğŸ“Œ æ˜¨æ—¥ç‚º <strong>${yesterdayBiz.type}</strong><br>
        ğŸ“… æœŸé–“ï¼š${yesterdayBiz.start_date} ï½ ${yesterdayBiz.end_date}
      </div>`;
    }
    
    // æª¢æŸ¥æ˜¯å¦é²åˆ°æé†’
    if (!holiday && now.getDay() !== 0 && now.getDay() !== 6 && !todayBiz) {
      const hhmm = now.getHours() * 100 + now.getMinutes();
      if (hhmm >= 910 && todayInCount === 0) {
        statusHTML += `<div style="color:#dc2626;margin:8px 0">
          ğŸ”´ æ‚¨å°šæœªæ‰“å¡ï¼Œè«‹é€Ÿæ‰“å¡
        </div>`;
      }
    }
    
    // é¡¯ç¤ºæ‰“å¡ç‹€æ…‹
    if (!holiday && now.getDay() !== 0 && now.getDay() !== 6 && !todayBiz) {
      statusHTML += `
        <div style="margin-top:10px">
          ğŸŸ¢ ä¸Šç­ï¼š${todayInCount ? inTime : "å°šæœª"}ï¼ˆ${todayInCount}/2ï¼‰<br>
          ğŸ”µ ä¸‹ç­ï¼š${todayOutCount ? outTime : "â€”"}ï¼ˆ${todayOutCount}/2ï¼‰
        </div>
      `;
    }
    
    statusBox.innerHTML = statusHTML;
    
    // å¥—ç”¨å†·å»è¦å‰‡
    if (isInCooldown() && !holiday && now.getDay() !== 0 && now.getDay() !== 6 && !todayBiz) {
      const sec = cooldownRemainSec();
      btnIn.disabled = true;
      btnOut.disabled = true;
      statusBox.innerHTML += `<br>â³ æ‰“å¡å†·å»ä¸­ï¼Œå‰©é¤˜ ${sec} ç§’`;
    }
    
  } catch (error) {
    console.error("è¼‰å…¥ç‹€æ…‹å¤±æ•—:", error);
    statusBox.innerHTML = "âŒ è¼‰å…¥ç‹€æ…‹å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š";
    log(`âŒ è¼‰å…¥ç‹€æ…‹å¤±æ•—: ${error.message}`);
  }
}

loadStatus();

/* ===== æ‰“å¡ï¼ˆå«äºŒæ¬¡ç¢ºèª + 3åˆ†é˜å†·å»ï¼‰===== */
function punch(action) {
  // å†·å»ä¸­ç¦æ­¢
  if (isInCooldown()) {
    alert(`â³ å‰›å®Œæˆæ‰“å¡ï¼Œè«‹ ${cooldownRemainSec()} ç§’å¾Œå†æ“ä½œ`);
    return;
  }

  const count = action === "ä¸Šç­" ? todayInCount : todayOutCount;
  if (count >= MAX_PUNCH_PER_DAY) {
    alert(`âŒ ${action} å·²è¶…éä»Šæ—¥å¯æ“ä½œæ¬¡æ•¸`);
    return;
  }
  if (count === 1) {
    if (!confirm(`âš ï¸ ä½ ä»Šå¤©å·²ç¶“æ‰“éä¸€æ¬¡ã€Œ${action}ã€\næ˜¯å¦ç¢ºå®šè¦ç¬¬äºŒæ¬¡ä¿®æ­£ï¼Ÿ`)) return;
  }

  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const dist = distanceMeter(COMPANY_LAT, COMPANY_LNG, lat, lng);

    log(`ğŸ“¤ é€å‡º ${action}ï¼ˆç¬¬ ${count + 1} æ¬¡ï¼‰â€¦`);

    await fetch(API_PUNCH, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, action, lat, lng })
    });

    // æˆåŠŸå¾Œå•Ÿå‹• 3 åˆ†é˜å†·å»
    localStorage.setItem(COOLDOWN_KEY, String(Date.now()));

    log(`âœ… ${action} æˆåŠŸï½œè·å…¬å¸ ${dist} m`);
    loadStatus();

    // å†·å»å€’æ•¸é¡¯ç¤º
    const timer = setInterval(() => {
      if (!isInCooldown()) {
        clearInterval(timer);
        loadStatus();
        return;
      }
      const sec = cooldownRemainSec();
      btnIn.disabled = true;
      btnOut.disabled = true;
      const base = statusBox.innerHTML.split("<br>â³")[0];
      statusBox.innerHTML = base + `<br>â³ æ‰“å¡å†·å»ä¸­ï¼Œå‰©é¤˜ ${sec} ç§’`;
    }, 1000);

  }, () => alert("âŒ ç„¡æ³•å–å¾— GPS"));
}

/* ===== PWA å®‰è£ ===== */
let deferredPrompt;
const btnInstall = document.getElementById("btnInstall");
window.addEventListener("beforeinstallprompt", e => {
  e.preventDefault();
  deferredPrompt = e;
  btnInstall.style.display = "block";
});
btnInstall.addEventListener("click", async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  if (outcome === "accepted") log("â¬‡ å·²é–‹å§‹å®‰è£ App");
  deferredPrompt = null;
});

/* ===== Service Worker ===== */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js");
}

/* ===== ç•¶æœˆæ¯æ—¥æ‰“å¡ç´€éŒ„ ===== */
let monthlyVisible = false;

function toggleMonthly() {
  const box = document.getElementById("monthlyBox");
  monthlyVisible = !monthlyVisible;
  box.style.display = monthlyVisible ? "block" : "none";
  if (monthlyVisible) loadMonthly();
}

async function loadMonthly() {
  const box = document.getElementById("monthlyBox");
  box.innerHTML = "è®€å–ç•¶æœˆæ‰“å¡ç´€éŒ„ä¸­â€¦";

  try {
    const data = await (await fetch(API_REC)).json();

    // ä½¿ç”¨å°ç£æ™‚é–“å–å¾—ç•¶å‰å¹´æœˆ
    const taiwanNow = getTaiwanDate();
    const currentYear = taiwanNow.getFullYear();
    const currentMonth = String(taiwanNow.getMonth() + 1).padStart(2, '0');
    const currentYM = `${currentYear}-${currentMonth}`;

    const records = data.filter(r => {
      if (!r.created_at_tw || r.name !== name) return false;
      
      const recordDateStr = r.created_at_tw.split(' ')[0];
      return recordDateStr.startsWith(currentYM);
    });

    // ä¾æ—¥æœŸåˆ†çµ„
    const byDate = {};
    records.forEach(r => {
      const recordDateStr = r.created_at_tw.split(' ')[0];
      if (!byDate[recordDateStr]) byDate[recordDateStr] = [];
      byDate[recordDateStr].push(r);
    });

    let html = `ğŸ“† ${currentYM} æ¯æ—¥æ‰“å¡ç´€éŒ„<br>====================<br>`;

    Object.keys(byDate).sort().forEach(date => {
      const dObj = new Date(date + 'T00:00:00+08:00');
      const week = map[dObj.getDay()];

      html += `<br>ğŸ“… ${date}ï¼ˆé€±${week}ï¼‰<br>`;

      byDate[date].forEach(r => {
        const timePart = r.created_at_tw.split(' ')[1] || "";
        html += `ã€€ğŸ•’ ${timePart}ï½œ${r.action}<br>`;
      });
    });

    if (records.length === 0) {
      html += "æœ¬æœˆå°šç„¡ä»»ä½•æ‰“å¡ç´€éŒ„<br>";
    }

    box.innerHTML = html;
  } catch (error) {
    box.innerHTML = "âŒ è®€å–ç´€éŒ„å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š";
  }
}
</script>
</body>
</html>