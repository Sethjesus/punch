<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>å…¬å¸æ‰“å¡ç³»çµ±</title>

<style>
body{
  font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
  background:#f4f6f8;
}
.card{
  max-width:420px;
  margin:40px auto;
  background:#fff;
  padding:26px;
  border-radius:18px;
  box-shadow:0 12px 28px rgba(0,0,0,.15);
}
h2{text-align:center;margin-bottom:22px}
input, select{
  width:100%;
  padding:14px;
  font-size:17px;
  border-radius:12px;
  border:1px solid #ccc;
  margin-bottom:14px;
  background:#fff;
}
button{
  width:100%;
  padding:14px;
  font-size:18px;
  border:none;
  border-radius:14px;
  color:#fff;
  font-weight:700;
  margin-bottom:12px;
  cursor:pointer;
}
.in{ background:#2563eb; }
.out{ background:#16a34a; }
.leave{ background:#f59e0b; }

.msg{
  text-align:center;
  font-size:16px;
  font-weight:700;
  margin-top:12px;
}
.sub{
  text-align:center;
  font-size:13px;
  color:#666;
  margin-top:6px;
}
.footer{
  text-align:center;
  font-size:12px;
  color:#999;
  margin-top:18px;
}
</style>
</head>

<body>

<div class="card">
  <h2>ğŸ“ å…¬å¸æ‰“å¡</h2>

  <!-- å·¥è™Ÿå·è»¸ -->
  <select id="empId" onchange="syncName()">
    <option value="">è«‹é¸æ“‡å·¥è™Ÿ</option>
    <option value="U001">U001</option>
    <option value="U002">U002</option>
    <option value="U003">U003</option>
  </select>

  <!-- å§“åå·è»¸ï¼ˆè‡ªå‹•å¸¶å‡ºï¼‰ -->
  <select id="name" disabled>
    <option value="">è«‹å…ˆé¸æ“‡å·¥è™Ÿ</option>
  </select>

  <!-- å¯†ç¢¼ -->
  <input id="password" type="password" placeholder="å¯†ç¢¼">

  <button class="in" onclick="punch('in')">ğŸ•˜ ä¸Šç­æ‰“å¡</button>
  <button class="out" onclick="punch('out')">ğŸ•• ä¸‹ç­æ‰“å¡</button>
  <button class="leave" onclick="punch('leave')">ğŸ– è«‹å‡ / å¤–å‡º</button>

  <div class="msg" id="msg">è«‹é¸æ“‡å·¥è™Ÿä¸¦è¼¸å…¥å¯†ç¢¼</div>
  <div class="sub" id="sub"></div>

  <div class="footer">Â© å…¬å¸å…§éƒ¨ç³»çµ±</div>
</div>

<script>
/* âœ… ä½ çš„ Worker API */
const API_URL = "https://punch-api.jackey1688.workers.dev/api/punch";

const msg = document.getElementById("msg");
const sub = document.getElementById("sub");

/* å“¡å·¥å°ç…§è¡¨ï¼ˆå‰ç«¯åªåšé¡¯ç¤ºï¼Œé©—è­‰ä»åœ¨ Workerï¼‰ */
const EMP_MAP = {
  "U001": "å»–å¿—è±ª",
  "U002": "æ‘©è¥¿",
  "U003": "å½¼å¾—"
};

/* å·¥è™Ÿ â†’ å§“åè‡ªå‹•åŒæ­¥ */
function syncName(){
  const empId = document.getElementById("empId").value;
  const nameSelect = document.getElementById("name");

  nameSelect.innerHTML = "";

  if(!empId){
    nameSelect.innerHTML = "<option>è«‹å…ˆé¸æ“‡å·¥è™Ÿ</option>";
    nameSelect.disabled = true;
    return;
  }

  const name = EMP_MAP[empId];
  nameSelect.innerHTML = `<option value="${name}">${name}</option>`;
  nameSelect.disabled = false;
}

/* æ‰“å¡ */
function punch(action){
  const empId = document.getElementById("empId").value;
  const name = document.getElementById("name").value;
  const password = document.getElementById("password").value.trim();

  if(!empId || !name || !password){
    msg.innerText = "â— è«‹å®Œæˆæ‰€æœ‰æ¬„ä½";
    sub.innerText = "";
    return;
  }

  msg.innerText = "ğŸ“¡ å–å¾— GPS ä¸­â€¦";
  sub.innerText = "è«‹å…è¨±å®šä½";

  navigator.geolocation.getCurrentPosition(
    pos => {
      fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          emp_id: empId,
          name: name,
          password: password,
          action: action,
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        })
      })
      .then(r => r.json())
      .then(res => {
        if(res.ok){
          msg.innerText = `âœ… ${res.name} æ“ä½œæˆåŠŸ`;
          sub.innerText =
            action === "in" ? "ä¸Šç­å®Œæˆ" :
            action === "out" ? "ä¸‹ç­å®Œæˆ" :
            "è«‹å‡ / å¤–å‡ºå·²é€å‡º";
        }else{
          msg.innerText = "âŒ æ“ä½œå¤±æ•—";
          sub.innerText = res.error || "é©—è­‰å¤±æ•—";
        }
      })
      .catch(() => {
        msg.innerText = "âŒ ç³»çµ±éŒ¯èª¤";
        sub.innerText = "è«‹ç¨å¾Œå†è©¦";
      });
    },
    err => {
      msg.innerText = "âŒ ç„¡æ³•å–å¾— GPS";
      sub.innerText = err.message;
    },
    { enableHighAccuracy:true, timeout:15000 }
  );
}
</script>

</body>
</html>
