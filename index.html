<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UDM ESGï½œä¸Šç­æ‰“å¡ç³»çµ±</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#1e293b">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
/* ===== è‰²å½©è®Šæ•¸ ===== */
:root{
  --bg:#0f172a;
  --card:#f8fafc;
  --primary:#2563eb;
  --success:#16a34a;
  --muted:#64748b;
}

/* ===== åŸºæœ¬æ¨£å¼ ===== */
body{
  margin:0;
  background:linear-gradient(180deg,#0f172a,#020617);
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
}

header{
  background:linear-gradient(90deg,#020617,#1e293b);
  color:#fff;
  padding:16px;
  text-align:center;
}

header h1{
  margin:0;
  font-size:20px;
}

header div{
  font-size:12px;
  opacity:.85;
}

.container{
  max-width:420px;
  margin:20px auto;
  background:var(--card);
  border-radius:18px;
  padding:18px;
  box-shadow:0 20px 40px rgba(0,0,0,.35);
}

/* ===== ä»Šæ—¥ ===== */
.today{
  text-align:center;
  margin-bottom:10px;
}

.today .date{
  font-size:16px;
  font-weight:700;
}

.today .week{
  font-size:13px;
  color:var(--muted);
}

/* ===== å§“å ===== */
.nameBox{
  margin-top:6px;
  font-size:14px;
  color:#334155;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
}

.editName{
  border:0;
  background:#e5e7eb;
  border-radius:6px;
  padding:2px 6px;
  cursor:pointer;
  font-size:12px;
}

/* ===== ç‹€æ…‹ ===== */
.status{
  background:#eef2ff;
  padding:12px;
  border-radius:14px;
  margin-bottom:14px;
  font-size:14px;
}

/* ===== æ‰“å¡ ===== */
.actions{
  display:flex;
  gap:10px;
  margin-bottom:14px;
}

button{
  flex:1;
  padding:14px;
  border-radius:14px;
  border:0;
  font-size:15px;
  font-weight:700;
  cursor:pointer;
}

button:disabled{
  opacity:.4;
  cursor:not-allowed;
}

.btn-in{
  background:var(--success);
  color:#fff;
}

.btn-out{
  background:var(--primary);
  color:#fff;
}

/* ===== æ¬¡åŠŸèƒ½ ===== */
.sub{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

.sub button{
  padding:10px;
  font-size:13px;
  background:#334155;
  color:#fff;
}

/* ===== Log ===== */
.log{
  margin-top:12px;
  background:#020617;
  color:#22c55e;
  font-size:12px;
  padding:10px;
  border-radius:12px;
  height:140px;
  overflow:auto;
}
</style>
</head>

<body>

<header>
  <h1>UDM ESG</h1>
  <div>ä¸Šç­æ‰“å¡ç³»çµ±</div>
</header>

<div class="container">

  <!-- ä»Šæ—¥ -->
  <div class="today">
    <div class="date" id="todayDate"></div>
    <div class="week" id="todayWeek"></div>

    <!-- å§“å -->
    <div class="nameBox">
      ğŸ‘¤ <span id="userName"></span>
      <button class="editName" onclick="editName()">âœï¸</button>
    </div>
  </div>

  <!-- ç‹€æ…‹ -->
  <div class="status" id="statusBox">è®€å–ä»Šæ—¥ç‹€æ…‹ä¸­â€¦</div>

  <!-- æ‰“å¡ -->
  <div class="actions">
    <button id="btnIn" class="btn-in" onclick="punch('ä¸Šç­')">ä¸Šç­æ‰“å¡</button>
    <button id="btnOut" class="btn-out" onclick="punch('ä¸‹ç­')">ä¸‹ç­æ‰“å¡</button>
  </div>

  <!-- æ¬¡åŠŸèƒ½ -->
  <div class="sub">
    <button onclick="location.href='Leave.html'">ğŸ“ è«‹å‡ / å‡ºå·® / æœƒè­°</button>
    <button onclick="location.href='HR.html'">ğŸ“Š HR ç¸½è¦½</button>
  </div>

  <!-- Log -->
  <div class="log" id="log"></div>

</div>

<script>
/* =====================================================
   API å®šç¾©
===================================================== */
const API_PUNCH  = "https://punch-api.jackey1688.workers.dev/api/punch";
const API_REC    = "https://punch-api.jackey1688.workers.dev/api/records";
const API_LEAVE  = "https://punch-api.jackey1688.workers.dev/api/leave";

/* =====================================================
   DOM
===================================================== */
const statusBox = document.getElementById("statusBox");
const btnIn     = document.getElementById("btnIn");
const btnOut    = document.getElementById("btnOut");
const logBox    = document.getElementById("log");

/* =====================================================
   ä½¿ç”¨è€…
===================================================== */
let name = localStorage.getItem("name");
if(!name){
  name = prompt("è«‹è¼¸å…¥å§“å");
  localStorage.setItem("name", name);
}
document.getElementById("userName").innerText = name;

function editName(){
  const newName = prompt("è«‹è¼¸å…¥æ–°çš„å§“å", name);
  if(!newName) return;
  name = newName.trim();
  localStorage.setItem("name", name);
  document.getElementById("userName").innerText = name;
  log("ğŸ‘¤ å·²åˆ‡æ›ä½¿ç”¨è€…ï¼š" + name);
  loadStatus();
}

/* =====================================================
   ä»Šæ—¥æ—¥æœŸ
===================================================== */
const now   = new Date();
const today = now.toISOString().slice(0,10);
const map   = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];

document.getElementById("todayDate").innerText = today;
document.getElementById("todayWeek").innerText = "é€±" + map[now.getDay()];

/* =====================================================
   å·¥å…·
===================================================== */
function log(msg){
  logBox.innerHTML += msg + "<br>";
  logBox.scrollTop = logBox.scrollHeight;
}

function dateAdd(dateStr, days){
  const d = new Date(dateStr);
  d.setDate(d.getDate() + days);
  return d.toISOString().slice(0,10);
}

/* =====================================================
   ç‹€æ…‹è¼‰å…¥ï¼ˆæ”¤é–‹ç‰ˆï¼‰
===================================================== */
async function loadStatus(){

  /* ---------- 1. è®€å–æ‰“å¡ç´€éŒ„ ---------- */
  const records = await (await fetch(API_REC)).json();

  let todayInCount  = 0;
  let todayOutCount = 0;
  let inTime  = "";
  let outTime = "";

  for(let i=0;i<records.length;i++){
    const r = records[i];
    if(r.name === name && r.created_at_tw && r.created_at_tw.startsWith(today)){
      if(r.action === "ä¸Šç­"){
        todayInCount++;
        inTime = r.created_at_tw.slice(11,19);
      }
      if(r.action === "ä¸‹ç­"){
        todayOutCount++;
        outTime = r.created_at_tw.slice(11,19);
      }
    }
  }

  /* ---------- 2. è®€å–è«‹å‡ / å‡ºå·® / æœƒè­° ---------- */
  let tripNotice = "";

  try{
    const leaves = await (await fetch(API_LEAVE)).json();

    for(let j=0;j<leaves.length;j++){
      const l = leaves[j];

      if(l.name !== name){
        continue;
      }

      if(l.type === "å‡ºå·®"){
        if(today === l.start_date){
          tripNotice = "ğŸ“Œ ä»Šæ—¥æœ‰ã€å‡ºå·®ã€‘è¡Œç¨‹<br>";
        }
        if(today === dateAdd(l.start_date,-1)){
          tripNotice = "ğŸ“Œ æ˜æ—¥æœ‰ã€å‡ºå·®ã€‘è¡Œç¨‹<br>";
        }
      }

      if(l.type === "æœƒè­°"){
        if(today === l.start_date){
          tripNotice = "ğŸ“Œ ä»Šæ—¥æœ‰ã€æœƒè­°ã€‘è¡Œç¨‹<br>";
        }
        if(today === dateAdd(l.start_date,-1)){
          tripNotice = "ğŸ“Œ æ˜æ—¥æœ‰ã€æœƒè­°ã€‘è¡Œç¨‹<br>";
        }
      }
    }
  }catch(e){
    console.warn("è®€å–å‡ºå·® / æœƒè­°å¤±æ•—", e);
  }

  /* ---------- 3. æŒ‰éˆ•ç‹€æ…‹ ---------- */
  btnIn.disabled  = todayInCount >= 2;
  btnOut.disabled = todayInCount === 0 || todayOutCount >= 2;

  /* ---------- 4. çµ„åˆé¡¯ç¤º ---------- */
  let html = "";

  if(tripNotice !== ""){
    html += tripNotice;
  }

  html += "ğŸŸ¢ ä¸Šç­ï¼š" + (todayInCount ? inTime : "å°šæœª") + "<br>";
  html += "ğŸ”µ ä¸‹ç­ï¼š" + (todayOutCount ? outTime : "â€”") + "<br>";

  statusBox.innerHTML = html;
}

/* =====================================================
   æ‰“å¡
===================================================== */
function punch(action){
  navigator.geolocation.getCurrentPosition(async pos=>{
    await fetch(API_PUNCH,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        name:name,
        action:action,
        lat:pos.coords.latitude,
        lng:pos.coords.longitude
      })
    });
    log("âœ… " + action + " å®Œæˆ");
    loadStatus();
  },()=>{
    alert("âŒ ç„¡æ³•å–å¾— GPS");
  });
}

loadStatus();
</script>

</body>
</html>
