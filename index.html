<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>UDM GPS å‡ºå‹¤</title>
<style>
  body { font-family: system-ui; background:#f2f2f2; }
  .card { max-width:360px; margin:40px auto; background:#fff; padding:20px; border-radius:12px; }
  input, button { width:100%; padding:10px; margin:6px 0; font-size:16px; }
  button { border:none; border-radius:8px; cursor:pointer; }
  .in { background:#1e88e5; color:#fff; }
  .out { background:#37474f; color:#fff; }
  .gps { font-size:13px; color:#333; margin-top:10px; line-height:1.5; }
  .status { margin-top:10px; font-weight:bold; }
</style>
</head>

<body>
<div class="card">
  <h2>UDM GPS å‡ºå‹¤</h2>

  <label>å§“å</label>
  <input id="name" placeholder="è«‹è¼¸å…¥å§“å" />

  <button class="in" onclick="punch('IN')">ä¸Šç­æ‰“å¡</button>
  <button class="out" onclick="punch('OUT')">ä¸‹ç­æ‰“å¡</button>

  <div class="gps" id="gpsInfo">å°šæœªå–å¾—å®šä½</div>
  <div class="status" id="status"></div>
</div>

<script>
/* ğŸ”´ Apps Script API */
const API_URL = "https://script.google.com/macros/s/AKfycbzFWXo1fsxLv2ghk_8l0vZuS8nex9h_3y-LX69R0fOLO6o8ZO6rMjMAif5UqfgN1I0L/exec";

/* ğŸ¢ å…¬å¸å›ºå®šåº§æ¨™ï¼ˆä½ çµ¦çš„ï¼‰ */
const OFFICE_LAT = 25.0083253;
const OFFICE_LON = 121.5170166;

/* è¨˜ä½å§“å */
const nameInput = document.getElementById("name");
nameInput.value = localStorage.getItem("udm_name") || "";
nameInput.onchange = () => localStorage.setItem("udm_name", nameInput.value);

/* è¨ˆç®—è·é›¢ï¼ˆå…¬å°ºï¼‰ */
function distanceMeters(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = d => d * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a =
    Math.sin(dLat/2) ** 2 +
    Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
    Math.sin(dLon/2) ** 2;
  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

/* å–å¾— GPS */
function getGPS(cb){
  navigator.geolocation.getCurrentPosition(
    pos => {
      const c = pos.coords;
      const dist = distanceMeters(
        c.latitude, c.longitude,
        OFFICE_LAT, OFFICE_LON
      );

      document.getElementById("gpsInfo").innerHTML = `
        ğŸ¢ å…¬å¸åº§æ¨™<br>
        ğŸ“ ç·¯åº¦ï¼š${OFFICE_LAT}<br>
        ğŸ“ ç¶“åº¦ï¼š${OFFICE_LON}<br><br>

        ğŸ“± ç›®å‰ä½ç½®<br>
        ğŸ“ ç·¯åº¦ï¼š${c.latitude}<br>
        ğŸ“ ç¶“åº¦ï¼š${c.longitude}<br>
        ğŸ¯ ç²¾æº–åº¦ï¼š${Math.round(c.accuracy)} å…¬å°º<br>
        ğŸ“ è·é›¢å…¬å¸ï¼š${dist} å…¬å°º
      `;

      cb(c, dist);
    },
    err => alert("GPS å¤±æ•—ï¼š" + err.message),
    { enableHighAccuracy:true, timeout:10000 }
  );
}

/* æ‰“å¡ */
function punch(action){
  if(!nameInput.value) return alert("è«‹è¼¸å…¥å§“å");

  document.getElementById("status").innerText = "å®šä½ä¸­â€¦";

  getGPS((c, dist) => {
    const payload = {
      type: "attendance",
      name: nameInput.value,
      action: action,
      lat: c.latitude,
      lon: c.longitude,
      accuracy: c.accuracy,
      distance: dist,
      device: navigator.userAgent
    };

    fetch(API_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    })
    .then(r => r.json())
    .then(() => {
      document.getElementById("status").innerText =
        `âœ… ${action === 'IN' ? 'ä¸Šç­' : 'ä¸‹ç­'}æˆåŠŸ`;
    })
    .catch(() => {
      document.getElementById("status").innerText = "âŒ é€å‡ºå¤±æ•—";
    });
  });
}
</script>
</body>
</html>
