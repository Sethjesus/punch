<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>å…¬å¸æ‰“å¡ç³»çµ±</title>

<style>
body{
  font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif;
  background:#f4f6f8;
}
.card{
  max-width:420px;
  margin:40px auto;
  background:#fff;
  padding:24px;
  border-radius:18px;
  box-shadow:0 10px 25px rgba(0,0,0,.12);
}
h2{text-align:center;margin-bottom:20px}

select,input{
  width:100%;
  padding:14px;
  font-size:17px;
  border-radius:12px;
  border:1px solid #ccc;
  margin-bottom:14px;
}

button{
  width:100%;
  padding:14px;
  font-size:18px;
  border:none;
  border-radius:14px;
  color:#fff;
  font-weight:700;
  margin-bottom:12px;
  cursor:pointer;
}

.in{background:#2563eb}
.out{background:#16a34a}
.leave{background:#f59e0b}

.msg{
  text-align:center;
  font-size:16px;
  font-weight:700;
  margin-top:10px;
}
.sub{
  text-align:center;
  font-size:13px;
  color:#666;
  margin-top:4px;
}
</style>
</head>

<body>
<div class="card">
  <h2>ğŸ“ å…¬å¸æ‰“å¡</h2>

  <!-- å·¥è™Ÿ -->
  <select id="empId"></select>

  <!-- å§“å -->
  <select id="empName"></select>

  <!-- å¯†ç¢¼ -->
  <input id="password" type="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />

  <button class="in" onclick="punch('ä¸Šç­')">ğŸ•˜ ä¸Šç­æ‰“å¡</button>
  <button class="out" onclick="punch('ä¸‹ç­')">ğŸ•• ä¸‹ç­æ‰“å¡</button>
  <button class="leave" onclick="punch('è«‹å‡')">ğŸ–ï¸ è«‹å‡ / å¤–å‡º</button>

  <div class="msg" id="msg">è«‹é¸æ“‡å·¥è™Ÿä¸¦è¼¸å…¥å¯†ç¢¼</div>
  <div class="sub" id="sub"></div>
</div>

<script>
/* ===== API ===== */
const API_URL = "https://punch-api.jackey1688.workers.dev/api/punch";

/* ===== å“¡å·¥è³‡æ–™ï¼ˆå‰ç«¯é¡¯ç¤ºç”¨ï¼‰===== */
const EMPLOYEES = {
  "U001": "å»–å¿—è±ª",
  "U002": "æ‘©è¥¿",
  "U003": "å½¼å¾—"
};

/* ===== åˆå§‹åŒ–ä¸‹æ‹‰ ===== */
const empIdSel = document.getElementById("empId");
const empNameSel = document.getElementById("empName");

for(const id in EMPLOYEES){
  empIdSel.add(new Option(id, id));
  empNameSel.add(new Option(EMPLOYEES[id], EMPLOYEES[id]));
}

/* å·¥è™Ÿ â†” å§“åé€£å‹• */
empIdSel.onchange = () => {
  empNameSel.selectedIndex = empIdSel.selectedIndex;
};
empNameSel.onchange = () => {
  empIdSel.selectedIndex = empNameSel.selectedIndex;
};

/* ===== æ‰“å¡ ===== */
function punch(action){
  const emp_id = empIdSel.value;
  const name = empNameSel.value;
  const password = document.getElementById("password").value;

  if(!password){
    msg.innerText = "â— è«‹è¼¸å…¥å¯†ç¢¼";
    return;
  }

  const isLeave = action === "è«‹å‡";

  msg.innerText = isLeave ? "â³ è™•ç†ä¸­â€¦" : "ğŸ“ å–å¾—å®šä½ä¸­â€¦";
  sub.innerText = "";

  const send = (lat=null,lng=null)=>{
    fetch(API_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        emp_id, name, password, action, lat, lng
      })
    })
    .then(r=>r.json())
    .then(res=>{
      if(!res.ok) throw res.error;
      msg.innerText = `âœ… ${name} æ‰“å¡æˆåŠŸ`;
      sub.innerText = res.distance!=null
        ? `è·å…¬å¸ ${res.distance} å…¬å°º`
        : `${action} å®Œæˆ`;
    })
    .catch(err=>{
      msg.innerText = "âŒ æ‰“å¡å¤±æ•—";
      sub.innerText = err;
    });
  };

  if(isLeave){
    send();
  }else{
    navigator.geolocation.getCurrentPosition(
      p=>send(p.coords.latitude,p.coords.longitude),
      e=>{
        msg.innerText = "âŒ ç„¡æ³•å–å¾— GPS";
        sub.innerText = e.message;
      },
      { enableHighAccuracy:true, timeout:15000 }
    );
  }
}
</script>
</body>
</html>
