<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>å…¬å¸ GPS æ‰“å¡</title>
  <style>
    :root{--b:#2563eb;--g:#16a34a;--bg:#f4f6f8;--card:#fff;--txt:#111827;--muted:#6b7280}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;color:var(--txt)}
    .wrap{max-width:460px;margin:0 auto;padding:18px}
    .card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:18px}
    h1{margin:6px 0 14px;text-align:center;font-size:28px}
    .pin{margin-right:6px}
    .field{margin:10px 0}
    label{display:block;font-size:13px;color:var(--muted);margin:0 0 6px}
    input{width:100%;padding:14px 12px;font-size:18px;border:1px solid #d1d5db;border-radius:12px;outline:none}
    input:focus{border-color:#93c5fd;box-shadow:0 0 0 3px rgba(147,197,253,.35)}
    .btns{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px}
    button{width:100%;padding:14px 12px;font-size:20px;border:0;border-radius:14px;color:#fff;font-weight:700}
    .btn-in{background:var(--b)}
    .btn-out{background:var(--g)}
    button:disabled{opacity:.6}
    .info{margin-top:14px;text-align:center;font-size:16px;font-weight:700}
    .sub{margin-top:6px;text-align:center;color:var(--muted);font-size:13px;white-space:pre-wrap}
    .badge{display:inline-block;margin:8px auto 0;padding:6px 10px;border-radius:999px;background:#eef2ff;color:#3730a3;font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1><span class="pin">ğŸ“</span>å…¬å¸ GPS æ‰“å¡</h1>

      <div class="field">
        <label>å·¥è™Ÿï¼ˆä¾‹å¦‚ U001ï¼‰</label>
        <input id="empId" placeholder="U001" autocomplete="off" inputmode="text" />
      </div>

      <div class="btns">
        <button class="btn-in" id="btnIn" onclick="punch('ä¸Šç­')">ğŸ•˜ ä¸Šç­</button>
        <button class="btn-out" id="btnOut" onclick="punch('ä¸‹ç­')">ğŸ•• ä¸‹ç­</button>
      </div>

      <div class="info" id="msg">å¾…å‘½</div>
      <div class="sub" id="sub"></div>
      <div class="badge mono" id="dbg"></div>
    </div>
  </div>

<script>
/* ====== ä½ çš„ Apps Script Web App URL ====== */
const API_URL = "https://script.google.com/macros/s/AKfycbyGMYNPD7X5ngEKJnQ8vUe1T7-zpo9vWsAboYkod568iKbCSFD-IiHAR-d6VJW5rNxx/exec";

/* ====== UI helpers ====== */
function setBusy(isBusy){
  document.getElementById("btnIn").disabled = isBusy;
  document.getElementById("btnOut").disabled = isBusy;
}
function setMsg(main, sub=""){
  document.getElementById("msg").innerText = main;
  document.getElementById("sub").innerText = sub;
}

/* ====== Punch flow ====== */
function punch(action){
  const empId = document.getElementById("empId").value.trim();
  if(!empId){
    setMsg("è«‹è¼¸å…¥å·¥è™Ÿ");
    return;
  }

  setBusy(true);
  setMsg("å–å¾— GPS ä¸­â€¦", "è«‹ç¢ºèªå·²å…è¨±ã€Œç²¾ç¢ºä½ç½®ã€æ¬Šé™");

  if(!navigator.geolocation){
    setBusy(false);
    setMsg("ç€è¦½å™¨ä¸æ”¯æ´ GPS");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const acc = pos.coords.accuracy; // meters
      document.getElementById("dbg").innerText =
        `lat ${lat.toFixed(6)} | lng ${lng.toFixed(6)} | acc ${Math.round(acc)}m`;

      setMsg("é€å‡ºä¸­â€¦", "æ­£åœ¨å¯«å…¥ Google Sheet");
      sendToApi({ empId, action, lat, lng, device: navigator.userAgent });
    },
    err => {
      setBusy(false);
      let reason = err.message || "";
      if (err.code === 1) reason = "æœªæˆæ¬Šä½ç½®ï¼ˆè«‹åˆ° Chrome æ¬Šé™é–‹å•Ÿã€Œç²¾ç¢ºä½ç½®ã€ï¼‰";
      if (err.code === 2) reason = "ä½ç½®ä¸å¯ç”¨ï¼ˆè«‹é–‹å•Ÿå®šä½æœå‹™/é«˜ç²¾æº–åº¦ï¼‰";
      if (err.code === 3) reason = "å®šä½é€¾æ™‚ï¼ˆè«‹åˆ°ç©ºæ› è™•å†è©¦ï¼‰";
      setMsg("GPS å¤±æ•—", reason);
    },
    { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
  );
}

/* ====== API call (CORS-safe) ======
   ç”¨ text/plain é¿å… preflightï¼ŒApps Script æ‰ç©©
*/
function sendToApi(payload){
  fetch(API_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  })
  .then(r => r.text())
  .then(t => {
    setBusy(false);
    let data;
    try { data = JSON.parse(t); }
    catch(e){
      setMsg("å›å‚³è§£æå¤±æ•—", "ä¼ºæœå™¨å›æ‡‰ä¸æ˜¯ JSONï¼ˆè«‹çœ‹ consoleï¼‰");
      console.log("RAW:", t);
      return;
    }

    // é¡¯ç¤ºçµæœ
    const dist = (data.distance_m !== undefined && data.distance_m !== null)
      ? `ï¼ˆ${data.distance_m} mï¼‰` : "";
    setMsg(`çµæœï¼š${data.status} ${dist}`.trim());

    if (data.message) {
      document.getElementById("sub").innerText = data.message;
    }
  })
  .catch(err => {
    setBusy(false);
    setMsg("é€å‡ºå¤±æ•—", "å¯èƒ½æ˜¯ç¶²è·¯ã€CORSã€æˆ– API URL éŒ¯èª¤");
    console.log(err);
  });
}
</script>
</body>
</html>
