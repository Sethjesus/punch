<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å…¬å¸ GPS æ‰“å¡</title>

  <style>
    body{
      margin:0;
      background:#f4f6f8;
      font-family:system-ui,-apple-system,"Noto Sans TC",sans-serif;
    }
    .wrap{
      max-width:420px;
      margin:0 auto;
      padding:20px;
    }
    .card{
      background:#fff;
      border-radius:16px;
      padding:20px;
      box-shadow:0 10px 25px rgba(0,0,0,.1);
    }
    h1{
      text-align:center;
      margin:5px 0 20px;
      font-size:26px;
    }
    input{
      width:100%;
      padding:14px;
      font-size:18px;
      border-radius:12px;
      border:1px solid #ccc;
      margin-bottom:12px;
    }
    button{
      width:100%;
      padding:14px;
      font-size:20px;
      border-radius:14px;
      border:none;
      color:#fff;
      font-weight:700;
      margin-bottom:10px;
    }
    .in{ background:#2563eb; }
    .out{ background:#16a34a; }
    button:disabled{ opacity:.6; }
    .msg{
      text-align:center;
      font-size:18px;
      font-weight:700;
      margin-top:10px;
    }
    .sub{
      text-align:center;
      font-size:13px;
      color:#666;
      margin-top:6px;
      white-space:pre-wrap;
    }
    .dbg{
      margin-top:10px;
      font-size:12px;
      color:#333;
      text-align:center;
      font-family:monospace;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>ğŸ“ å…¬å¸ GPS æ‰“å¡</h1>

    <input id="empId" placeholder="å·¥è™Ÿï¼ˆä¾‹ U001ï¼‰" />

    <button id="btnIn" class="in" onclick="punch('ä¸Šç­')">ğŸ•˜ ä¸Šç­</button>
    <button id="btnOut" class="out" onclick="punch('ä¸‹ç­')">ğŸ•• ä¸‹ç­</button>

    <div class="msg" id="msg">å¾…å‘½</div>
    <div class="sub" id="sub"></div>
    <div class="dbg" id="dbg"></div>
  </div>
</div>

<script>
/* ========= Apps Script Web App URL ========= */
const API_URL =
"https://script.google.com/macros/s/AKfycbyGMYNPD7X5ngEKJnQ8vUe1T7-zpo9vWsAboYkod568iKbCSFD-IiHAR-d6VJW5rNxx/exec";

/* ========= UI helpers ========= */
function setBusy(b){
  btnIn.disabled = b;
  btnOut.disabled = b;
}

function setMsg(m,s=""){
  msg.innerText = m;
  sub.innerText = s;
}

/* ========= Punch ========= */
function punch(action){
  if (!navigator.geolocation) {
    setMsg("æ­¤ç€è¦½å™¨ä¸æ”¯æ´ GPS");
    return;
  }

  const empId = document.getElementById("empId").value.trim();
  if(!empId){
    setMsg("è«‹è¼¸å…¥å·¥è™Ÿ");
    return;
  }

  setBusy(true);
  setMsg("å–å¾— GPS ä¸­â€¦","è«‹å…è¨±å®šä½ï¼ˆç²¾ç¢ºä½ç½®ï¼‰");

  navigator.geolocation.getCurrentPosition(
    pos=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const acc = pos.coords.accuracy;

      dbg.innerText =
        `lat=${lat.toFixed(6)} lng=${lng.toFixed(6)} acc=${Math.round(acc)}m`;

      send({
        empId,
        action,
        lat,
        lng,
        device: navigator.userAgent
      });
    },
    err=>{
      setBusy(false);
      setMsg("GPS å¤±æ•—", err.message);
    },
    { enableHighAccuracy:true, timeout:15000 }
  );
}

/* ========= Send to API ========= */
function send(payload){
  setMsg("é€å‡ºä¸­â€¦","å¯«å…¥ Google Sheet");

  fetch(API_URL,{
    method:"POST",
    headers:{ "Content-Type":"text/plain;charset=utf-8" },
    body: JSON.stringify(payload)
  })
  .then(r=>{
    if(!r.ok) throw new Error("HTTP " + r.status);
    return r.text();
  })
  .then(t=>{
    setBusy(false);
    let d;
    try{ d = JSON.parse(t); }
    catch{
      setMsg("å›å‚³æ ¼å¼éŒ¯èª¤");
      console.log(t);
      return;
    }

    const dist = d.distance_m!=null ? `ï¼ˆ${d.distance_m} mï¼‰` : "";
    setMsg(`çµæœï¼š${d.status} ${dist}`, d.message || "");
  })
  .catch(e=>{
    setBusy(false);
    setMsg("é€å‡ºå¤±æ•—", e.message);
    console.log(e);
  });
}
</script>
</body>
</html>
