<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UDM ESGï½œä¸Šç­æ‰“å¡ç³»çµ±</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#1e293b">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root{
  --card:#f8fafc;
  --success:#16a34a;
  --primary:#2563eb;
  --muted:#64748b;
}
body{
  margin:0;
  background:linear-gradient(180deg,#0f172a,#020617);
  font-family:system-ui;
}
header{
  background:#020617;
  color:#fff;
  padding:16px;
  text-align:center;
}
.container{
  max-width:420px;
  margin:20px auto;
  background:var(--card);
  border-radius:18px;
  padding:18px;
}
.today{text-align:center}
.today .date{font-size:18px;font-weight:700}
.today .week{font-size:13px;color:var(--muted)}

.nameBox{
  display:flex;justify-content:center;gap:6px;margin-top:6px
}
.editName{border:0;background:#e5e7eb;border-radius:6px;cursor:pointer}

.status{
  background:#eef2ff;
  padding:12px;
  border-radius:14px;
  margin:14px 0;
  font-size:14px;
}

.actions{display:flex;gap:10px}
button{
  flex:1;
  padding:14px;
  border-radius:14px;
  border:0;
  font-weight:700;
  cursor:pointer;
}
.btn-in{background:var(--success);color:#fff}
.btn-out{background:var(--primary);color:#fff}
button:disabled{opacity:.4}

.sub{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
.sub button{background:#334155;color:#fff;font-size:13px}

.log{
  margin-top:12px;
  background:#020617;
  color:#22c55e;
  font-size:12px;
  padding:10px;
  border-radius:12px;
  height:140px;
  overflow:auto;
}

.marquee{
  background:#dc2626;color:#fff;
  padding:8px;border-radius:10px;
  overflow:hidden;white-space:nowrap;font-weight:700;
}
.marquee span{
  display:inline-block;
  padding-left:100%;
  animation:scroll 12s linear infinite;
}
@keyframes scroll{
  from{transform:translateX(0)}
  to{transform:translateX(-100%)}
}
</style>
</head>

<body>

<header>
  <h1>UDM ESG</h1>
  <div>ä¸Šç­æ‰“å¡ç³»çµ±</div>
</header>

<div class="container">

  <div class="today">
    <div class="date" id="todayDate"></div>
    <div class="week" id="todayWeek"></div>
    <div class="nameBox">
      ğŸ‘¤ <span id="userName"></span>
      <button class="editName" onclick="editName()">âœï¸</button>
    </div>
  </div>

  <div class="status" id="statusBox">è®€å–ä¸­â€¦</div>

  <div class="actions">
    <button id="btnIn" class="btn-in" onclick="punch('ä¸Šç­')">ä¸Šç­æ‰“å¡</button>
    <button id="btnOut" class="btn-out" onclick="punch('ä¸‹ç­')">ä¸‹ç­æ‰“å¡</button>
  </div>

  <div class="sub">
    <button onclick="location.href='Leave.html'">ğŸ“ è«‹å‡</button>
    <button onclick="location.href='HR.html'">ğŸ“Š HR</button>
    <button onclick="showMonthlyLog()">ğŸ“… æœ¬æœˆç´€éŒ„</button>
  </div>

  <div class="log" id="log"></div>
</div>

<script>
const API_PUNCH="https://punch-api.jackey1688.workers.dev/api/punch";
const API_REC="https://punch-api.jackey1688.workers.dev/api/records";

const MAX=2;
let inCnt=0,outCnt=0,lastIn="",lastOut="";
let name=localStorage.getItem("name")||prompt("è«‹è¼¸å…¥å§“å");
localStorage.setItem("name",name);
document.getElementById("userName").innerText=name;

function editName(){
  const n=prompt("æ–°å§“å",name);
  if(!n)return;
  name=n;
  localStorage.setItem("name",name);
  document.getElementById("userName").innerText=name;
}

function renderToday(){
  const d=new Date();
  document.getElementById("todayDate").innerText=d.toISOString().slice(0,10);
  document.getElementById("todayWeek").innerText="æ˜ŸæœŸ"+"æ—¥ä¸€äºŒä¸‰å››äº”å…­"[d.getDay()];
}
renderToday();

function log(t){
  const l=document.getElementById("log");
  l.innerHTML+=t+"<br>";
  l.scrollTop=l.scrollHeight;
}

async function loadStatus(){
  const today=new Date().toISOString().slice(0,10);
  const rec=await (await fetch(API_REC)).json();

  inCnt=outCnt=0;lastIn=lastOut="";
  rec.forEach(r=>{
    if(r.name===name && r.created_at_tw?.startsWith(today)){
      if(r.action==="ä¸Šç­"){inCnt++;lastIn=r.created_at_tw.slice(11,19);}
      if(r.action==="ä¸‹ç­"){outCnt++;lastOut=r.created_at_tw.slice(11,19);}
    }
  });

  document.getElementById("btnIn").disabled=inCnt>=MAX;
  document.getElementById("btnOut").disabled=inCnt===0||outCnt>=MAX;

  let html="";
  const now=new Date();
  const hhmm=now.getHours()*100+now.getMinutes();
  if(hhmm>=910 && inCnt===0){
    html+=`<div class="marquee"><span>âš ï¸ æœ¬æ—¥å°šæœªä¸Šç­æ‰“å¡ï¼Œè«‹å„˜é€Ÿå®Œæˆ âš ï¸</span></div>`;
  }

  html+=`ğŸŸ¢ ä¸Šç­ï¼š${inCnt?lastIn:"å°šæœª"}ï¼ˆ${inCnt}/2ï¼‰<br>
         ğŸ”µ ä¸‹ç­ï¼š${outCnt?lastOut:"â€”"}ï¼ˆ${outCnt}/2ï¼‰`;

  document.getElementById("statusBox").innerHTML=html;
}
loadStatus();

function punch(type){
  const cnt=type==="ä¸Šç­"?inCnt:outCnt;
  if(cnt>=MAX)return alert("å·²é”ä¸Šé™");
  if(cnt===1 && !confirm("ç¬¬äºŒæ¬¡æ‰“å¡ç‚ºä¿®æ­£ï¼Œç¢ºå®šï¼Ÿ"))return;

  navigator.geolocation.getCurrentPosition(async p=>{
    await fetch(API_PUNCH,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({name,action:type,lat:p.coords.latitude,lng:p.coords.longitude})
    });
    log(`âœ… ${type} ç¬¬ ${cnt+1} æ¬¡`);
    loadStatus();
  });
}

async function showMonthlyLog(){
  const ym=new Date().toISOString().slice(0,7);
  const rec=await (await fetch(API_REC)).json();
  document.getElementById("log").innerHTML="ğŸ“… æœ¬æœˆç´€éŒ„<br>";
  rec.filter(r=>r.name===name && r.created_at_tw?.startsWith(ym))
     .forEach(r=>log(`ğŸ•’ ${r.created_at_tw}ï½œ${r.action}`));
}

if("serviceWorker"in navigator){
  navigator.serviceWorker.register("./sw.js");
}
</script>

</body>
</html>
