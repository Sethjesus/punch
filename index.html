<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UDM ESGï½œä¸Šç­æ‰“å¡ç³»çµ±</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#1e293b">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root{
  --bg:#0f172a;
  --card:#f8fafc;
  --primary:#2563eb;
  --success:#16a34a;
  --muted:#64748b;
}
body{
  margin:0;
  background:linear-gradient(180deg,#0f172a,#020617);
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
}
header{
  background:linear-gradient(90deg,#020617,#1e293b);
  color:#fff;
  padding:16px;
  text-align:center;
}
header h1{margin:0;font-size:20px}
header div{font-size:12px;opacity:.85}

.container{
  max-width:420px;
  margin:20px auto;
  background:var(--card);
  border-radius:18px;
  padding:18px;
  box-shadow:0 20px 40px rgba(0,0,0,.35);
}

/* ä»Šæ—¥ */
.today{text-align:center;margin-bottom:10px}
.today .date{font-size:16px;font-weight:700}
.today .week{font-size:13px;color:var(--muted)}

/* å§“å */
.nameBox{
  margin-top:6px;
  font-size:14px;
  color:#334155;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
}
.editName{
  border:0;
  background:#e5e7eb;
  border-radius:6px;
  padding:2px 6px;
  cursor:pointer;
  font-size:12px;
}

/* ç‹€æ…‹ */
.status{
  background:#eef2ff;
  padding:12px;
  border-radius:14px;
  margin-bottom:14px;
  font-size:14px;
}

/* æ‰“å¡ */
.actions{display:flex;gap:10px;margin-bottom:14px}
button{
  flex:1;
  padding:14px;
  border-radius:14px;
  border:0;
  font-size:15px;
  font-weight:700;
  cursor:pointer;
}
button:disabled{opacity:.4;cursor:not-allowed}
.btn-in{background:var(--success);color:#fff}
.btn-out{background:var(--primary);color:#fff}

/* æ¬¡åŠŸèƒ½ */
.sub{display:flex;gap:10px;flex-wrap:wrap}
.sub button{
  padding:10px;
  font-size:13px;
  background:#334155;
  color:#fff;
}

/* å®‰è£æŒ‰éµ */
#btnInstall{
  background:#f59e0b;
  color:#111827;
  font-weight:800;
}

/* Log */
.log{
  margin-top:12px;
  background:#020617;
  color:#22c55e;
  font-size:12px;
  padding:10px;
  border-radius:12px;
  height:140px;
  overflow:auto;
}
</style>
</head>

<body>

<header>
  <h1>UDM ESG</h1>
  <div>ä¸Šç­æ‰“å¡ç³»çµ±</div>
</header>

<div class="container">

  <!-- ä»Šæ—¥ -->
  <div class="today">
    <div class="date" id="todayDate"></div>
    <div class="week" id="todayWeek"></div>

    <!-- å§“å -->
    <div class="nameBox">
      ğŸ‘¤ <span id="userName"></span>
      <button class="editName" onclick="editName()">âœï¸</button>
    </div>
  </div>

  <!-- ç‹€æ…‹ -->
  <div class="status" id="statusBox">è®€å–ä»Šæ—¥ç‹€æ…‹ä¸­â€¦</div>

  <!-- æ‰“å¡ -->
  <div class="actions">
    <button id="btnIn" class="btn-in" onclick="punch('ä¸Šç­')">ä¸Šç­æ‰“å¡</button>
    <button id="btnOut" class="btn-out" onclick="punch('ä¸‹ç­')">ä¸‹ç­æ‰“å¡</button>
  </div>

  <!-- æ¬¡åŠŸèƒ½ -->
  <div class="sub">
    <button onclick="location.href='Leave.html'">ğŸ“ è«‹å‡ / å‡ºå·® / åŠ ç­</button>
    <button onclick="location.href='HR.html'">ğŸ“Š HR ç¸½è¦½</button>
    <button id="btnInstall" style="display:none">â¬‡ ä¸‹è¼‰ App</button>
  </div>

  <!-- Log -->
  <div class="log" id="log"></div>
</div>

<script>
/* ===== API ===== */
const API_PUNCH="https://punch-api.jackey1688.workers.dev/api/punch";
const API_REC="https://punch-api.jackey1688.workers.dev/api/records";

/* ===== å…¬å¸åº§æ¨™ ===== */
const COMPANY_LAT=25.00657;
const COMPANY_LNG=121.48416;

/* ===== äºŒæ¬¡æ©Ÿæœƒè¨­å®š ===== */
const MAX_PUNCH_PER_DAY = 2;

/* ===== åœ‹å®šå‡æ—¥ ===== */
const HOLIDAYS=[
 {start:"2026-02-14",end:"2026-02-22",name:"è¾²æ›†æ˜¥ç¯€"},
 {start:"2026-02-27",end:"2026-03-01",name:"228é€£å‡"},
 {start:"2026-04-03",end:"2026-04-06",name:"æ¸…æ˜é€£å‡"},
 {start:"2026-05-01",end:"2026-05-03",name:"å‹å‹•ç¯€é€£å‡"},
 {start:"2026-06-19",end:"2026-06-21",name:"ç«¯åˆé€£å‡"},
 {start:"2026-09-25",end:"2026-09-28",name:"ä¸­ç§‹/æ•™å¸«ç¯€"},
 {start:"2026-10-09",end:"2026-10-11",name:"åœ‹æ…¶é€£å‡"},
 {start:"2026-10-24",end:"2026-10-26",name:"å…‰å¾©ç¯€"},
 {start:"2026-12-25",end:"2026-12-27",name:"è¡Œæ†²ç´€å¿µæ—¥"}
];

/* ===== DOM ===== */
const logBox=document.getElementById("log");
const statusBox=document.getElementById("statusBox");
const btnIn=document.getElementById("btnIn");
const btnOut=document.getElementById("btnOut");

/* ===== å§“å ===== */
let name=localStorage.getItem("name");
if(!name){
  name=prompt("è«‹è¼¸å…¥å§“å");
  localStorage.setItem("name",name);
}
document.getElementById("userName").innerText=name;

function editName(){
  const newName=prompt("è«‹è¼¸å…¥æ–°çš„å§“å",name);
  if(!newName) return;
  name=newName.trim();
  localStorage.setItem("name",name);
  document.getElementById("userName").innerText=name;
  log(`ğŸ‘¤ å·²åˆ‡æ›ä½¿ç”¨è€…ï¼š${name}`);
}

/* ===== ä»Šæ—¥ ===== */
const now=new Date();
const today=now.toISOString().slice(0,10);
const map=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
document.getElementById("todayDate").innerText=today;
document.getElementById("todayWeek").innerText="é€±"+map[now.getDay()];

/* ===== å·¥å…· ===== */
function log(t){
  logBox.innerHTML+=t+"<br>";
  logBox.scrollTop=logBox.scrollHeight;
}
function distanceMeter(lat1,lng1,lat2,lng2){
  const R=6371000;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLng=(lng2-lng1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
    Math.sin(dLng/2)**2;
  return Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

/* ===== ç‹€æ…‹ï¼ˆå«æ¬¡æ•¸ï¼‰===== */
let todayInCount=0;
let todayOutCount=0;

async function loadStatus(){
  const data=await(await fetch(API_REC)).json();
  todayInCount=0;
  todayOutCount=0;
  let inTime="",outTime="";

  data.forEach(r=>{
    if(r.name===name&&r.created_at_tw?.startsWith(today)){
      if(r.action==="ä¸Šç­"){todayInCount++; inTime=r.created_at_tw.slice(11,19);}
      if(r.action==="ä¸‹ç­"){todayOutCount++; outTime=r.created_at_tw.slice(11,19);}
    }
  });

  btnIn.disabled = todayInCount >= MAX_PUNCH_PER_DAY;
  btnOut.disabled = todayInCount===0 || todayOutCount >= MAX_PUNCH_PER_DAY;

  let notice="";
  let holiday="";
  for(const h of HOLIDAYS){
    if(today>=h.start&&today<=h.end){holiday=h.name;break;}
  }
  if(holiday) notice=`ğŸŒ ä»Šæ—¥ç‚º ${holiday}<br>`;
  else if(now.getDay()===0||now.getDay()===6) notice=`ğŸ”´ ä»Šæ—¥ç‚ºé€±æœ«<br>`;

  statusBox.innerHTML=
    notice+
    `ğŸŸ¢ ä¸Šç­ï¼š${todayInCount?inTime:"å°šæœª"}ï¼ˆ${todayInCount}/2ï¼‰<br>
     ğŸ”µ ä¸‹ç­ï¼š${todayOutCount?outTime:"â€”"}ï¼ˆ${todayOutCount}/2ï¼‰`;
}
loadStatus();

/* ===== æ‰“å¡ï¼ˆå«äºŒæ¬¡ç¢ºèªï¼‰===== */
function punch(action){
  const count = action==="ä¸Šç­"?todayInCount:todayOutCount;
  if(count>=MAX_PUNCH_PER_DAY){
    alert(`âŒ ${action} å·²è¶…éä»Šæ—¥å¯æ“ä½œæ¬¡æ•¸`);
    return;
  }
  if(count===1){
    if(!confirm(`âš ï¸ ä½ ä»Šå¤©å·²ç¶“æ‰“éä¸€æ¬¡ã€Œ${action}ã€\næ˜¯å¦ç¢ºå®šè¦ç¬¬äºŒæ¬¡ä¿®æ­£ï¼Ÿ`)) return;
  }

  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat=pos.coords.latitude;
    const lng=pos.coords.longitude;
    const dist=distanceMeter(COMPANY_LAT,COMPANY_LNG,lat,lng);
    log(`ğŸ“¤ é€å‡º ${action}ï¼ˆç¬¬ ${count+1} æ¬¡ï¼‰â€¦`);

    await fetch(API_PUNCH,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({name,action,lat,lng})
    });

    log(`âœ… ${action} æˆåŠŸï½œè·å…¬å¸ ${dist} m`);
    loadStatus();
  },()=>alert("âŒ ç„¡æ³•å–å¾— GPS"));
}

/* ===== PWA å®‰è£ ===== */
let deferredPrompt;
const btnInstall=document.getElementById("btnInstall");
window.addEventListener("beforeinstallprompt",e=>{
  e.preventDefault();
  deferredPrompt=e;
  btnInstall.style.display="block";
});
btnInstall.addEventListener("click",async()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  const {outcome}=await deferredPrompt.userChoice;
  if(outcome==="accepted") log("â¬‡ å·²é–‹å§‹å®‰è£ App");
  deferredPrompt=null;
});

/* ===== Service Worker ===== */
if("serviceWorker"in navigator){
  navigator.serviceWorker.register("./sw.js");
}
</script>

</body>
</html>
