<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ç°¡æ˜“æ‰“å¡ / è«‹å‡ç³»çµ±</title>
<style>
body { font-family: system-ui; background:#f4f6f8; }
.card { max-width:420px; margin:20px auto; background:#fff; padding:20px; border-radius:12px; }
button { width:100%; padding:12px; margin:6px 0; font-size:16px; }
input, select { width:100%; padding:10px; margin:6px 0; }
h2 { margin-top:0 }
</style>
</head>
<body>

<div class="card">
<h2>ğŸ“ æ‰“å¡ / å¤–å‡º</h2>
<button onclick="punch('in')">ä¸Šç­æ‰“å¡</button>
<button onclick="punch('out')">ä¸‹ç­æ‰“å¡</button>

<select id="reason">
  <option value="">å¤–å‡ºåŸå› ï¼ˆåƒ…å¤–å‡ºç”¨ï¼‰</option>
  <option value="æ´½å…¬">æ´½å…¬</option>
  <option value="å–ä»¶">å–ä»¶</option>
  <option value="æœƒè­°">æœƒè­°</option>
</select>
<button onclick="punch('business')">å¤–å‡ºè¾¦å…¬</button>
</div>

<div class="card">
<h2>ğŸ“ è«‹å‡</h2>
<input id="leaveDate" type="date">
<input id="fromTime" type="time">
<input id="toTime" type="time">
<select id="leaveType">
  <option value="ç‰¹ä¼‘">ç‰¹ä¼‘</option>
  <option value="ç—…å‡">ç—…å‡</option>
  <option value="äº‹å‡">äº‹å‡</option>
</select>
<button onclick="leave()">é€å‡ºè«‹å‡</button>
</div>

<script>
const API = "https://punch-api.jackey1688.workers.dev";
const USER = "jackey";

// å…¬å¸åº§æ¨™
const OFFICE = { lat: 25.04776, lng: 121.53185 };

function getLocation(){
  return new Promise((resolve,reject)=>{
    navigator.geolocation.getCurrentPosition(
      p=>resolve({lat:p.coords.latitude,lng:p.coords.longitude}),
      ()=>reject("ç„¡æ³•å–å¾— GPS"),
      { enableHighAccuracy:true, timeout:10000 }
    );
  });
}

function distanceMeter(lat1,lng1,lat2,lng2){
  const R=6371000,toRad=d=>d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLng=toRad(lng2-lng1);
  const a=Math.sin(dLat/2)**2 +
          Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
          Math.sin(dLng/2)**2;
  return Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

async function punch(type){
  try{
    const loc = await getLocation();
    const dist = distanceMeter(loc.lat,loc.lng,OFFICE.lat,OFFICE.lng);
    const reason = type==="business" ? document.getElementById("reason").value : "";

    await fetch(API+"/api/punch",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        userId:USER,
        type,
        reason,
        lat:loc.lat,
        lng:loc.lng,
        distance:dist
      })
    });

    alert(`å®Œæˆï¼š${type}\nè·å…¬å¸ ${dist} å…¬å°º`);
  }catch(e){
    alert(e);
  }
}

async function leave(){
  if(!leaveDate.value){
    alert("è«‹é¸æ“‡æ—¥æœŸ");
    return;
  }

  await fetch(API+"/api/leave",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      userId:USER,
      date:leaveDate.value,
      from:fromTime.value || null,
      to:toTime.value || null,
      leaveType:leaveType.value
    })
  });

  alert("è«‹å‡å·²é€å‡º");
}
</script>
</body>
</html>
