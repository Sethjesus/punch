<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UDM ESGï½œä¸Šç­æ‰“å¡ç³»çµ±</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#1e293b">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root{
  --bg:#0f172a;
  --card:#f8fafc;
  --primary:#2563eb;
  --success:#16a34a;
  --muted:#64748b;
}
body{
  margin:0;
  background:linear-gradient(180deg,#0f172a,#020617);
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
}
header{
  background:linear-gradient(90deg,#020617,#1e293b);
  color:#fff;
  padding:16px;
  text-align:center;
}
header h1{margin:0;font-size:20px}
header div{font-size:12px;opacity:.85}

.container{
  max-width:420px;
  margin:20px auto;
  background:var(--card);
  border-radius:18px;
  padding:18px;
  box-shadow:0 20px 40px rgba(0,0,0,.35);
}

/* ä»Šæ—¥ */
.today{text-align:center;margin-bottom:10px}
.today .date{font-size:16px;font-weight:700}
.today .week{font-size:13px;color:var(--muted)}

/* å§“å */
.nameBox{
  margin-top:6px;
  font-size:14px;
  color:#334155;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
}
.editName{
  border:0;
  background:#e5e7eb;
  border-radius:6px;
  padding:2px 6px;
  cursor:pointer;
  font-size:12px;
}

/* ç‹€æ…‹ */
.status{
  background:#eef2ff;
  padding:12px;
  border-radius:14px;
  margin-bottom:14px;
  font-size:14px;
}

/* æ‰“å¡ */
.actions{display:flex;gap:10px;margin-bottom:14px}
button{
  flex:1;
  padding:14px;
  border-radius:14px;
  border:0;
  font-size:15px;
  font-weight:700;
  cursor:pointer;
}
button:disabled{opacity:.4;cursor:not-allowed}
.btn-in{background:var(--success);color:#fff}
.btn-out{background:var(--primary);color:#fff}

/* æ¬¡åŠŸèƒ½ */
.sub{display:flex;gap:10px;flex-wrap:wrap}
.sub button{
  padding:10px;
  font-size:13px;
  background:#334155;
  color:#fff;
}

/* å®‰è£æŒ‰éµ */
#btnInstall{
  background:#f59e0b;
  color:#111827;
  font-weight:800;
}

/* Log */
.log{
  margin-top:12px;
  background:#020617;
  color:#22c55e;
  font-size:12px;
  padding:10px;
  border-radius:12px;
  height:140px;
  overflow:auto;
}

/* æé†’æ¨£å¼ */
.reminder-today {
  background:#fef3c7;
  color:#92400e;
  padding:8px 12px;
  border-radius:8px;
  margin:8px 0;
  border-left:4px solid #f59e0b;
}
.reminder-yesterday {
  background:#dbeafe;
  color:#1e40af;
  padding:8px 12px;
  border-radius:8px;
  margin:8px 0;
  border-left:4px solid #3b82f6;
}
.reminder-tomorrow {
  background:#fef9c3;
  color:#854d0e;
  padding:8px 12px;
  border-radius:8px;
  margin:8px 0;
  border-left:4px solid #f59e0b;
}
.reminder-optional {
  background:#e0f2fe;
  color:#0369a1;
  padding:8px 12px;
  border-radius:8px;
  margin:8px 0;
  border-left:4px solid #0ea5e9;
}
.reminder-meeting {
  background:#f0f9ff;
  color:#0c4a6e;
  padding:10px 12px;
  border-radius:8px;
  margin:8px 0;
  border-left:4px solid #0284c7;
  border-top:2px solid #bae6fd;
}
.reminder-business {
  background:#f0fdf4;
  color:#166534;
  padding:10px 12px;
  border-radius:8px;
  margin:8px 0;
  border-left:4px solid #16a34a;
  border-top:2px solid #bbf7d0;
}
.reminder-cooldown {
  background:#fef3c7;
  color:#92400e;
  padding:8px 12px;
  border-radius:8px;
  margin:8px 0;
  border-left:4px solid #f59e0b;
  font-size: 12px;
}

/* æœƒè­°è©³ç´°è³‡è¨Š */
.meeting-details {
  margin-top: 8px;
  padding: 8px;
  background: rgba(255, 255, 255, 0.7);
  border-radius: 6px;
  border: 1px solid #bae6fd;
}
.business-details {
  margin-top: 8px;
  padding: 8px;
  background: rgba(255, 255, 255, 0.7);
  border-radius: 6px;
  border: 1px solid #bbf7d0;
}
.detail-item {
  display: flex;
  justify-content: space-between;
  margin: 4px 0;
  font-size: 12px;
}
.detail-label {
  color: #475569;
  font-weight: 600;
  min-width: 60px;
}
.detail-value {
  color: #1e293b;
  text-align: right;
  flex: 1;
  margin-left: 12px;
}

/* æ™‚é–“é¡¯ç¤ºæ¨£å¼ */
.time-display {
  font-family: 'Courier New', monospace;
  font-weight: bold;
  margin: 4px 0;
}
.time-label {
  color: #4b5563;
  font-size: 12px;
}
.time-value {
  color: #1f2937;
  font-size: 14px;
  background: #f3f4f6;
  padding: 4px 8px;
  border-radius: 6px;
  display: inline-block;
  margin-left: 4px;
}

/* ç‹€æ…‹ç´€éŒ„æ¨£å¼ */
.status-record {
  background: #f8fafc;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 10px;
  margin: 8px 0;
}
.status-title {
  font-weight: bold;
  color: #374151;
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.status-details {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px;
  font-size: 12px;
}
.status-item {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  border-bottom: 1px dashed #e5e7eb;
}
.status-label {
  color: #6b7280;
}
.status-value {
  font-weight: 600;
  color: #1f2937;
}

/* ç•¶æœˆç´€éŒ„æ¨£å¼ */
.monthly-record {
  margin: 8px 0;
  padding: 8px;
  background: #f9fafb;
  border-radius: 6px;
  border-left: 4px solid #3b82f6;
}
.record-date {
  font-weight: bold;
  color: #1f2937;
  margin-bottom: 4px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.record-items {
  margin-left: 12px;
}
.record-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 2px 0;
  font-size: 12px;
}
.record-time {
  font-family: 'Courier New', monospace;
  color: #059669;
  font-weight: 600;
}
.record-action {
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: 600;
}
.action-in {
  background: #dcfce7;
  color: #166534;
}
.action-out {
  background: #dbeafe;
  color: #1e40af;
}
.action-special {
  background: #fef3c7;
  color: #92400e;
}

/* è·é›¢é¡¯ç¤ºæ¨£å¼ */
.distance-badge {
  font-size: 10px;
  padding: 1px 4px;
  border-radius: 4px;
  margin-left: 4px;
  font-weight: 600;
}
.distance-near {
  background: #dcfce7;
  color: #166534;
}
.distance-far {
  background: #fef3c7;
  color: #92400e;
}
.distance-very-far {
  background: #fee2e2;
  color: #dc2626;
}

/* æ‰“å¡æ˜ç´°é …ç›® */
.record-detail {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 4px 0;
  border-bottom: 1px solid #f1f5f9;
}
.record-detail:last-child {
  border-bottom: none;
}
.record-info {
  display: flex;
  align-items: center;
  gap: 8px;
}
.record-number {
  color: #64748b;
  font-size: 11px;
  min-width: 20px;
}
.record-time-distance {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.record-distance {
  font-size: 10px;
  color: #64748b;
  display: flex;
  align-items: center;
  gap: 4px;
}

/* å†·å»è¨ˆæ™‚å™¨ */
.cooldown-timer {
  display: inline-block;
  background: #dc2626;
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: bold;
  margin-left: 4px;
  animation: pulse 1s infinite;
}
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}

/* ===== æ–°å¢ï¼šä¸»ç®¡è¨»è§£æ¨£å¼ ===== */
.comment-section {
  margin: 16px 0 8px 0;
  padding: 12px;
  background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
  border-radius: 12px;
  border: 1px solid #bae6fd;
  border-left: 4px solid #0284c7;
}

.comment-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
  font-weight: 600;
  color: #0c4a6e;
}

.comment-content {
  background: rgba(255, 255, 255, 0.95);
  padding: 12px;
  border-radius: 8px;
  font-size: 13px;
  line-height: 1.5;
  color: #1e293b;
  white-space: pre-wrap;
  word-break: break-word;
  border: 1px solid #e2e8f0;
  max-height: 200px;
  overflow-y: auto;
}

.comment-empty {
  color: #64748b;
  font-style: italic;
  text-align: center;
  padding: 20px;
  background: #f8fafc;
  border-radius: 6px;
}

.comment-date {
  font-size: 11px;
  color: #64748b;
  text-align: right;
  margin-top: 6px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.comment-badge {
  background: #0284c7;
  color: white;
  font-size: 10px;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 600;
}

.comment-loading {
  text-align: center;
  padding: 20px;
  color: #64748b;
}

.comment-error {
  background: #fee2e2;
  color: #dc2626;
  padding: 10px;
  border-radius: 6px;
  font-size: 12px;
  text-align: center;
  border: 1px solid #fecaca;
}

.comment-reload-btn {
  background: #0284c7;
  color: white;
  border: none;
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 11px;
  cursor: pointer;
  font-weight: 600;
  margin-top: 8px;
}

.comment-reload-btn:hover {
  background: #0369a1;
}

.comment-recent-item {
  margin-bottom: 10px;
  padding-bottom: 10px;
  border-bottom: 1px dashed #e2e8f0;
}

.comment-recent-item:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}
</style>
</head>

<body>

<header>
  <h1>UDM ESG</h1>
  <div>ä¸Šç­æ‰“å¡ç³»çµ±</div>
</header>

<div class="container">

  <!-- ä»Šæ—¥ -->
  <div class="today">
    <div class="date" id="todayDate"></div>
    <div class="week" id="todayWeek"></div>
    
    <!-- ç•¶å‰æ™‚é–“ -->
    <div id="currentTime" class="time-display" style="margin-top: 8px;"></div>

    <!-- å§“å -->
    <div class="nameBox">
      ğŸ‘¤ <span id="userName"></span>
      <button class="editName" onclick="editName()">âœï¸</button>
    </div>
  </div>

  <!-- ç‹€æ…‹ -->
  <div class="status" id="statusBox">è®€å–ä»Šæ—¥ç‹€æ…‹ä¸­â€¦</div>

  <!-- ä¸»ç®¡è¨»è§£å€åŸŸï¼ˆå‹•æ…‹è¼‰å…¥ï¼‰ -->
  <div id="commentSection"></div>

  <!-- æ‰“å¡ -->
  <div class="actions">
    <button id="btnIn" class="btn-in" onclick="punch('ä¸Šç­')">ä¸Šç­æ‰“å¡</button>
    <button id="btnOut" class="btn-out" onclick="punch('ä¸‹ç­')">ä¸‹ç­æ‰“å¡</button>
  </div>

  <!-- æ¬¡åŠŸèƒ½ -->
  <div class="sub">
    <button onclick="location.href='Leave.html'">ğŸ“ è«‹å‡ / å‡ºå·® / æœƒè­°</button>
    <button onclick="toggleMonthly()">ğŸ“… ç•¶æœˆæ‰“å¡ç´€éŒ„</button>
    <button id="btnInstall" style="display:none">â¬‡ ä¸‹è¼‰ App</button>
  </div>

  <!-- Log -->
  <div class="log" id="log"></div>
  <div class="log" id="monthlyBox" style="display:none"></div>
</div>

<script>
/* ===== API ===== */
const API_PUNCH = "https://punch-api.jackey1688.workers.dev/api/punch";
const API_REC = "https://punch-api.jackey1688.workers.dev/api/records";
const API_LEAVE = "https://punch-api.jackey1688.workers.dev/api/leave";

/* ===== å…¬å¸åº§æ¨™ ===== */
const COMPANY_LAT = 25.00657;
const COMPANY_LNG = 121.48416;

/* ===== è·é›¢åˆ†é¡ ===== */
const DISTANCE_THRESHOLD_NEAR = 35; // 35å…¬å°ºå…§ç‚ºè¿‘è·é›¢ï¼ˆç¶ è‰²ï¼‰
const DISTANCE_THRESHOLD_MEDIUM = 100; // 100å…¬å°ºå…§ç‚ºä¸­è·é›¢ï¼ˆé»ƒè‰²ï¼‰

/* ===== æ‰“å¡é™åˆ¶è¨­å®š ===== */
const MAX_PUNCH_PER_ACTION = 2; // ä¸Šä¸‹ç­å„åªèƒ½æ‰“2æ¬¡
const COOLDOWN_MS = 2 * 60 * 1000; // 2åˆ†é˜å†·å»æ™‚é–“
const COOLDOWN_KEY = "lastPunchTime";

/* ===== åœ‹å®šå‡æ—¥ ===== */
const HOLIDAYS = [
  {start:"2026-02-14",end:"2026-02-22",name:"è¾²æ›†æ˜¥ç¯€"},
  {start:"2026-02-27",end:"2026-03-01",name:"228é€£å‡"},
  {start:"2026-04-03",end:"2026-04-06",name:"æ¸…æ˜é€£å‡"},
  {start:"2026-05-01",end:"2026-05-03",name:"å‹å‹•ç¯€é€£å‡"},
  {start:"2026-06-19",end:"2026-06-21",name:"ç«¯åˆé€£å‡"},
  {start:"2026-09-25",end:"2026-09-28",name:"ä¸­ç§‹/æ•™å¸«ç¯€"},
  {start:"2026-10-09",end:"2026-10-11",name:"åœ‹æ…¶é€£å‡"},
  {start:"2026-10-24",end:"2026-10-26",name:"å…‰å¾©ç¯€"},
  {start:"2026-12-25",end:"2026-12-27",name:"è¡Œæ†²ç´€å¿µæ—¥"}
];

/* ===== DOM ===== */
const logBox = document.getElementById("log");
const statusBox = document.getElementById("statusBox");
const btnIn = document.getElementById("btnIn");
const btnOut = document.getElementById("btnOut");
const currentTimeDisplay = document.getElementById("currentTime");
const commentSection = document.getElementById("commentSection");

/* ===== å°ç£æ™‚é–“å·¥å…·å‡½æ•¸ ===== */
function getTaiwanDate() {
  const now = new Date();
  return now;
}

function formatTaiwanDate(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

function formatTaiwanDateTime(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
}

function formatTimeOnly(date) {
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  return `${hours}:${minutes}:${seconds}`;
}

/* ===== å³æ™‚æ™‚é–“é¡¯ç¤º ===== */
function updateCurrentTime() {
  const now = getTaiwanDate();
  const dateStr = formatTaiwanDate(now);
  const timeStr = formatTimeOnly(now);
  const timezoneStr = `(UTC${now.getTimezoneOffset() > 0 ? '-' : '+'}${Math.abs(now.getTimezoneOffset())/60})`;
  
  currentTimeDisplay.innerHTML = `
    <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
      <span>ğŸ•’ <span class="time-label">ç¾åœ¨æ™‚é–“ï¼š</span></span>
      <span class="time-value">${dateStr} ${timeStr}</span>
      <span style="font-size: 10px; color: #6b7280;">${timezoneStr}</span>
    </div>
  `;
}

// æ¯ç§’æ›´æ–°æ™‚é–“
updateCurrentTime();
setInterval(updateCurrentTime, 1000);

/* ===== ä»Šæ—¥ ===== */
const now = getTaiwanDate();
const today = formatTaiwanDate(now);
const map = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];
document.getElementById("todayDate").innerText = today;
document.getElementById("todayWeek").innerText = "é€±" + map[now.getDay()];

/* ===== å§“å ===== */
let name = localStorage.getItem("name");
if (!name) {
  name = prompt("è«‹è¼¸å…¥å§“å");
  localStorage.setItem("name", name);
}
document.getElementById("userName").innerText = name;

function editName() {
  const newName = prompt("è«‹è¼¸å…¥æ–°çš„å§“å", name);
  if (!newName) return;
  name = newName.trim();
  localStorage.setItem("name", name);
  document.getElementById("userName").innerText = name;
  log(`ğŸ‘¤ ${formatTimeOnly(getTaiwanDate())} å·²åˆ‡æ›ä½¿ç”¨è€…ï¼š${name}`);
  loadStatus();
  loadComments();
}

/* ===== å·¥å…· ===== */
function log(t) {
  const time = formatTimeOnly(getTaiwanDate());
  logBox.innerHTML += `<span style="color:#94a3b8">[${time}]</span> ${t}<br>`;
  logBox.scrollTop = logBox.scrollHeight;
}

function distanceMeter(lat1, lng1, lat2, lng2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLng / 2) ** 2;
  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
}

/* ===== å†·å»æ™‚é–“å·¥å…· ===== */
function isInCooldown() {
  const lastTime = localStorage.getItem(COOLDOWN_KEY);
  if (!lastTime) return false;
  const timeDiff = Date.now() - parseInt(lastTime);
  return timeDiff < COOLDOWN_MS;
}

function getCooldownRemaining() {
  const lastTime = localStorage.getItem(COOLDOWN_KEY);
  if (!lastTime) return 0;
  const timeDiff = Date.now() - parseInt(lastTime);
  const remaining = COOLDOWN_MS - timeDiff;
  return Math.max(0, Math.ceil(remaining / 1000));
}

function formatCooldownTime(seconds) {
  const mins = Math.floor(seconds / 60);
  const secs = seconds % 60;
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function setCooldown() {
  localStorage.setItem(COOLDOWN_KEY, Date.now().toString());
}

/* ===== è·é›¢é¡¯ç¤ºå·¥å…· ===== */
function getDistanceClass(distance) {
  if (distance <= DISTANCE_THRESHOLD_NEAR) {
    return "distance-near";
  } else if (distance <= DISTANCE_THRESHOLD_MEDIUM) {
    return "distance-far";
  } else {
    return "distance-very-far";
  }
}

function formatDistance(distance) {
  if (distance < 1000) {
    return `${distance} m`;
  } else {
    return `${(distance / 1000).toFixed(1)} km`;
  }
}

/* ===== å–å¾—å‡ºå·®/æœƒè­°è³‡è¨Š ===== */
async function getBusinessInfo() {
  try {
    const response = await fetch(API_LEAVE);
    if (!response.ok) {
      throw new Error(`API éŒ¯èª¤: ${response.status}`);
    }
    const list = await response.json();
    
    const taiwanToday = getTaiwanDate();
    const taiwanDateStr = formatTaiwanDate(taiwanToday);
    
    const taiwanYesterday = new Date(taiwanToday);
    taiwanYesterday.setDate(taiwanYesterday.getDate() - 1);
    const yesterdayStr = formatTaiwanDate(taiwanYesterday);
    
    const taiwanTomorrow = new Date(taiwanToday);
    taiwanTomorrow.setDate(taiwanTomorrow.getDate() + 1);
    const tomorrowStr = formatTaiwanDate(taiwanTomorrow);
    
    let todayBiz = null;
    let yesterdayBiz = null;
    let tomorrowBiz = null;
    
    const userBiz = list.filter(item => 
      item.name === name && 
      item.approved === 1 && 
      (item.type === "å‡ºå·®" || item.type === "æœƒè­°")
    );
    
    userBiz.forEach(item => {
      const startDate = item.start_date;
      const endDate = item.end_date;
      
      if (taiwanDateStr >= startDate && taiwanDateStr <= endDate) {
        todayBiz = item;
      }
      
      if (yesterdayStr >= startDate && yesterdayStr <= endDate) {
        yesterdayBiz = item;
      }
      
      if (tomorrowStr >= startDate && tomorrowStr <= endDate) {
        tomorrowBiz = item;
      }
    });
    
    return { todayBiz, yesterdayBiz, tomorrowBiz };
  } catch (error) {
    console.error("å–å¾—å‡ºå·®/æœƒè­°è³‡è¨Šå¤±æ•—:", error);
    log(`âŒ å–å¾—å‡ºå·®/æœƒè­°è³‡è¨Šå¤±æ•—: ${error.message}`);
    return { todayBiz: null, yesterdayBiz: null, tomorrowBiz: null };
  }
}

/* ===== å»ºç«‹æœƒè­°/å‡ºå·®è©³ç´°è³‡è¨ŠHTML ===== */
function createBusinessDetailsHTML(biz, isToday = true) {
  if (!biz) return '';
  
  const typeEmoji = biz.type === "æœƒè­°" ? "ğŸ’¼" : "âœˆï¸";
  const reminderClass = biz.type === "æœƒè­°" ? "reminder-meeting" : "reminder-business";
  const detailsClass = biz.type === "æœƒè­°" ? "meeting-details" : "business-details";
  const timePrefix = isToday ? "ä»Šæ—¥" : "æ˜æ—¥";
  
  let html = `<div class="${reminderClass}">
    <div style="font-weight: bold; margin-bottom: 6px;">
      ${typeEmoji} ${timePrefix}ç‚º <strong>${biz.type}</strong> æœŸé–“
    </div>`;
  
  html += `<div class="${detailsClass}">`;
  
  if (biz.reason) {
    html += `<div class="detail-item">
      <span class="detail-label">äº‹ç”±ï¼š</span>
      <span class="detail-value">${biz.reason}</span>
    </div>`;
  }
  
  if (biz.location) {
    html += `<div class="detail-item">
      <span class="detail-label">åœ°é»ï¼š</span>
      <span class="detail-value">${biz.location}</span>
    </div>`;
  }
  
  html += `<div class="detail-item">
    <span class="detail-label">æœŸé–“ï¼š</span>
    <span class="detail-value">${biz.start_date} ï½ ${biz.end_date}</span>
  </div>`;
  
  const fields = [
    { key: 'description', label: 'èªªæ˜' },
    { key: 'notes', label: 'å‚™è¨»' },
    { key: 'contact_person', label: 'è¯çµ¡äºº' },
    { key: 'contact_phone', label: 'è¯çµ¡é›»è©±' }
  ];
  
  fields.forEach(field => {
    if (biz[field.key]) {
      html += `<div class="detail-item">
        <span class="detail-label">${field.label}ï¼š</span>
        <span class="detail-value">${biz[field.key]}</span>
      </div>`;
    }
  });
  
  if (isToday) {
    html += `<div class="detail-item" style="margin-top: 8px; padding-top: 8px; border-top: 1px dashed #cbd5e1;">
      <span class="detail-label">æ‰“å¡ï¼š</span>
      <span class="detail-value" style="color: #059669; font-weight: bold;">
        âœ… å¯è‡ªç”±é¸æ“‡æ˜¯å¦æ‰“å¡
      </span>
    </div>`;
  }
  
  html += `</div></div>`;
  
  return html;
}

/* ===== è¼‰å…¥ä¸»ç®¡è¨»è§£ ===== */
async function loadComments() {
  try {
    const today = formatTaiwanDate(getTaiwanDate());
    
    commentSection.innerHTML = `
      <div class="comment-loading">
        <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:8px;">
          <div style="width:16px;height:16px;border:2px solid #64748b;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;"></div>
          <span>è¼‰å…¥ä¸»ç®¡è¨»è§£ä¸­...</span>
        </div>
      </div>
    `;
    
    const leaveResponse = await fetch(API_LEAVE);
    let allLeaves = [];
    
    try {
      allLeaves = await leaveResponse.json();
      console.log('å–å¾—çš„è«‹å‡è³‡æ–™:', allLeaves);
    } catch (parseError) {
      console.error('è§£æè«‹å‡è³‡æ–™å¤±æ•—:', parseError);
      throw new Error('è«‹å‡è³‡æ–™æ ¼å¼éŒ¯èª¤');
    }
    
    if (!Array.isArray(allLeaves)) {
      console.error('è«‹å‡è³‡æ–™ä¸æ˜¯é™£åˆ—:', allLeaves);
      allLeaves = [];
    }
    
    const userLeaves = allLeaves.filter(leave => leave.name === name);
    console.log(`ä½¿ç”¨è€… ${name} çš„è«‹å‡è¨˜éŒ„:`, userLeaves);
    
    // æ‰¾å‡ºä»Šå¤©ç›¸é—œä¸”æœ‰è¨»è§£çš„ç”³è«‹
    const todayLeaves = allLeaves.filter(leave => {
      if (!leave.name || leave.name !== name) return false;
      if (!leave.start_date || !leave.end_date) return false;
      
      const startDate = leave.start_date;
      const endDate = leave.end_date;
      
      const isTodayInRange = today >= startDate && today <= endDate;
      const hasComment = leave.comment && leave.comment.trim() !== '';
      
      return isTodayInRange && hasComment;
    });
    
    console.log(`ä»Šå¤©ç›¸é—œä¸”æœ‰è¨»è§£çš„ç”³è«‹:`, todayLeaves);
    
    let commentHTML = '';
    
    if (todayLeaves.length > 0) {
      // é¡¯ç¤ºä»Šå¤©çš„è¨»è§£
      todayLeaves.forEach((leave, index) => {
        let dateStr = today;
        let timeStr = '';
        
        if (leave.updated_at_tw) {
          const parts = leave.updated_at_tw.split(' ');
          if (parts.length >= 1) dateStr = parts[0];
          if (parts.length >= 2) timeStr = parts[1].substring(0, 5);
        } else if (leave.created_at_tw) {
          const parts = leave.created_at_tw.split(' ');
          if (parts.length >= 1) dateStr = parts[0];
          if (parts.length >= 2) timeStr = parts[1].substring(0, 5);
        }
        
        let statusBadge = '';
        if (leave.withdrawn === 1) {
          statusBadge = '<span style="background:#9ca3af;margin-left:6px;" class="comment-badge">å·²æ’¤å›</span>';
        } else if (leave.approved === 1) {
          statusBadge = '<span style="background:#059669;margin-left:6px;" class="comment-badge">å·²æ ¸å‡†</span>';
        } else {
          statusBadge = '<span style="background:#d97706;margin-left:6px;" class="comment-badge">å¯©æ ¸ä¸­</span>';
        }
        
        commentHTML += `
          <div class="comment-section">
            <div class="comment-header">
              <span>ğŸ’¬ ä¸»ç®¡è¨»è§£</span>
              <span class="comment-badge">${leave.type || 'ç”³è«‹'}</span>
              ${statusBadge}
            </div>
            <div class="comment-content">
              ${leave.comment.replace(/\n/g, '<br>')}
            </div>
            <div class="comment-date">
              <span>æœŸé–“ï¼š${leave.start_date} ~ ${leave.end_date}</span>
              <span>${dateStr} ${timeStr}</span>
            </div>
          </div>
        `;
      });
    } else {
      // æª¢æŸ¥æœ€è¿‘7å¤©å…§æ˜¯å¦æœ‰è¨»è§£
      const sevenDaysAgo = new Date(getTaiwanDate());
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
      const sevenDaysAgoStr = formatTaiwanDate(sevenDaysAgo);
      
      const recentComments = allLeaves.filter(leave => {
        if (!leave.name || leave.name !== name) return false;
        if (!leave.comment || leave.comment.trim() === '') return false;
        
        const checkDate = leave.updated_at_tw || leave.created_at_tw;
        if (!checkDate) return false;
        
        const datePart = checkDate.split(' ')[0];
        return datePart >= sevenDaysAgoStr;
      });
      
      console.log(`æœ€è¿‘7å¤©å…§çš„è¨»è§£:`, recentComments);
      
      if (recentComments.length > 0) {
        // æŒ‰æ™‚é–“å€’åºæ’åº
        recentComments.sort((a, b) => {
          const dateA = a.updated_at_tw || a.created_at_tw || '';
          const dateB = b.updated_at_tw || b.created_at_tw || '';
          return dateB.localeCompare(dateA);
        });
        
        // åªé¡¯ç¤ºæœ€è¿‘çš„3ç­†è¨»è§£
        const displayComments = recentComments.slice(0, 3);
        
        commentHTML += `
          <div class="comment-section">
            <div class="comment-header">
              <span>ğŸ“‹ è¿‘æœŸä¸»ç®¡è¨»è§£</span>
              <span class="comment-badge">${displayComments.length}ç­†</span>
            </div>
            <div class="comment-content">
              ${displayComments.map((leave, index) => {
                const checkDate = leave.updated_at_tw || leave.created_at_tw || '';
                const datePart = checkDate.split(' ')[0] || '';
                const timePart = checkDate.split(' ')[1] ? checkDate.split(' ')[1].substring(0, 5) : '';
                const commentPreview = leave.comment.length > 60 ? 
                  leave.comment.substring(0, 60) + '...' : 
                  leave.comment;
                
                return `
                  <div class="comment-recent-item">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                      <div>
                        <strong style="color: #0284c7;">${leave.type || 'ç”³è«‹'}</strong>
                        <span style="font-size: 10px; color: #64748b; margin-left: 6px;">
                          ${datePart}
                        </span>
                      </div>
                      <span style="font-size: 10px; color: ${leave.approved === 1 ? '#059669' : leave.withdrawn === 1 ? '#9ca3af' : '#d97706'};">
                        ${leave.withdrawn === 1 ? 'å·²æ’¤å›' : leave.approved === 1 ? 'å·²æ ¸å‡†' : 'å¯©æ ¸ä¸­'}
                      </span>
                    </div>
                    <div style="font-size: 12px; color: #475569;">
                      ${commentPreview.replace(/\n/g, ' ')}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
            <div class="comment-date">
              <span>æœ€è¿‘7å¤©å…§æœ‰ ${recentComments.length} ç­†è¨»è§£</span>
            </div>
          </div>
        `;
      } else {
        // å®Œå…¨æ²’æœ‰è¨»è§£
        commentHTML = `
          <div class="comment-section">
            <div class="comment-header">
              <span>ğŸ’¬ ä¸»ç®¡è¨»è§£</span>
            </div>
            <div class="comment-empty">
              ç›®å‰å°šç„¡ä¸»ç®¡è¨»è§£è¨˜éŒ„
              <div style="margin-top: 8px; font-size: 11px; color: #94a3b8;">
                ä¸»ç®¡çš„è¨»è§£æœƒé¡¯ç¤ºåœ¨é€™è£¡
              </div>
            </div>
          </div>
        `;
      }
    }
    
    commentSection.innerHTML = commentHTML;
    
    console.log('è¨»è§£é¡¯ç¤ºå®Œæˆ:', {
      ä»Šå¤©ç”³è«‹æ•¸é‡: todayLeaves.length,
      ä»Šå¤©ç”³è«‹è©³æƒ…: todayLeaves.map(l => ({ type: l.type, è¨»è§£é•·åº¦: l.comment?.length }))
    });
    
  } catch (error) {
    console.error('è¼‰å…¥ä¸»ç®¡è¨»è§£å¤±æ•—:', error);
    commentSection.innerHTML = `
      <div class="comment-error">
        âŒ ç„¡æ³•è¼‰å…¥ä¸»ç®¡è¨»è§£<br>
        <small style="color: #9ca3af;">éŒ¯èª¤ï¼š${error.message}</small>
        <div style="margin-top: 8px;">
          <button class="comment-reload-btn" onclick="loadComments()">
            é‡æ–°è¼‰å…¥
          </button>
        </div>
      </div>
    `;
  }
}

/* ===== ç‹€æ…‹é¡¯ç¤º ===== */
let todayRecords = [];
let todayInCount = 0;
let todayOutCount = 0;

async function loadStatus() {
  try {
    const data = await (await fetch(API_REC)).json();
    todayRecords = [];
    todayInCount = 0;
    todayOutCount = 0;
    let firstInTime = "", lastInTime = "";
    let firstOutTime = "", lastOutTime = "";

    data.forEach(r => {
      if (!r.created_at_tw) return;
      
      const recordDateStr = r.created_at_tw.split(' ')[0];
      
      if (r.name === name && recordDateStr === today) {
        const recordTime = r.created_at_tw.split(' ')[1];
        const distance = r.distance ? parseInt(r.distance) : null;
        
        todayRecords.push({
          action: r.action,
          time: recordTime,
          fullTime: r.created_at_tw,
          lat: r.lat,
          lng: r.lng,
          distance: distance
        });
        
        if (r.action === "ä¸Šç­") { 
          todayInCount++;
          if (!firstInTime) firstInTime = recordTime;
          lastInTime = recordTime;
        }
        if (r.action === "ä¸‹ç­") { 
          todayOutCount++;
          if (!firstOutTime) firstOutTime = recordTime;
          lastOutTime = recordTime;
        }
      }
    });

    const { todayBiz, yesterdayBiz, tomorrowBiz } = await getBusinessInfo();
    
    let statusHTML = "";
    
    statusHTML += `<div class="status-record">
      <div class="status-title">
        ğŸ“Š ä»Šæ—¥æ‰“å¡ç‹€æ…‹
        <span style="font-size:11px;color:#6b7280;margin-left:auto">
          ${formatTaiwanDateTime(getTaiwanDate())}
        </span>
      </div>
      <div class="status-details">
        <div class="status-item">
          <span class="status-label">ä¸Šç­æ‰“å¡ï¼š</span>
          <span class="status-value">${todayInCount > 0 ? lastInTime : "å°šæœªæ‰“å¡"} (${todayInCount}/${MAX_PUNCH_PER_ACTION})</span>
        </div>
        <div class="status-item">
          <span class="status-label">ä¸‹ç­æ‰“å¡ï¼š</span>
          <span class="status-value">${todayOutCount > 0 ? lastOutTime : "å°šæœªæ‰“å¡"} (${todayOutCount}/${MAX_PUNCH_PER_ACTION})</span>
        </div>
        <div class="status-item">
          <span class="status-label">ä»Šæ—¥æ‰“å¡æ¬¡æ•¸ï¼š</span>
          <span class="status-value">${todayRecords.length} æ¬¡</span>
        </div>
        <div class="status-item">
          <span class="status-label">ä»Šæ—¥ç‹€æ…‹ï¼š</span>
          <span class="status-value">
            ${todayInCount > 0 && todayOutCount > 0 ? 'âœ… å·²å®Œæˆæ‰“å¡' : 
              todayInCount > 0 ? 'ğŸŸ¡ å·²ä¸Šç­' : 'ğŸ”´ æœªä¸Šç­'}
          </span>
        </div>
      </div>
    </div>`;
    
    let holiday = "";
    for (const h of HOLIDAYS) {
      if (today >= h.start && today <= h.end) { 
        holiday = h.name; 
        break; 
      }
    }
    
    const taiwanTomorrow = new Date(now);
    taiwanTomorrow.setDate(taiwanTomorrow.getDate() + 1);
    const tomorrowStr = formatTaiwanDate(taiwanTomorrow);
    
    let tomorrowHoliday = "";
    for (const h of HOLIDAYS) {
      if (tomorrowStr >= h.start && tomorrowStr <= h.end) { 
        tomorrowHoliday = h.name; 
        break; 
      }
    }
    
    if (holiday) {
      statusHTML += `<div class="reminder-today">
        ğŸŒ ä»Šæ—¥ç‚º <strong>${holiday}</strong>ï¼Œå…æ‰“å¡
      </div>`;
      btnIn.disabled = true;
      btnOut.disabled = true;
      
      if (todayBiz) {
        statusHTML += createBusinessDetailsHTML(todayBiz, true);
      }
    } else if (now.getDay() === 0 || now.getDay() === 6) {
      statusHTML += `<div class="reminder-today">ğŸ”´ ä»Šæ—¥ç‚ºé€±æœ«ï¼Œå…æ‰“å¡</div>`;
      btnIn.disabled = true;
      btnOut.disabled = true;
      
      if (todayBiz) {
        statusHTML += createBusinessDetailsHTML(todayBiz, true);
      }
    } else {
      if (todayBiz) {
        statusHTML += createBusinessDetailsHTML(todayBiz, true);
        btnIn.disabled = todayInCount >= MAX_PUNCH_PER_ACTION || isInCooldown();
        btnOut.disabled = todayOutCount >= MAX_PUNCH_PER_ACTION || isInCooldown() || todayInCount === 0;
      } else {
        btnIn.disabled = todayInCount >= MAX_PUNCH_PER_ACTION || isInCooldown();
        btnOut.disabled = todayOutCount >= MAX_PUNCH_PER_ACTION || isInCooldown() || todayInCount === 0;
      }
    }
    
    if (tomorrowBiz) {
      statusHTML += createBusinessDetailsHTML(tomorrowBiz, false);
    }
    
    if (tomorrowHoliday) {
      statusHTML += `<div class="reminder-tomorrow">
        ğŸŒ æ˜æ—¥ç‚º <strong>${tomorrowHoliday}</strong><br>
        ğŸ’¡ æ˜æ—¥å…æ‰“å¡
      </div>`;
    }
    
    if (yesterdayBiz) {
      statusHTML += `<div class="reminder-yesterday">
        ğŸ“Œ æ˜¨æ—¥ç‚º <strong>${yesterdayBiz.type}</strong> æœŸé–“<br>
        ğŸ“… æœŸé–“ï¼š${yesterdayBiz.start_date} ï½ ${yesterdayBiz.end_date}
      </div>`;
    }
    
    if (isInCooldown() && !holiday && now.getDay() !== 0 && now.getDay() !== 6) {
      const remainingSeconds = getCooldownRemaining();
      statusHTML += `<div class="reminder-cooldown">
        â³ æ‰“å¡å†·å»ä¸­ï¼Œè«‹ç­‰å¾… <span class="cooldown-timer">${formatCooldownTime(remainingSeconds)}</span>
      </div>`;
    }
    
    if (!holiday && now.getDay() !== 0 && now.getDay() !== 6 && !todayBiz) {
      const hhmm = now.getHours() * 100 + now.getMinutes();
      if (hhmm >= 910 && todayInCount === 0) {
        statusHTML += `<div style="color:#dc2626;margin:8px 0;padding:8px;background:#fee2e2;border-radius:6px;">
          âš ï¸ <strong>é²åˆ°æé†’</strong><br>
          ğŸ”´ ç›®å‰æ™‚é–“ ${formatTimeOnly(now)}ï¼Œæ‚¨å°šæœªæ‰“å¡ä¸Šç­ï¼Œè«‹é€Ÿæ‰“å¡ï¼
        </div>`;
      }
    }
    
    if (todayRecords.length > 0) {
      statusHTML += `<div class="status-record" style="margin-top:12px;">
        <div class="status-title">ğŸ“‹ ä»Šæ—¥æ‰“å¡æ˜ç´°ï¼ˆ${todayRecords.length}ç­†ï¼‰</div>`;
      
      todayRecords.sort((a, b) => a.fullTime.localeCompare(b.fullTime)).forEach((record, index) => {
        const actionClass = record.action === "ä¸Šç­" ? "action-in" : "action-out";
        const actionEmoji = record.action === "ä¸Šç­" ? "ğŸ¢" : "ğŸ ";
        
        let displayDistance = "è·é›¢æœªçŸ¥";
        let distanceClass = "";
        
        if (record.distance !== null && !isNaN(record.distance)) {
          displayDistance = formatDistance(record.distance);
          distanceClass = getDistanceClass(record.distance);
        } else if (record.lat && record.lng) {
          const distance = distanceMeter(COMPANY_LAT, COMPANY_LNG, record.lat, record.lng);
          displayDistance = formatDistance(distance);
          distanceClass = getDistanceClass(distance);
        }
        
        statusHTML += `<div class="record-detail">
          <div class="record-info">
            <span class="record-number">${index + 1}.</span>
            <div class="record-time-distance">
              <span class="record-time">${record.time}</span>
              <div class="record-distance">
                <span>ğŸ“ é›¢å…¬å¸</span>
                <span class="distance-badge ${distanceClass}">${displayDistance}</span>
              </div>
            </div>
          </div>
          <span class="record-action ${actionClass}">
            ${actionEmoji} ${record.action}
          </span>
        </div>`;
      });
      
      statusHTML += `</div>`;
    }
    
    statusBox.innerHTML = statusHTML;
    
    await loadComments();
    
  } catch (error) {
    console.error("è¼‰å…¥ç‹€æ…‹å¤±æ•—:", error);
    statusBox.innerHTML = `<div style="color:#dc2626;padding:10px;background:#fee2e2;border-radius:8px;">
      âŒ è¼‰å…¥ç‹€æ…‹å¤±æ•—<br>
      éŒ¯èª¤ï¼š${error.message}<br>
      æ™‚é–“ï¼š${formatTaiwanDateTime(getTaiwanDate())}
    </div>`;
    log(`âŒ è¼‰å…¥ç‹€æ…‹å¤±æ•—: ${error.message}`);
    
    commentSection.innerHTML = `
      <div class="comment-error">
        âŒ ç„¡æ³•è¼‰å…¥ä¸»ç®¡è¨»è§£<br>
        <small>ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦</small>
      </div>
    `;
  }
}

loadStatus();

/* ===== è‡ªå‹•æ›´æ–°å†·å»ç‹€æ…‹ ===== */
setInterval(() => {
  if (isInCooldown()) {
    loadStatus();
  }
}, 1000);

/* ===== æ‰“å¡ï¼ˆæœ‰é™åˆ¶ï¼‰===== */
function punch(action) {
  if (isInCooldown()) {
    const remainingSeconds = getCooldownRemaining();
    alert(`â³ è«‹ç­‰å¾… ${formatCooldownTime(remainingSeconds)} å¾Œå†æ‰“å¡`);
    return;
  }
  
  const count = action === "ä¸Šç­" ? todayInCount : todayOutCount;
  if (count >= MAX_PUNCH_PER_ACTION) {
    alert(`âŒ ${action} å·²é”ä»Šæ—¥ä¸Šé™ï¼ˆ${MAX_PUNCH_PER_ACTION}æ¬¡ï¼‰`);
    return;
  }
  
  if (action === "ä¸‹ç­" && todayInCount === 0) {
    alert("âŒ è«‹å…ˆæ‰“å¡ä¸Šç­å¾Œå†æ‰“å¡ä¸‹ç­");
    return;
  }
  
  if (count === 1) {
    if (!confirm(`âš ï¸ æ‚¨ä»Šå¤©å·²ç¶“æ‰“éä¸€æ¬¡ã€Œ${action}ã€\næ˜¯å¦ç¢ºå®šè¦é€²è¡Œç¬¬äºŒæ¬¡ä¿®æ­£æ‰“å¡ï¼Ÿ`)) {
      return;
    }
  }

  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const dist = distanceMeter(COMPANY_LAT, COMPANY_LNG, lat, lng);

    const currentTime = formatTaiwanDateTime(getTaiwanDate());
    log(`ğŸ“¤ é€å‡º ${action} æ‰“å¡ï¼ˆç¬¬ ${count + 1} æ¬¡ï¼‰â€¦`);

    try {
      const response = await fetch(API_PUNCH, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, action, lat, lng })
      });

      if (response.ok) {
        setCooldown();
        
        const distanceClass = getDistanceClass(dist);
        const formattedDist = formatDistance(dist);
        log(`âœ… ${action} æˆåŠŸï½œè·å…¬å¸ <span class="distance-badge ${distanceClass}">${formattedDist}</span>ï½œæ™‚é–“ï¼š${currentTime}`);
        
        loadStatus();
        loadComments();
      } else {
        log(`âŒ ${action} å¤±æ•—ï½œæ™‚é–“ï¼š${currentTime}`);
      }
    } catch (error) {
      log(`âŒ ç¶²è·¯éŒ¯èª¤ï¼š${error.message}ï½œæ™‚é–“ï¼š${currentTime}`);
    }

  }, () => {
    const errorTime = formatTaiwanDateTime(getTaiwanDate());
    alert(`âŒ ${errorTime} ç„¡æ³•å–å¾— GPS å®šä½ï¼Œè«‹ç¢ºèªå®šä½æ¬Šé™`);
  });
}

/* ===== PWA å®‰è£ ===== */
let deferredPrompt;
const btnInstall = document.getElementById("btnInstall");
window.addEventListener("beforeinstallprompt", e => {
  e.preventDefault();
  deferredPrompt = e;
  btnInstall.style.display = "block";
});
btnInstall.addEventListener("click", async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  if (outcome === "accepted") log("â¬‡ å·²é–‹å§‹å®‰è£ App");
  deferredPrompt = null;
});

/* ===== Service Worker ===== */
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js");
}

/* ===== ç•¶æœˆæ¯æ—¥æ‰“å¡ç´€éŒ„ ===== */
let monthlyVisible = false;

function toggleMonthly() {
  const box = document.getElementById("monthlyBox");
  monthlyVisible = !monthlyVisible;
  box.style.display = monthlyVisible ? "block" : "none";
  if (monthlyVisible) loadMonthly();
}

async function loadMonthly() {
  const box = document.getElementById("monthlyBox");
  const loadingTime = formatTaiwanDateTime(getTaiwanDate());
  box.innerHTML = `â³ è®€å–ç•¶æœˆæ‰“å¡ç´€éŒ„ä¸­â€¦<br><small>${loadingTime}</small>`;

  try {
    const data = await (await fetch(API_REC)).json();

    const taiwanNow = getTaiwanDate();
    const currentYear = taiwanNow.getFullYear();
    const currentMonth = String(taiwanNow.getMonth() + 1).padStart(2, '0');
    const currentYM = `${currentYear}-${currentMonth}`;

    const records = data.filter(r => {
      if (!r.created_at_tw || r.name !== name) return false;
      
      const recordDateStr = r.created_at_tw.split(' ')[0];
      return recordDateStr.startsWith(currentYM);
    });

    const byDate = {};
    records.forEach(r => {
      const recordDateStr = r.created_at_tw.split(' ')[0];
      if (!byDate[recordDateStr]) byDate[recordDateStr] = [];
      byDate[recordDateStr].push(r);
    });

    let html = `<div style="margin-bottom:10px;">
      <strong>ğŸ“† ${currentYM} æ¯æœˆæ‰“å¡ç´€éŒ„</strong><br>
      <small>æ›´æ–°æ™‚é–“ï¼š${formatTaiwanDateTime(getTaiwanDate())}</small>
      <hr style="border:none;border-top:1px dashed #4b5563;margin:8px 0;">
    </div>`;

    const dates = Object.keys(byDate).sort().reverse();
    
    if (dates.length === 0) {
      html += `<div style="text-align:center;padding:20px;color:#6b7280;">
        ğŸ“­ æœ¬æœˆå°šç„¡ä»»ä½•æ‰“å¡ç´€éŒ„
      </div>`;
    } else {
      dates.forEach(date => {
        const dObj = new Date(date + 'T00:00:00+08:00');
        const week = map[dObj.getDay()];
        const dayType = dObj.getDay() === 0 || dObj.getDay() === 6 ? "é€±æœ«" : "å·¥ä½œæ—¥";
        const dayClass = dObj.getDay() === 0 || dObj.getDay() === 6 ? "color:#ef4444" : "color:#059669";

        html += `<div class="monthly-record">
          <div class="record-date">
            <span>ğŸ“… ${date}ï¼ˆé€±${week}ï¼‰</span>
            <span style="font-size:11px;${dayClass}">${dayType}</span>
          </div>
          <div class="record-items">`;
        
        byDate[date].sort((a, b) => a.created_at_tw.localeCompare(b.created_at_tw)).forEach((r, index) => {
          const timePart = r.created_at_tw.split(' ')[1] || "";
          const actionClass = r.action === "ä¸Šç­" ? "action-in" : "action-out";
          const actionEmoji = r.action === "ä¸Šç­" ? "ğŸ¢" : "ğŸ ";
          
          let distanceInfo = "";
          if (r.lat && r.lng) {
            const distance = distanceMeter(COMPANY_LAT, COMPANY_LNG, r.lat, r.lng);
            const distanceClass = getDistanceClass(distance);
            const formattedDist = formatDistance(distance);
            distanceInfo = `<span class="distance-badge ${distanceClass}" style="margin-left: 4px;">${formattedDist}</span>`;
          }
          
          html += `<div class="record-item">
            <span>
              <span class="record-time">${timePart}</span>
              ${distanceInfo}
            </span>
            <span class="record-action ${actionClass}">${actionEmoji} ${r.action}</span>
          </div>`;
        });
        
        const dayInCount = byDate[date].filter(r => r.action === "ä¸Šç­").length;
        const dayOutCount = byDate[date].filter(r => r.action === "ä¸‹ç­").length;
        
        html += `<div class="record-item" style="margin-top:4px;padding-top:4px;border-top:1px solid #e5e7eb;">
          <span style="color:#6b7280;font-size:11px;">ç•¶æ—¥çµ±è¨ˆï¼š</span>
          <span style="font-size:11px;font-weight:600;">
            ä¸Šç­ ${dayInCount} æ¬¡ / ä¸‹ç­ ${dayOutCount} æ¬¡
          </span>
        </div>`;
        
        html += `</div></div>`;
      });
      
      const totalIn = records.filter(r => r.action === "ä¸Šç­").length;
      const totalOut = records.filter(r => r.action === "ä¸‹ç­").length;
      const totalRecords = records.length;
      
      html += `<div style="margin-top:15px;padding:10px;background:#1e293b;color:#f8fafc;border-radius:8px;">
        <strong>ğŸ“ˆ æœ¬æœˆçµ±è¨ˆ</strong><br>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px;">
          <div style="text-align:center;">
            <div style="font-size:24px;font-weight:bold;color:#22c55e">${totalIn}</div>
            <div style="font-size:11px;">ä¸Šç­æ¬¡æ•¸</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:24px;font-weight:bold;color:#3b82f6">${totalOut}</div>
            <div style="font-size:11px;">ä¸‹ç­æ¬¡æ•¸</div>
          </div>
        </div>
        <div style="text-align:center;margin-top:8px;font-size:12px;">
          ç¸½æ‰“å¡ï¼š${totalRecords} æ¬¡ï½œæœ‰ç´€éŒ„å¤©æ•¸ï¼š${dates.length} å¤©
        </div>
      </div>`;
    }

    box.innerHTML = html;
  } catch (error) {
    const errorTime = formatTaiwanDateTime(getTaiwanDate());
    box.innerHTML = `<div style="color:#dc2626;">
      âŒ è®€å–ç´€éŒ„å¤±æ•—<br>
      éŒ¯èª¤ï¼š${error.message}<br>
      æ™‚é–“ï¼š${errorTime}
    </div>`;
  }
}

// åŠ å…¥ CSS å‹•ç•«
const style = document.createElement('style');
style.textContent = `
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
`;
document.head.appendChild(style);

// æ¯5åˆ†é˜è‡ªå‹•æ›´æ–°è¨»è§£
setInterval(loadComments, 5 * 60 * 1000);
</script>
</body>
</html>