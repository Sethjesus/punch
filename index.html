<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UDM ESGï½œä¸Šç­æ‰“å¡ç³»çµ±</title>

<!-- ===== PWA ===== -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#1e293b">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root{
  --bg:#0f172a;
  --card:#f8fafc;
  --primary:#2563eb;
  --success:#16a34a;
  --muted:#64748b;
}
body{
  margin:0;
  background:linear-gradient(180deg,#0f172a,#020617);
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
}
header{
  background:linear-gradient(90deg,#020617,#1e293b);
  color:#fff;
  padding:16px;
  text-align:center;
}
header h1{margin:0;font-size:20px}
header div{font-size:12px;opacity:.85}

.container{
  max-width:420px;
  margin:20px auto;
  background:var(--card);
  border-radius:18px;
  padding:18px;
  box-shadow:0 20px 40px rgba(0,0,0,.35);
}

.today{text-align:center;margin-bottom:10px}
.today .date{font-size:16px;font-weight:700}
.today .week{font-size:13px;color:var(--muted)}

.nameBox{
  margin-top:6px;
  font-size:14px;
  display:flex;
  justify-content:center;
  gap:6px;
}
.editName{
  border:0;
  background:#e5e7eb;
  border-radius:6px;
  padding:2px 6px;
  cursor:pointer;
  font-size:12px;
}

.status{
  background:#eef2ff;
  padding:12px;
  border-radius:14px;
  margin-bottom:14px;
  font-size:14px;
}

/* ===== æé†’é¡è‰² ===== */
.notice-yellow{color:#b45309;font-weight:800}
.notice-red{color:#dc2626;font-weight:900}

.actions{display:flex;gap:10px;margin-bottom:14px}
button{
  flex:1;
  padding:14px;
  border-radius:14px;
  border:0;
  font-size:15px;
  font-weight:700;
  cursor:pointer;
}
button:disabled{opacity:.4}
.btn-in{background:#16a34a;color:#fff}
.btn-out{background:#2563eb;color:#fff}

.sub{display:flex;gap:10px;flex-wrap:wrap}
.sub button{
  padding:10px;
  font-size:13px;
  background:#334155;
  color:#fff;
}

#btnInstall{
  background:#f59e0b;
  color:#111827;
  font-weight:800;
  display:none;
}

.log{
  margin-top:12px;
  background:#020617;
  color:#22c55e;
  font-size:12px;
  padding:10px;
  border-radius:12px;
  height:140px;
  overflow:auto;
}
</style>
</head>

<body>

<header>
  <h1>UDM ESG</h1>
  <div>ä¸Šç­æ‰“å¡ç³»çµ±</div>
</header>

<div class="container">

  <div class="today">
    <div class="date" id="todayDate"></div>
    <div class="week" id="todayWeek"></div>
    <div class="nameBox">
      ğŸ‘¤ <span id="userName"></span>
      <button class="editName" onclick="editName()">âœï¸</button>
    </div>
  </div>

  <div class="status" id="statusBox">è®€å–ä»Šæ—¥ç‹€æ…‹ä¸­â€¦</div>

  <div class="actions">
    <button id="btnIn" class="btn-in" onclick="punch('ä¸Šç­')">ä¸Šç­æ‰“å¡</button>
    <button id="btnOut" class="btn-out" onclick="punch('ä¸‹ç­')">ä¸‹ç­æ‰“å¡</button>
  </div>

  <div class="sub">
    <button onclick="location.href='Leave.html'">ğŸ“ è«‹å‡ / å‡ºå·® / åŠ ç­</button>
    <button onclick="location.href='HR.html'">ğŸ“Š HR ç¸½è¦½</button>
    <button id="btnInstall">â¬‡ ä¸‹è¼‰ App</button>
  </div>

  <div class="log" id="log"></div>
</div>

<script>
/* ===== API ===== */
const API_PUNCH="https://punch-api.jackey1688.workers.dev/api/punch";
const API_REC="https://punch-api.jackey1688.workers.dev/api/records";

/* ===== è¨­å®š ===== */
const MAX_PUNCH_PER_DAY=2;

/* ===== åœ‹å®šå‡æ—¥ ===== */
const HOLIDAYS=[
 {start:"2026-02-14",end:"2026-02-22",name:"è¾²æ›†æ˜¥ç¯€"},
 {start:"2026-02-27",end:"2026-03-01",name:"228é€£å‡"},
 {start:"2026-04-03",end:"2026-04-06",name:"æ¸…æ˜é€£å‡"}
];

/* ===== DOM ===== */
const logBox=log;
const statusBox=document.getElementById("statusBox");
const btnIn=document.getElementById("btnIn");
const btnOut=document.getElementById("btnOut");

/* ===== ä½¿ç”¨è€… ===== */
let name=localStorage.getItem("name");
if(!name){
  name=prompt("è«‹è¼¸å…¥å§“å");
  localStorage.setItem("name",name);
}
userName.innerText=name;

function editName(){
  const n=prompt("è«‹è¼¸å…¥æ–°çš„å§“å",name);
  if(!n) return;
  name=n.trim();
  localStorage.setItem("name",name);
  userName.innerText=name;
  loadStatus();
}

/* ===== ä»Šæ—¥ ===== */
const now=new Date();
const today=now.toISOString().slice(0,10);
const map=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
todayDate.innerText=today;
todayWeek.innerText="é€±"+map[now.getDay()];

/* ===== å·¥å…· ===== */
function log(t){
  logBox.innerHTML+=t+"<br>";
  logBox.scrollTop=logBox.scrollHeight;
}

/* ===== ç‹€æ…‹ ===== */
let todayInCount=0;
let todayOutCount=0;

async function loadStatus(){
  const data=await(await fetch(API_REC)).json();
  todayInCount=0;
  todayOutCount=0;
  let inTime="",outTime="";

  data.forEach(r=>{
    if(r.name===name&&r.created_at_tw?.startsWith(today)){
      if(r.action==="ä¸Šç­"){todayInCount++; inTime=r.created_at_tw.slice(11,19);}
      if(r.action==="ä¸‹ç­"){todayOutCount++; outTime=r.created_at_tw.slice(11,19);}
    }
  });

  btnIn.disabled=todayInCount>=MAX_PUNCH_PER_DAY;
  btnOut.disabled=todayInCount===0||todayOutCount>=MAX_PUNCH_PER_DAY;

  let notice="";
  let holiday="";
  for(const h of HOLIDAYS){
    if(today>=h.start&&today<=h.end){holiday=h.name;break;}
  }

  const hhmm=now.getHours()*100+now.getMinutes();

  if(holiday){
    notice=`ğŸŒ ä»Šæ—¥ç‚º ${holiday}<br>`;
  }
  else if(now.getDay()===0||now.getDay()===6){
    notice=`ğŸ”´ ä»Šæ—¥ç‚ºé€±æœ«<br>`;
  }
  else if(todayInCount===0){
    if(hhmm>=910 && hhmm<930){
      notice=`<span class="notice-yellow">ğŸŸ¡ æ‚¨å°šæœªæ‰“å¡ï¼Œè«‹å„˜é€Ÿå®Œæˆæ‰“å¡</span><br>`;
    }
    else if(hhmm>=930){
      notice=`<span class="notice-red">ğŸ”´ æ‚¨å·²è¶…éä¸Šç­æ™‚é–“ï¼Œè«‹ç«‹å³æ‰“å¡</span><br>`;
    }
  }

  statusBox.innerHTML=
    notice+
    `ğŸŸ¢ ä¸Šç­ï¼š${todayInCount?inTime:"å°šæœª"}ï¼ˆ${todayInCount}/2ï¼‰<br>
     ğŸ”µ ä¸‹ç­ï¼š${todayOutCount?outTime:"â€”"}ï¼ˆ${todayOutCount}/2ï¼‰`;
}
loadStatus();

/* ===== æ‰“å¡ ===== */
function punch(action){
  const count=action==="ä¸Šç­"?todayInCount:todayOutCount;
  if(count>=MAX_PUNCH_PER_DAY){
    alert(`âŒ ${action} å·²è¶…éä»Šæ—¥æ¬¡æ•¸`);
    return;
  }
  if(count===1&&!confirm(`âš ï¸ ä»Šæ—¥å·²æ‰“éä¸€æ¬¡ ${action}ï¼Œæ˜¯å¦ä¿®æ­£ï¼Ÿ`)) return;

  navigator.geolocation.getCurrentPosition(async pos=>{
    await fetch(API_PUNCH,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({name,action,lat:pos.coords.latitude,lng:pos.coords.longitude})
    });
    log(`âœ… ${action} æˆåŠŸ`);
    loadStatus();
  },()=>alert("âŒ ç„¡æ³•å–å¾— GPS"));
}

/* ===== PWA å®‰è£ ===== */
let deferredPrompt;
const btnInstall=document.getElementById("btnInstall");
window.addEventListener("beforeinstallprompt",e=>{
  e.preventDefault();
  deferredPrompt=e;
  btnInstall.style.display="block";
});
btnInstall.onclick=async()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
};

/* ===== Service Worker ===== */
if("serviceWorker"in navigator){
  navigator.serviceWorker.register("./sw.js");
}
</script>

</body>
</html>
