<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UDM ESGï½œä¸Šç­æ‰“å¡ç³»çµ±</title>

<!-- ===== PWA ===== -->
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#1e293b">
<link rel="apple-touch-icon" href="./icon-192.png">

<style>
:root{
  --bg:#0f172a;
  --card:#f8fafc;
  --primary:#2563eb;
  --success:#16a34a;
  --muted:#64748b;
}
body{
  margin:0;
  background:linear-gradient(180deg,#0f172a,#020617);
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
}
header{
  background:linear-gradient(90deg,#020617,#1e293b);
  color:#fff;
  padding:16px;
  text-align:center;
}
header h1{margin:0;font-size:20px}
header div{font-size:12px;opacity:.85}

.container{
  max-width:420px;
  margin:20px auto;
  background:var(--card);
  border-radius:18px;
  padding:18px;
  box-shadow:0 20px 40px rgba(0,0,0,.35);
}

.today{text-align:center;margin-bottom:10px}
.today .date{font-size:16px;font-weight:700}
.today .week{font-size:13px;color:var(--muted)}

.nameBox{
  margin-top:6px;
  font-size:14px;
  display:flex;
  justify-content:center;
  gap:6px;
}
.editName{
  border:0;
  background:#e5e7eb;
  border-radius:6px;
  padding:2px 6px;
  cursor:pointer;
  font-size:12px;
}

.status{
  background:#eef2ff;
  padding:12px;
  border-radius:14px;
  margin-bottom:14px;
  font-size:14px;
}

/* ===== è·‘é¦¬ç‡ˆ ===== */
.marquee{
  color:#fff;
  padding:10px;
  border-radius:12px;
  font-weight:800;
  overflow:hidden;
  white-space:nowrap;
  margin-bottom:8px;
}
.marquee span{
  display:inline-block;
  padding-left:100%;
  animation:scroll 12s linear infinite;
}
@keyframes scroll{
  from{transform:translateX(0)}
  to{transform:translateX(-100%)}
}
.marquee.info  { background:#2563eb; }
.marquee.warn  { background:#dc2626; }
.marquee.leave { background:#f59e0b; }
.marquee.ok    { background:#16a34a; }

.actions{display:flex;gap:10px;margin-bottom:14px}
button{
  flex:1;
  padding:14px;
  border-radius:14px;
  border:0;
  font-size:15px;
  font-weight:700;
  cursor:pointer;
}
button:disabled{opacity:.4}
.btn-in{background:var(--success);color:#fff}
.btn-out{background:var(--primary);color:#fff}

.sub{display:flex;gap:10px;flex-wrap:wrap}
.sub button{
  padding:10px;
  font-size:13px;
  background:#334155;
  color:#fff;
}

#installBtn{
  display:none;
  background:#16a34a;
  color:#fff;
}

.log{
  margin-top:12px;
  background:#020617;
  color:#22c55e;
  font-size:12px;
  padding:10px;
  border-radius:12px;
  height:140px;
  overflow:auto;
}
</style>
</head>

<body>

<header>
  <h1>UDM ESG</h1>
  <div>ä¸Šç­æ‰“å¡ç³»çµ±</div>
</header>

<div class="container">

  <div class="today">
    <div class="date" id="todayDate"></div>
    <div class="week" id="todayWeek"></div>
    <div class="nameBox">
      ğŸ‘¤ <span id="userName"></span>
      <button class="editName" onclick="editName()">âœï¸</button>
    </div>
  </div>

  <div class="status" id="statusBox">è®€å–ä¸­â€¦</div>

  <div class="actions">
    <button id="btnIn" class="btn-in" onclick="punch('ä¸Šç­')">ä¸Šç­æ‰“å¡</button>
    <button id="btnOut" class="btn-out" onclick="punch('ä¸‹ç­')">ä¸‹ç­æ‰“å¡</button>
  </div>

  <div class="sub">
    <button onclick="location.href='Leave.html'">ğŸ“ è«‹å‡ / å‡ºå·® / åŠ ç­</button>
    <button onclick="location.href='HR.html'">ğŸ“Š HR ç¸½è¦½</button>
    <button onclick="showMonthlyLog()">ğŸ“… æœ¬æœˆæ‰“å¡ç´€éŒ„</button>
    <button id="installBtn">ğŸ“² ä¸‹è¼‰ App</button>
  </div>

  <div class="log" id="log"></div>
</div>

<script>
/* ===== API ===== */
const API_PUNCH = "https://punch-api.jackey1688.workers.dev/api/punch";
const API_REC   = "https://punch-api.jackey1688.workers.dev/api/records";
const API_LEAVE = "https://punch-api.jackey1688.workers.dev/api/leave";

/* ===== HR è¦å‰‡è¨­å®š ===== */
const RULE = {
  WORK_START: 910,  // 09:10
  LATE_MIN: 10,    // é²åˆ°åˆ†é˜
  WORK_END: 1800   // 18:00
};

/* ===== ä½¿ç”¨è€… ===== */
let name = localStorage.getItem("name");
if(!name){
  name = prompt("è«‹è¼¸å…¥å§“å");
  localStorage.setItem("name", name);
}
userName.innerText = name;

function editName(){
  const n = prompt("æ–°å§“å", name);
  if(!n) return;
  name = n.trim();
  localStorage.setItem("name", name);
  userName.innerText = name;
  loadStatus();
}

/* ===== æ—¥æœŸ ===== */
function renderToday(){
  const d = new Date();
  const w = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
  todayDate.innerText = d.toISOString().slice(0,10);
  todayWeek.innerText = `æ˜ŸæœŸ${w[d.getDay()]}`;
}

/* ===== è·‘é¦¬ç‡ˆåˆ¤æ–· ===== */
let leaveCache = [];

function isOnLeave(today){
  return leaveCache.some(l =>
    l.name === name &&
    today >= l.start_date &&
    today <= l.end_date &&
    l.withdrawn !== 1
  );
}

function buildMarquee({ now, today, inC, outC }) {
  const hm = now.getHours()*100 + now.getMinutes();

  if (isOnLeave(today)) {
    return `<div class="marquee leave"><span>ğŸŸ¡ ä»Šæ—¥è«‹å‡ä¸­ï¼Œç„¡éœ€æ‰“å¡</span></div>`;
  }

  if (hm >= RULE.WORK_START && inC === 0 && now.getDay()>=1 && now.getDay()<=5) {
    const late = hm - RULE.WORK_START;
    if (late > RULE.LATE_MIN) {
      return `<div class="marquee warn"><span>ğŸ”´ å·²é²åˆ° ${late} åˆ†é˜ï¼Œè«‹ç«‹å³æ‰“å¡</span></div>`;
    }
    return `<div class="marquee info"><span>ğŸ”µ å°šæœªå®Œæˆä¸Šç­æ‰“å¡ï¼Œè«‹å„˜é€Ÿæ‰“å¡</span></div>`;
  }

  if (inC > 0 && outC === 0 && hm >= RULE.WORK_END) {
    return `<div class="marquee info"><span>ğŸ”µ å°šæœªä¸‹ç­æ‰“å¡ï¼Œè«‹è¨˜å¾—å®Œæˆ</span></div>`;
  }

  if (inC > 0 && outC > 0) {
    return `<div class="marquee ok"><span>ğŸŸ¢ ä»Šæ—¥æ‰“å¡å®Œæˆï¼Œè¾›è‹¦äº†</span></div>`;
  }

  return "";
}

/* ===== ç‹€æ…‹ ===== */
const logBox = log;
function logMsg(t){
  logBox.innerHTML += t + "<br>";
  logBox.scrollTop = logBox.scrollHeight;
}

async function loadStatus(){
  const now = new Date();
  const today = now.toISOString().slice(0,10);

  const rec = await (await fetch(API_REC)).json();
  leaveCache = await (await fetch(API_LEAVE)).json();

  let inC=0,outC=0,inT="",outT="";
  rec.forEach(r=>{
    if(r.name===name && r.created_at_tw?.startsWith(today)){
      if(r.action==="ä¸Šç­"){inC++;inT=r.created_at_tw.slice(11,19)}
      if(r.action==="ä¸‹ç­"){outC++;outT=r.created_at_tw.slice(11,19)}
    }
  });

  btnIn.disabled = inC>=2;
  btnOut.disabled = inC===0||outC>=2;

  const marquee = buildMarquee({ now, today, inC, outC });

  statusBox.innerHTML = marquee + `
    ğŸŸ¢ ä¸Šç­ï¼š${inC?inT:"å°šæœª"}ï¼ˆ${inC}/2ï¼‰<br>
    ğŸ”µ ä¸‹ç­ï¼š${outC?outT:"â€”"}ï¼ˆ${outC}/2ï¼‰
  `;
}

/* ===== æ‰“å¡ ===== */
function punch(action){
  navigator.geolocation.getCurrentPosition(async pos=>{
    await fetch(API_PUNCH,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({name,action,lat:pos.coords.latitude,lng:pos.coords.longitude})
    });
    logMsg(`âœ… ${action} æˆåŠŸ`);
    loadStatus();
  },()=>alert("âŒ GPS å¤±æ•—"));
}

/* ===== æœˆç´€éŒ„ ===== */
async function showMonthlyLog(){
  logBox.innerHTML="";
  const ym=new Date().toISOString().slice(0,7);
  const data=await (await fetch(API_REC)).json();
  data.filter(r=>r.name===name&&r.created_at_tw?.startsWith(ym))
      .forEach(r=>logMsg(`ğŸ•’ ${r.created_at_tw}ï½œ${r.action}`));
}

/* ===== PWA å®‰è£ ===== */
let deferredPrompt=null;
window.addEventListener("beforeinstallprompt",e=>{
  e.preventDefault();
  deferredPrompt=e;
  installBtn.style.display="block";
});
installBtn.onclick=async()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt=null;
  installBtn.style.display="none";
};
window.addEventListener("appinstalled",()=>installBtn.style.display="none");

/* ===== Service Worker ===== */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js");
}

/* ===== å•Ÿå‹• ===== */
renderToday();
loadStatus();
</script>

</body>
</html>
