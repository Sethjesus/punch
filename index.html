<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>員工打卡</title>
<style>
body { font-family: Arial; background:#f5f5f5; }
.card {
  max-width:420px; margin:60px auto; background:#fff;
  padding:24px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.1);
}
input, select, button {
  width:100%; padding:12px; margin-top:12px; font-size:16px;
}
button { background:#4f7df3; color:#fff; border:0; border-radius:8px; }
#msg { margin-top:12px; }
</style>
</head>
<body>

<div class="card">
  <h2 style="text-align:center">員工打卡</h2>

  <input id="name" placeholder="姓名">
  <select id="action">
    <option value="上班">上班</option>
    <option value="下班">下班</option>
  </select>

  <div id="gps">GPS 取得中…</div>

  <button onclick="punch()">打卡</button>
  <div id="msg"></div>
</div>

<script>
const API = "https://punch-api.jackey1688.workers.dev/api/punch";
const COMPANY_LAT = 25.00654;
const COMPANY_LNG = 121.48416;

let lat = null, lng = null;

navigator.geolocation.getCurrentPosition(
  p => {
    lat = p.coords.latitude;
    lng = p.coords.longitude;
    document.getElementById("gps").innerText =
      `GPS OK : ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  },
  () => document.getElementById("gps").innerText = "❌ GPS 失敗"
);

function distance(lat1,lng1,lat2,lng2){
  const R=6371000;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLng=(lng2-lng1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
    Math.sin(dLng/2)**2;
  return Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)));
}

async function punch(){
  const name = nameInput.value.trim();
  if(!name) return alert("請輸入姓名");

  const d = lat ? distance(lat,lng,COMPANY_LAT,COMPANY_LNG) : null;

  const res = await fetch(API,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      name,
      action: action.value,
      lat,
      lng,
      distance: d,
      time: new Date().toISOString()
    })
  });

  msg.innerHTML = res.ok
    ? "✅ 打卡成功"
    : "❌ 打卡失敗";
}
</script>
</body>
</html>
