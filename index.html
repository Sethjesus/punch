<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UDM ESGï½œä¸Šç­æ‰“å¡ç³»çµ±</title>

<!-- PWA -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#1e293b">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root{
  --bg:#0f172a;
  --card:#f8fafc;
  --primary:#2563eb;
  --success:#16a34a;
  --muted:#64748b;
}

body{
  margin:0;
  background:linear-gradient(180deg,#0f172a,#020617);
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
}

header{
  background:linear-gradient(90deg,#020617,#1e293b);
  color:#fff;
  padding:16px;
  text-align:center;
}
header h1{margin:0;font-size:20px}
header div{font-size:12px;opacity:.85}

.container{
  max-width:420px;
  margin:20px auto;
  background:var(--card);
  border-radius:18px;
  padding:18px;
  box-shadow:0 20px 40px rgba(0,0,0,.35);
}

/* ä»Šæ—¥ */
.today{text-align:center;margin-bottom:10px}
.today .date{font-size:16px;font-weight:700}
.today .week{font-size:13px;color:var(--muted)}

/* å§“å */
.nameBox{
  margin-top:6px;
  font-size:14px;
  color:#334155;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
}
.editName{
  border:0;
  background:#e5e7eb;
  border-radius:6px;
  padding:2px 6px;
  cursor:pointer;
  font-size:12px;
}

/* ç‹€æ…‹ */
.status{
  background:#eef2ff;
  padding:12px;
  border-radius:14px;
  margin-bottom:14px;
  font-size:14px;
}

/* è·‘é¦¬ç‡ˆ */
.marquee{
  background:#dc2626;
  color:#fff;
  padding:10px;
  border-radius:12px;
  font-weight:800;
  overflow:hidden;
  white-space:nowrap;
  margin-bottom:8px;
}
.marquee span{
  display:inline-block;
  padding-left:100%;
  animation:scroll 12s linear infinite;
}
@keyframes scroll{
  from{transform:translateX(0)}
  to{transform:translateX(-100%)}
}

/* æ‰“å¡ */
.actions{display:flex;gap:10px;margin-bottom:14px}
button{
  flex:1;
  padding:14px;
  border-radius:14px;
  border:0;
  font-size:15px;
  font-weight:700;
  cursor:pointer;
}
button:disabled{opacity:.4;cursor:not-allowed}
.btn-in{background:var(--success);color:#fff}
.btn-out{background:var(--primary);color:#fff}

/* æ¬¡åŠŸèƒ½ */
.sub{display:flex;gap:10px;flex-wrap:wrap}
.sub button{
  padding:10px;
  font-size:13px;
  background:#334155;
  color:#fff;
}

/* Log */
.log{
  margin-top:12px;
  background:#020617;
  color:#22c55e;
  font-size:12px;
  padding:10px;
  border-radius:12px;
  height:140px;
  overflow:auto;
}
</style>
</head>

<body>

<header>
  <h1>UDM ESG</h1>
  <div>ä¸Šç­æ‰“å¡ç³»çµ±</div>
</header>

<div class="container">

  <div class="today">
    <div class="date" id="todayDate"></div>
    <div class="week" id="todayWeek"></div>

    <div class="nameBox">
      ğŸ‘¤ <span id="userName"></span>
      <button class="editName" onclick="editName()">âœï¸</button>
    </div>
  </div>

  <div class="status" id="statusBox">è®€å–ä»Šæ—¥ç‹€æ…‹ä¸­â€¦</div>

  <div class="actions">
    <button id="btnIn" class="btn-in" onclick="punch('ä¸Šç­')">ä¸Šç­æ‰“å¡</button>
    <button id="btnOut" class="btn-out" onclick="punch('ä¸‹ç­')">ä¸‹ç­æ‰“å¡</button>
  </div>

  <div class="sub">
    <button onclick="location.href='Leave.html'">ğŸ“ è«‹å‡ / å‡ºå·® / åŠ ç­</button>
    <button onclick="location.href='HR.html'">ğŸ“Š HR ç¸½è¦½</button>
    <button onclick="showMonthlyLog()">ğŸ“… æœ¬æœˆæ‰“å¡ç´€éŒ„</button>
  </div>

  <div class="log" id="log"></div>
</div>

<script>
/* ===== API ===== */
const API_PUNCH = "https://punch-api.jackey1688.workers.dev/api/punch";
const API_REC   = "https://punch-api.jackey1688.workers.dev/api/records";
const API_LEAVE = "https://punch-api.jackey1688.workers.dev/api/leave";

/* ===== ä½¿ç”¨è€… ===== */
let name = localStorage.getItem("name");
if(!name){
  name = prompt("è«‹è¼¸å…¥å§“å");
  localStorage.setItem("name", name);
}
document.getElementById("userName").innerText = name;

function editName(){
  const n = prompt("è«‹è¼¸å…¥æ–°çš„å§“å", name);
  if(!n) return;
  name = n.trim();
  localStorage.setItem("name", name);
  document.getElementById("userName").innerText = name;
  loadStatus();
}

/* ===== æ—¥æœŸ & æ˜ŸæœŸï¼ˆå°ç£æ™‚é–“ï¼‰ ===== */
function renderToday(){
  const now = new Date();
  const week = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth()+1).padStart(2,"0");
  const dd = String(now.getDate()).padStart(2,"0");

  document.getElementById("todayDate").innerText = `${yyyy}-${mm}-${dd}`;
  document.getElementById("todayWeek").innerText = `æ˜ŸæœŸ${week[now.getDay()]}`;
}

/* ===== ç‹€æ…‹ ===== */
const MAX_PUNCH_PER_DAY = 2;
let todayInCount = 0;
let todayOutCount = 0;
let leaveCache = [];

const logBox = document.getElementById("log");
const statusBox = document.getElementById("statusBox");
const btnIn = document.getElementById("btnIn");
const btnOut = document.getElementById("btnOut");

function log(t){
  logBox.innerHTML += t + "<br>";
  logBox.scrollTop = logBox.scrollHeight;
}

function isOnLeave(today){
  return leaveCache.some(l =>
    l.name === name &&
    today >= l.start_date &&
    today <= l.end_date &&
    l.withdrawn !== 1
  );
}

/* ===== è¼‰å…¥ç‹€æ…‹ ===== */
async function loadStatus(){
  const now = new Date();
  const today = now.toISOString().slice(0,10);

  const rec = await (await fetch(API_REC)).json();
  leaveCache = await (await fetch(API_LEAVE)).json();

  todayInCount = 0;
  todayOutCount = 0;
  let inTime="", outTime="";

  rec.forEach(r=>{
    if(r.name===name && r.created_at_tw?.startsWith(today)){
      if(r.action==="ä¸Šç­"){todayInCount++; inTime=r.created_at_tw.slice(11,19);}
      if(r.action==="ä¸‹ç­"){todayOutCount++; outTime=r.created_at_tw.slice(11,19);}
    }
  });

  btnIn.disabled = todayInCount >= MAX_PUNCH_PER_DAY;
  btnOut.disabled = todayInCount===0 || todayOutCount>=MAX_PUNCH_PER_DAY;

  let html = "";
  if(now.getHours()*100 + now.getMinutes() >= 910 &&
     todayInCount===0 &&
     now.getDay()!==0 &&
     now.getDay()!==6 &&
     !isOnLeave(today)){
    html += `<div class="marquee"><span>âš ï¸ æœ¬æ—¥å°šæœªä¸Šç­æ‰“å¡ï¼Œè«‹å„˜é€Ÿå®Œæˆæ‰“å¡ä½œæ¥­ âš ï¸</span></div>`;
  }

  html += `
    ğŸŸ¢ ä¸Šç­ï¼š${todayInCount?inTime:"å°šæœª"}ï¼ˆ${todayInCount}/2ï¼‰<br>
    ğŸ”µ ä¸‹ç­ï¼š${todayOutCount?outTime:"â€”"}ï¼ˆ${todayOutCount}/2ï¼‰
  `;
  statusBox.innerHTML = html;
}

/* ===== æ‰“å¡ ===== */
function punch(action){
  navigator.geolocation.getCurrentPosition(async pos=>{
    await fetch(API_PUNCH,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        name, action,
        lat:pos.coords.latitude,
        lng:pos.coords.longitude
      })
    });
    log(`âœ… ${action} æˆåŠŸ`);
    loadStatus();
  },()=>alert("âŒ ç„¡æ³•å–å¾— GPS"));
}

/* ===== æœ¬æœˆç´€éŒ„ ===== */
async function showMonthlyLog(){
  logBox.innerHTML="ğŸ“… æœ¬æœˆæ‰“å¡ç´€éŒ„<br>---<br>";
  const data = await (await fetch(API_REC)).json();
  const ym = new Date().toISOString().slice(0,7);
  data.filter(r=>r.name===name && r.created_at_tw?.startsWith(ym))
      .forEach(r=>log(`ğŸ•’ ${r.created_at_tw}ï½œ${r.action}`));
}

/* ===== å•Ÿå‹• ===== */
renderToday();
loadStatus();
</script>

</body>
</html>
